<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoPanel HOLDER PRO - Sistema para Investidores de Longo Prazo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        dark: { 950: '#05070a', 900: '#0b0e14', 800: '#151a23', 700: '#232a3b', 600: '#374151' },
                        brand: { 500: '#3b82f6', 600: '#2563eb' },
                        score: { high: '#10b981', mid: '#f59e0b', low: '#ef4444' },
                        orange: { 400: '#fb923c', 500: '#f97316', 600: '#ea580c', 700: '#c2410c' },
                        holder: {
                            accumulation: '#22c55e',
                            holding: '#3b82f6', 
                            profit_taking: '#ef4444',
                            dca_zone: '#8b5cf6'
                        },
                        rsi: {
                            oversold: '#22c55e',
                            neutral: '#f59e0b',
                            overbought: '#ef4444'
                        },
                        zone: {
                            agressive: '#059669',
                            moderate: '#10b981',
                            fair: '#3b82f6',
                            partial: '#f59e0b',
                            full: '#ef4444'
                        }
                    },
                    animation: { 
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'pulse-accumulation': 'pulse 2s ease-in-out infinite'
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #05070a; color: #e5e7eb; overflow-x: hidden; padding-bottom: 400px; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0b0e14; }
        ::-webkit-scrollbar-thumb { background: #232a3b; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #3b82f6; }
        
        .glass { background: rgba(11, 14, 20, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .table-fixed-header thead { position: sticky; top: 0; z-index: 20; background-color: #0b0e14; }
        .table-row-hover:hover td { background-color: rgba(59, 130, 246, 0.08); }
        
        #metric-tooltip-overlay { 
            position: fixed; bottom: 0; left: 0; right: 0;
            height: auto; max-height: 70vh;
            background-color: #05070a;
            border-top: 1px solid rgba(59, 130, 246, 0.4);
            box-shadow: 0 -10px 60px rgba(0,0,0,0.95);
            z-index: 9999;
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex; flex-direction: column; gap: 1rem;
        }
        @media(min-width: 1024px) { #metric-tooltip-overlay { flex-direction: row; max-height: 40vh; } }

        .tooltip-hidden { transform: translateY(110%); opacity: 0; pointer-events: none; }
        .tooltip-visible { transform: translateY(0); opacity: 1; pointer-events: auto; }

        .tip-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #60a5fa; font-weight: 800; margin-bottom: 6px; border-bottom: 1px solid rgba(96, 165, 250, 0.2); display: inline-block; }
        .tip-val { font-size: 0.9rem; color: #d1d5db; line-height: 1.6; }
        .tip-val b { color: #fff; font-weight: 700; }
        
        .card-enter { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .pulse-green { animation: pulseG 0.8s; } .pulse-red { animation: pulseR 0.8s; }
        @keyframes pulseG { 0% { color: #10b981; text-shadow: 0 0 10px rgba(16,185,129,0.5); } 100% { color: inherit; } }
        @keyframes pulseR { 0% { color: #ef4444; text-shadow: 0 0 10px rgba(239,68,68,0.5); } 100% { color: inherit; } }
        .sparkline-path { stroke-dasharray: 1000; stroke-dashoffset: 1000; animation: drawSpark 2s ease-out forwards; }
        @keyframes drawSpark { to { stroke-dashoffset: 0; } }
        .modal-overlay { background-color: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
        
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .mobile-full { width: 100%; }
        .mobile-text-sm { font-size: 0.875rem; }
        .mobile-p-3 { padding: 0.75rem; }
        
        @media (max-width: 640px) {
            .card-grid { grid-template-columns: 1fr; gap: 1rem; }
            .card-section { padding: 0.75rem; }
            .card-section-grid { grid-template-columns: 1fr; gap: 0.5rem; }
            .mobile-collapsible { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
            .mobile-collapsible.expanded { max-height: 1000px; }
            .mobile-toggle { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
            .compact-table th, .compact-table td { padding: 0.25rem !important; font-size: 0.7rem; }
        }

        .compact-table th, .compact-table td { padding: 0.25rem 0.5rem !important; }
        
        .alert-panel { border-color: rgba(251, 146, 60, 0.5) !important; }
        .alert-header { background-color: rgba(251, 146, 60, 0.1) !important; border-color: rgba(251, 146, 60, 0.3) !important; }
        .alert-button { background-color: #f97316 !important; }
        .alert-button:hover { background-color: #ea580c !important; }
        
        .ranking-row-high { background-color: rgba(16, 185, 129, 0.1) !important; }
        .ranking-row-mid { background-color: rgba(59, 130, 246, 0.1) !important; }
        .ranking-row-low { background-color: rgba(239, 68, 68, 0.1) !important; }
        
        /* Novos estilos HOLDER */
        .holder-phase-accumulation { 
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%);
            border-left: 4px solid #22c55e;
        }
        
        .holder-phase-holding { 
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
            border-left: 4px solid #3b82f6;
        }
        
        .holder-phase-profit { 
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
            border-left: 4px solid #ef4444;
        }
        
        .dca-zone-indicator {
            background: rgba(139, 92, 246, 0.2);
            border: 1px dashed rgba(139, 92, 246, 0.5);
            animation: pulse-accumulation 2s infinite;
        }
        
        .historical-band {
            position: absolute;
            width: 100%;
            opacity: 0.1;
            z-index: 1;
        }
        
        .band-0-20 { background: #059669; height: 20%; bottom: 0; }
        .band-20-40 { background: #10b981; height: 20%; bottom: 20%; }
        .band-40-60 { background: #3b82f6; height: 20%; bottom: 40%; }
        .band-60-80 { background: #f59e0b; height: 20%; bottom: 60%; }
        .band-80-100 { background: #ef4444; height: 20%; bottom: 80%; }
        
        .rsi-indicator {
            width: 40px;
            height: 4px;
            border-radius: 2px;
            background: #374151;
            position: relative;
            overflow: hidden;
            margin: 2px auto;
        }
        
        .rsi-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        
        .rsi-oversold { background: #22c55e; }
        .rsi-neutral { background: #f59e0b; }
        .rsi-overbought { background: #ef4444; }
        
        /* Box de Variação */
        .var-box {
            @apply flex flex-col items-center justify-center p-1 rounded bg-dark-800/50 backdrop-blur-sm border border-gray-800;
        }
        
        /* Zone indicators */
        .zone-indicator {
            height: 4px;
            border-radius: 2px;
            margin: 2px 0;
        }
        .zone-0-20 { background: #059669; }
        .zone-20-40 { background: #10b981; }
        .zone-40-60 { background: #3b82f6; }
        .zone-60-80 { background: #f59e0b; }
        .zone-80-100 { background: #ef4444; }
        
        /* Progress bars */
        .progress-bar {
            height: 6px;
            background: #374151;
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 3px;
        }
        
        /* Compact cards */
        .compact-card {
            @apply glass rounded-lg border border-gray-800 p-3 hover:border-gray-600 transition-all cursor-pointer;
        }
        
        /* Tooltip short */
        .tooltip-short {
            @apply absolute z-50 invisible inline-block px-2 py-1 text-xs font-medium text-white bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip;
        }
        .has-tooltip:hover .tooltip-short {
            @apply visible opacity-100;
        }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col font-sans selection:bg-brand-500 selection:text-white">

    <header class="glass sticky top-0 z-50 border-b border-gray-800 shadow-lg">
        <div class="max-w-[1800px] mx-auto px-2 sm:px-4 h-16 flex items-center justify-between flex-wrap sm:flex-nowrap gap-2 py-2 min-w-[320px]">
            <div class="flex items-center gap-2 sm:gap-4 w-full sm:w-auto justify-between sm:justify-start">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-br from-holder-accumulation to-holder-holding rounded-lg flex items-center justify-center shadow-lg shadow-green-500/20 cursor-help" data-tip="sys_logo">
                        <i class="fa-solid fa-chart-line text-white text-sm sm:text-lg"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-base sm:text-xl text-white tracking-tight">CryptoPanel<span class="text-holder-accumulation">HOLDER</span> <span class="text-[8px] sm:text-[10px] text-gray-500 border border-gray-700 rounded px-1 ml-1 align-top">v4.0 HOLDER PRO</span></h1>
                        <div class="flex items-center gap-1 sm:gap-2 text-[8px] sm:text-[10px] text-gray-400 font-mono mt-0 sm:mt-1">
                            <span class="hidden sm:inline">LONG TERM • ACCUMULATION • PATIENCE</span>
                            <span class="w-1 h-1 rounded-full bg-gray-600 hidden sm:inline"></span>
                            <span id="last-update" data-tip="sys_update">Conectando...</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-1 sm:hidden">
                    <button id="mobile-menu-toggle" class="p-2 bg-dark-800 border border-gray-700 rounded-lg">
                        <i class="fa-solid fa-bars text-white"></i>
                    </button>
                </div>
            </div>
            <div id="header-controls" class="hidden sm:flex items-center gap-2 sm:gap-3 w-full sm:w-auto justify-end mt-2 sm:mt-0">
                <input id="searchToken" type="text" placeholder="Buscar ativo..." class="bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:border-holder-accumulation outline-none w-full sm:w-40 mobile-full">
                <div class="hidden sm:flex flex-col items-end mr-2 cursor-help" data-tip="sys_auto_refresh">
                    <span class="text-[9px] text-gray-500 uppercase tracking-widest">Auto-Refresh</span>
                    <span id="countdown" class="text-xs font-mono font-bold text-holder-accumulation">720s</span>
                </div>
                <div class="flex gap-1 sm:gap-2">
                    <button onclick="App.Export.openModal()" class="p-2 bg-dark-800 hover:text-green-400 border border-gray-700 rounded-lg transition-all min-h-[40px] min-w-[40px] flex items-center justify-center" data-tip="sys_export"><i class="fa-solid fa-file-excel"></i></button>
                    <button id="refreshData" class="group p-2 bg-holder-accumulation hover:bg-green-500 rounded-lg text-white shadow-lg min-h-[40px] min-w-[40px] flex items-center justify-center" data-tip="sys_manual_refresh"><i class="fa-solid fa-rotate group-hover:rotate-180 transition-transform duration-500"></i></button>
                    <button id="openSettings" class="p-2 bg-dark-800 hover:text-yellow-400 border border-gray-700 rounded-lg transition-all min-h-[40px] min-w-[40px] flex items-center justify-center" data-tip="sys_settings"><i class="fa-solid fa-gear"></i></button>
                </div>
            </div>
        </div>
    </header>

    <div class="bg-dark-900 border-b border-gray-800 py-2 shadow-inner">
        <div class="max-w-[1800px] mx-auto px-2 sm:px-4 flex flex-col sm:flex-row gap-2 sm:gap-4 overflow-x-auto no-scrollbar items-start sm:items-center">
            <span class="font-bold text-gray-500 uppercase tracking-widest text-[9px] sm:text-[10px] shrink-0 flex items-center cursor-help" data-tip="holder_intro">Estratégia HOLDER:</span>
            <div class="flex flex-wrap gap-1 sm:gap-2 shrink-0 text-xs">
                <span class="px-2 py-1 bg-dark-800 border border-zone-agressive rounded cursor-help hover:bg-dark-700 transition-colors text-[10px] sm:text-xs" data-tip="zone_agressive"><span class="w-2 h-2 inline-block rounded-full bg-zone-agressive mr-1"></span>0-20%: Acum. Agressiva</span>
                <span class="px-2 py-1 bg-dark-800 border border-zone-moderate rounded cursor-help hover:bg-dark-700 transition-colors text-[10px] sm:text-xs" data-tip="zone_moderate"><span class="w-2 h-2 inline-block rounded-full bg-zone-moderate mr-1"></span>20-40%: Acum. Moderada</span>
                <span class="px-2 py-1 bg-dark-800 border border-zone-fair rounded cursor-help hover:bg-dark-700 transition-colors text-[10px] sm:text-xs" data-tip="zone_fair"><span class="w-2 h-2 inline-block rounded-full bg-zone-fair mr-1"></span>40-60%: Preço Justo</span>
                <span class="px-2 py-1 bg-dark-800 border border-zone-partial rounded cursor-help hover:bg-dark-700 transition-colors text-[10px] sm:text-xs" data-tip="zone_partial"><span class="w-2 h-2 inline-block rounded-full bg-zone-partial mr-1"></span>60-80%: Realização Parcial</span>
                <span class="px-2 py-1 bg-dark-800 border border-zone-full rounded cursor-help hover:bg-dark-700 transition-colors text-[10px] sm:text-xs" data-tip="zone_full"><span class="w-2 h-2 inline-block rounded-full bg-zone-full mr-1"></span>80-100%: Realização Total</span>
            </div>
        </div>
    </div>

    <main class="flex-1 max-w-[1800px] mx-auto px-2 sm:px-4 py-4 sm:py-6 w-full gap-4 sm:gap-8 flex flex-col">
        
        <section class="glass rounded-xl overflow-hidden border border-gray-800 flex flex-col shadow-xl">
            <div class="bg-dark-800/80 p-4 border-b border-gray-700 flex justify-between items-center shrink-0">
                <h3 class="text-white font-bold text-sm flex items-center gap-2" data-tip="opportunities_title"><i class="fa-solid fa-star text-yellow-500"></i> Top 10 Oportunidades HOLDER</h3>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] text-gray-500">Classificadas pelo Score HOLDER 2.0</span>
                </div>
            </div>
            <div class="overflow-y-auto flex-1 scrollbar-thin table-fixed-header table-responsive max-h-[50vh]">
                <table class="w-full text-left text-xs min-w-[800px] compact-table">
                    <thead class="text-gray-400 uppercase font-bold tracking-wider text-[10px] bg-dark-900">
                        <tr>
                            <th class="p-2 text-center">#</th>
                            <th class="p-2">Ativo</th>
                            <th class="p-2 text-center">Score HOLDER 2.0</th>
                            <th class="p-2 text-center">Fase</th>
                            <th class="p-2 text-center">Zona</th>
                            <th class="p-2 text-center">Preço Atual</th>
                            <th class="p-2 text-center">Assimetria</th>
                            <th class="p-2 text-center">Prob. Retorno (3 anos)</th>
                            <th class="p-2 text-center">Horizonte</th>
                            <th class="p-2 text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="opportunities-body" class="divide-y divide-gray-800 text-gray-300">
                        <tr><td colspan="10" class="p-8 text-center text-gray-600 italic animate-pulse">Calculando oportunidades...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6">
            <div class="glass rounded-xl overflow-hidden border border-zone-agressive flex flex-col shadow-lg">
                <div class="bg-dark-800/90 p-3 border-b border-zone-agressive flex justify-between items-center shrink-0">
                    <h3 class="text-zone-agressive font-bold text-xs uppercase tracking-wide flex items-center gap-2" data-tip="zone_agressive_title"><i class="fa-solid fa-layer-group"></i> Acumulação Agressiva (0-20%)</h3>
                    <span class="text-[10px] text-gray-400">Risco Baixo / Retorno Alto</span>
                </div>
                <div class="overflow-y-auto flex-1 scrollbar-thin max-h-[40vh]">
                    <table class="w-full text-left text-[10px] compact-table">
                        <thead class="bg-dark-950 text-gray-500 sticky top-0">
                            <tr>
                                <th class="p-2 font-bold">Ativo</th>
                                <th class="p-2 text-right font-bold">Zona</th>
                                <th class="p-2 text-right font-bold">Assimetria</th>
                            </tr>
                        </thead>
                        <tbody id="list-agressive" class="text-gray-300 divide-y divide-gray-800"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="glass rounded-xl overflow-hidden border border-zone-fair flex flex-col shadow-lg">
                <div class="bg-dark-800/90 p-3 border-b border-zone-fair flex justify-between items-center shrink-0">
                    <h3 class="text-zone-fair font-bold text-xs uppercase tracking-wide flex items-center gap-2" data-tip="zone_fair_title"><i class="fa-solid fa-coins"></i> Preço Justo (40-60%)</h3>
                    <span class="text-[10px] text-gray-400">Risco Moderado / Retorno Moderado</span>
                </div>
                <div class="overflow-y-auto flex-1 scrollbar-thin max-h-[40vh]">
                    <table class="w-full text-left text-[10px] compact-table">
                        <thead class="bg-dark-950 text-gray-500 sticky top-0">
                            <tr>
                                <th class="p-2 font-bold">Ativo</th>
                                <th class="p-2 text-center font-bold">Zona</th>
                                <th class="p-2 text-right font-bold">Recomendação</th>
                            </tr>
                        </thead>
                        <tbody id="list-fair" class="text-gray-300 divide-y divide-gray-800"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="glass rounded-xl overflow-hidden border border-zone-full flex flex-col shadow-lg">
                <div class="bg-dark-800/90 p-3 border-b border-zone-full flex justify-between items-center shrink-0">
                    <h3 class="text-zone-full font-bold text-xs uppercase tracking-wide flex items-center gap-2" data-tip="zone_full_title"><i class="fa-solid fa-trophy"></i> Realização Total (80-100%)</h3>
                    <span class="text-[10px] text-gray-400">Risco Alto / Retorno Baixo</span>
                </div>
                <div class="overflow-y-auto flex-1 scrollbar-thin max-h-[40vh]">
                    <table class="w-full text-left text-[10px] compact-table">
                        <thead class="bg-dark-950 text-gray-500 sticky top-0">
                            <tr>
                                <th class="p-2 font-bold">Ativo</th>
                                <th class="p-2 text-right font-bold">Zona</th>
                                <th class="p-2 text-right font-bold">Alvo Realização</th>
                            </tr>
                        </thead>
                        <tbody id="list-full" class="text-gray-300 divide-y divide-gray-800"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="alerts-panel" class="glass rounded-xl overflow-hidden border border-holder-dca_zone flex flex-col shadow-lg dca-zone-indicator">
            <div class="bg-purple-900/20 p-4 border-b border-holder-dca_zone/50 flex justify-between items-center">
                <h3 class="text-holder-dca_zone font-bold text-sm flex items-center gap-2" data-tip="holder_alerts"><i class="fa-solid fa-calendar-check"></i> Alertas de Acumulação (DCA)</h3>
                <button onclick="App.Alerts.openModal()" class="px-3 py-1 bg-holder-dca_zone hover:bg-purple-600 text-white rounded-lg text-xs">+ Novo Alerta DCA</button>
            </div>
            <div class="p-4"><div id="alertsContent" class="space-y-2 max-h-60 overflow-y-auto"></div></div>
        </section>

        <div class="flex flex-col sm:flex-row gap-4 items-center justify-between mt-4">
            <div class="flex items-center gap-2 w-full sm:w-auto">
                <div class="relative group w-full sm:w-64">
                    <input type="text" id="add-input" placeholder="Adicionar ativo (ex: BTC)..." class="w-full bg-dark-900 border border-gray-700 rounded-lg px-4 py-2 text-sm focus:border-holder-accumulation outline-none uppercase shadow-inner transition-all" data-tip="input_add">
                    <button onclick="App.Token.add()" class="absolute right-2 top-1/2 -translate-y-1/2 text-holder-accumulation hover:text-white p-1"><i class="fa-solid fa-plus"></i></button>
                </div>
                <div class="text-[10px] text-gray-500 hidden sm:block">Apenas ativos com fundamentos sólidos</div>
            </div>
            <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider hidden sm:block">Monitoramento de Longo Prazo (1-3 anos)</div>
        </div>
        
        <div id="cards-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4 sm:gap-6 pb-10 card-grid"></div>
    </main>

    <div id="metric-tooltip-overlay" class="tooltip-hidden"></div>

    <div id="alertsModal" class="fixed inset-0 z-[120] hidden modal-overlay flex items-center justify-center p-4">
        <div class="bg-dark-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-md sm:max-w-2xl overflow-hidden mx-2">
            <div class="bg-dark-800 p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-white font-bold">Criar Alerta de Acumulação (DCA)</h3>
                <button onclick="App.Alerts.closeModal()" class="text-gray-500 hover:text-white p-2"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-4 sm:p-6 space-y-4 max-h-96 overflow-y-auto">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Ativo</label>
                        <select id="alert-symbol" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-holder-accumulation outline-none">
                            <option value="">Selecione um ativo</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Tipo de Alerta</label>
                        <select id="alert-type" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-holder-accumulation outline-none">
                            <option value="dca_buy">Acumulação (preço cai para)</option>
                            <option value="profit_take">Realizar Lucros (preço sobe para)</option>
                            <option value="rebalance">Rebalancear Portfólio</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Preço Alvo (USDT)</label>
                        <input type="number" id="alert-price" step="0.0001" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-holder-accumulation outline-none" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Métrica Adicional</label>
                        <select id="alert-metric" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-holder-accumulation outline-none">
                            <option value="none">Apenas preço</option>
                            <option value="rsi_below_30">RSI abaixo de 30</option>
                            <option value="below_sma200">Abaixo da SMA200</option>
                            <option value="volume_spike">Pico de volume (+200%)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Notas (opcional)</label>
                        <textarea id="alert-notes" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-holder-accumulation outline-none" rows="2" placeholder="Ex: Comprar quando atingir este preço com RSI oversold..."></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button onclick="App.Alerts.closeModal()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg">Cancelar</button>
                    <button onclick="App.Alerts.createAlert()" class="px-4 py-2 bg-holder-accumulation hover:bg-green-500 text-white rounded-lg">Salvar Alerta DCA</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 z-[120] hidden modal-overlay flex items-center justify-center p-4">
        <div class="bg-dark-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-md sm:max-w-2xl overflow-hidden mx-2">
            <div class="bg-dark-800 p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-white font-bold">Configurações HOLDER</h3>
                <button onclick="App.Settings.closeModal()" class="text-gray-500 hover:text-white p-2"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-4 sm:p-6 space-y-4 max-h-96 overflow-y-auto">
                <div class="text-white text-sm mb-2">Estratégia de Investimento:</div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-4">
                    <button class="p-3 bg-dark-800 border border-gray-700 rounded-lg text-center hover:border-holder-accumulation" onclick="App.Settings.setStrategy('conservative')">
                        <div class="text-holder-accumulation font-bold">Conservadora</div>
                        <div class="text-xs text-gray-500">70% BTC/ETH</div>
                    </button>
                    <button class="p-3 bg-dark-800 border border-holder-accumulation rounded-lg text-center">
                        <div class="text-holder-accumulation font-bold">Balanceada</div>
                        <div class="text-xs text-gray-500">50% BTC/ETH</div>
                    </button>
                    <button class="p-3 bg-dark-800 border border-gray-700 rounded-lg text-center hover:border-holder-accumulation" onclick="App.Settings.setStrategy('growth')">
                        <div class="text-holder-accumulation font-bold">Crescimento</div>
                        <div class="text-xs text-gray-500">30% BTC/ETH</div>
                    </button>
                </div>
                
                <div class="text-white mb-2">Gerenciar Ativos:</div>
                <div id="settings-tokens-list" class="flex flex-wrap gap-2 mt-2 mb-4">
                    </div>
                
                <div class="text-white mb-2">Adicionar Ativos em Lote (apelido:SYMBOL):</div>
                <textarea id="batch-tokens" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-holder-accumulation outline-none" rows="4" placeholder="Exemplo:&#10;Bitcoin:BTC&#10;Ethereum:ETH&#10;Cardano:ADA"></textarea>
                <div class="flex gap-2">
                    <button onclick="App.Token.addBatch()" class="px-4 py-2 bg-holder-accumulation hover:bg-green-500 text-white rounded-lg">Adicionar Ativos</button>
                    <button onclick="App.Token.removeSelected()" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg">Excluir Selecionados</button>
                </div>
            </div>
            <div class="flex justify-end gap-2 pt-4 p-4">
                <button onclick="App.Settings.save()" class="px-4 py-2 bg-holder-accumulation hover:bg-green-500 text-white rounded-lg">Salvar Configurações</button>
            </div>
        </div>
    </div>
    
    <div id="export-modal" class="fixed inset-0 z-[120] hidden modal-overlay flex items-center justify-center p-4">
        <div class="bg-dark-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-md overflow-hidden mx-2">
            <div class="bg-dark-800 p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-white font-bold">Exportar Relatório</h3>
                <button onclick="App.Export.closeModal()" class="text-gray-500 hover:text-white p-2"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <button onclick="App.Export.gen('xlsx')" class="w-full bg-holder-accumulation hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg">Baixar Relatório .XLSX</button>
                <button onclick="App.Export.gen('portfolio')" class="w-full bg-holder-holding hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg">Exportar Portfólio Ideal</button>
            </div>
        </div>
    </div>

    <template id="card-template">
        <div class="card glass rounded-xl overflow-hidden hover:border-gray-500 transition-all duration-300 card-enter flex flex-col group shadow-lg holder-phase-holding" data-symbol="">
            <button class="btn-remove absolute top-2 right-2 text-gray-600 hover:text-red-500 z-20 opacity-0 group-hover:opacity-100 p-2 transition-opacity bg-dark-900/80 rounded-full backdrop-blur-sm" title="Remover"><i class="fa-solid fa-times"></i></button>
            
            <div class="p-4 cursor-pointer card-header relative z-10 bg-gradient-to-b from-dark-800/40 to-transparent" onclick="App.UI.toggleCard(this)">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-3">
                        <div class="relative w-10 h-10">
                            <div class="score-badge w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold text-black border border-white shadow-sm cursor-help" data-tip="m_score">--</div>
                        </div>
                        <div>
                            <h3 class="font-bold text-white text-lg symbol-ticker leading-none" data-tip="col_ticker">BTC</h3>
                            <div class="text-[9px] text-gray-400 symbol-name">Bitcoin</div>
                            <div class="flex items-center gap-1 mt-1">
                                <span class="phase-badge text-[8px] font-bold uppercase px-1.5 py-0.5 rounded bg-gray-800 text-gray-500 inline-block cursor-help" data-tip="m_phase">Fase: --</span>
                                <span class="zone-badge text-[8px] font-bold uppercase px-1.5 py-0.5 rounded bg-gray-800 text-gray-500 inline-block cursor-help" data-tip="m_zone">Zona: --</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-mono font-bold text-white price-display cursor-help" data-tip="m_price">$0.00</div>
                        <div class="text-[10px] text-gray-400 mt-1">Market Cap: <span class="market-cap-value font-mono">--</span></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-4 gap-2 mb-2 mt-3">
                    <div class="var-box cursor-help" data-tip="var_1h">
                        <div class="text-[8px] text-gray-500 uppercase font-bold">1H</div>
                        <div class="text-[10px] font-bold font-mono val-1h">--</div>
                    </div>
                    <div class="var-box cursor-help" data-tip="var_24h">
                        <div class="text-[8px] text-gray-500 uppercase font-bold">24H</div>
                        <div class="text-[10px] font-bold font-mono val-24h">--</div>
                    </div>
                    <div class="var-box cursor-help" data-tip="var_7d">
                        <div class="text-[8px] text-gray-500 uppercase font-bold">7D</div>
                        <div class="text-[10px] font-bold font-mono val-7d">--</div>
                    </div>
                    <div class="var-box cursor-help" data-tip="var_30d">
                        <div class="text-[8px] text-gray-500 uppercase font-bold">30D</div>
                        <div class="text-[10px] font-bold font-mono val-30d">--</div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-1 text-[9px] font-mono text-gray-400 pt-2 border-t border-gray-800/50">
                    <div class="text-center cursor-help" data-tip="m_sma200">SMA200: <span class="metric-sma200 text-white">--</span></div>
                    <div class="text-center cursor-help" data-tip="m_historical">Posição: <span class="metric-historical text-white">--</span></div>
                    <div class="text-center cursor-help" data-tip="rsi_weekly">RSI Sem: <span class="metric-rsi-weekly text-white">--</span></div>
                </div>
                <div class="flex justify-center gap-1 mt-1">
                    <div class="zone-indicator zone-0-20 w-full"></div>
                    <div class="zone-indicator zone-20-40 w-full"></div>
                    <div class="zone-indicator zone-40-60 w-full"></div>
                    <div class="zone-indicator zone-60-80 w-full"></div>
                    <div class="zone-indicator zone-80-100 w-full"></div>
                </div>
            </div>

            <div class="card-body hidden border-t border-gray-800 bg-dark-900 relative z-20 p-4">
                <div class="relative h-8 w-full bg-dark-800 rounded border border-gray-800 mb-4 overflow-hidden">
                    <div class="historical-band band-0-20"></div>
                    <div class="historical-band band-20-40"></div>
                    <div class="historical-band band-40-60"></div>
                    <div class="historical-band band-60-80"></div>
                    <div class="historical-band band-80-100"></div>
                    <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center">
                        <span class="text-xs font-bold z-10">Posição Histórica: <span class="historical-position">--</span>%</span>
                    </div>
                    <div class="absolute bottom-0 left-0 h-full w-1 bg-white z-10 historical-indicator" style="left: 50%;"></div>
                </div>
                
                <div class="h-40 sm:h-48 w-full bg-black rounded border border-gray-800 chart-container mb-4 cursor-help" data-tip="m_chart"></div>
                
                <div class="space-y-4">
                    <div class="bg-dark-950 p-2 rounded border border-gray-800">
                        <h5 class="text-[9px] text-gray-500 uppercase font-bold mb-1 border-b border-gray-800 pb-1">Valuation & Fundamentos</h5>
                        <div class="space-y-1 text-[10px] font-mono">
                            <div class="flex justify-between cursor-help" data-tip="val_mcap"><span class="text-gray-600">Market Cap:</span><span class="val-mcap text-blue-400">--</span></div>
                            <div class="flex justify-between cursor-help" data-tip="val_fdv"><span class="text-gray-600">FDV:</span><span class="val-fdv text-blue-400">--</span></div>
                            <div class="flex justify-between cursor-help" data-tip="val_mcap_ath"><span class="text-gray-600">MC ATH:</span><span class="val-mcap-ath text-red-400">--</span></div>
                            <div class="flex justify-between cursor-help" data-tip="val_mcap_discount"><span class="text-gray-600">Desconto MC ATH:</span><span class="val-mcap-discount text-green-400">--</span></div>
                            <div class="flex justify-between cursor-help" data-tip="val_inflation"><span class="text-gray-600">Inflação Anual:</span><span class="val-inflation text-yellow-400">--</span></div>
                        </div>
                    </div>
                    
                    <div class="bg-dark-950 p-2 rounded border border-gray-800">
                        <h5 class="text-[9px] text-gray-500 uppercase font-bold mb-1 border-b border-gray-800 pb-1 cursor-help" data-tip="zones_intro">Zonas de Preço HOLDER</h5>
                        <div class="space-y-1 text-[10px] font-mono">
                            <div class="flex justify-between"><span class="text-zone-agressive">0-20% Acum. Agressiva:</span><span class="zone-agg text-zone-agressive">--</span></div>
                            <div class="flex justify-between"><span class="text-zone-moderate">20-40% Acum. Moderada:</span><span class="zone-mod text-zone-moderate">--</span></div>
                            <div class="flex justify-between"><span class="text-zone-fair">40-60% Preço Justo:</span><span class="zone-fair text-zone-fair">--</span></div>
                            <div class="flex justify-between"><span class="text-zone-partial">60-80% Realização Parcial:</span><span class="zone-partial text-zone-partial">--</span></div>
                            <div class="flex justify-between"><span class="text-zone-full">80-100% Realização Total:</span><span class="zone-full text-zone-full">--</span></div>
                        </div>
                    </div>
                    
                    <div class="bg-dark-950 p-2 rounded border border-gray-800">
                        <h5 class="text-[9px] text-gray-500 uppercase font-bold mb-1 border-b border-gray-800 pb-1 cursor-help" data-tip="momentum_holder">Momentum HOLDER</h5>
                        <div class="space-y-1 text-[10px] font-mono">
                            <div class="flex justify-between cursor-help" data-tip="rsi_weekly">
                                <span class="text-gray-600">RSI Semanal (14):</span>
                                <span class="rsi-weekly-value text-white">--</span>
                            </div>
                            <div class="flex justify-between cursor-help" data-tip="rsi_monthly">
                                <span class="text-gray-600">RSI Mensal (14):</span>
                                <span class="rsi-monthly-value text-white">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Interpretação:</span>
                                <span class="rsi-interpretation text-white">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-dark-950 p-2 rounded border border-gray-800">
                        <h5 class="text-[9px] text-gray-500 uppercase font-bold mb-1 border-b border-gray-800 pb-1">Análise HOLDER 2.0</h5>
                        <div class="analysis-holder-content text-[10px] text-gray-300 space-y-2">
                            <div class="flex justify-between">
                                <span class="cursor-help" data-tip="analysis_score">Score HOLDER 2.0:</span>
                                <span class="analysis-score font-bold">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="cursor-help" data-tip="analysis_phase">Fase do Ciclo:</span>
                                <span class="analysis-phase">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="cursor-help" data-tip="analysis_recommendation">Recomendação:</span>
                                <span class="analysis-recommendation">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="cursor-help" data-tip="analysis_horizon">Horizonte Ideal:</span>
                                <span class="analysis-horizon">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="cursor-help" data-tip="analysis_asymmetry">Assimetria:</span>
                                <span class="analysis-asymmetry">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="cursor-help" data-tip="analysis_probability">Prob. Retorno (3 anos):</span>
                                <span class="analysis-probability">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="cursor-help" data-tip="analysis_confidence">Confiança:</span>
                                <span class="analysis-confidence">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-dark-950 p-2 rounded border border-gray-800">
                        <h5 class="text-[9px] text-gray-500 uppercase font-bold mb-1 border-b border-gray-800 pb-1">Alvos de Longo Prazo</h5>
                        <div class="space-y-1 text-[10px] font-mono">
                            <div class="flex justify-between"><span class="text-gray-600">Alvo 1 ano:</span><span class="target-1y text-green-400">--</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Alvo 2 anos:</span><span class="target-2y text-blue-400">--</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Alvo 3 anos:</span><span class="target-3y text-purple-400">--</span></div>
                        </div>
                    </div>
                    
                    <div class="bg-dark-950 p-2 rounded border border-gray-800">
                        <h5 class="text-[9px] text-gray-500 uppercase font-bold mb-1 border-b border-gray-800 pb-1">Alertas DCA</h5>
                        <div class="alert-list text-[10px] text-gray-300 space-y-1 max-h-20 overflow-y-auto"></div>
                        <button class="w-full bg-holder-dca_zone/30 text-holder-dca_zone text-[9px] border border-holder-dca_zone rounded py-1 mt-1 hover:bg-holder-dca_zone/50 transition-colors" onclick="App.Alerts.openForCard(this)">+ Alerta DCA</button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        const BINANCE_REST = "https://api.binance.com/api/v3/klines";
        const COINGECKO_API = "https://api.coingecko.com/api/v3/coins/";
        
        // Configuração HOLDER
        const HOLDER_CONFIG = {
            refreshInterval: 720, // 12 minutos em segundos
            timeframes: ["1d", "1w", "1m"], // Timeframes para holders
            ohlcLimits: { "1d": 730, "1w": 208, "1m": 60 }, // 2 anos de dados
            minMarketCap: 100000000, // $100M mínimo
            fundamentalsWeight: {
                valuation: 0.40,
                cycle: 0.30,
                fundamentals: 0.20,
                technical: 0.10
            }
        };

        const App = {
            State: {
                tokens: JSON.parse(localStorage.getItem('holder_tokens')) || [
                    {symbol: 'BTCUSDT', name: 'Bitcoin', coinId: 'bitcoin'},
                    {symbol: 'ETHUSDT', name: 'Ethereum', coinId: 'ethereum'},
                    {symbol: 'BNBUSDT', name: 'Binance Coin', coinId: 'binancecoin'},
                    {symbol: 'SOLUSDT', name: 'Solana', coinId: 'solana'},
                    {symbol: 'ADAUSDT', name: 'Cardano', coinId: 'cardano'},
                    {symbol: 'DOTUSDT', name: 'Polkadot', coinId: 'polkadot'}
                ],
                alerts: JSON.parse(localStorage.getItem('holder_alerts')) || [],
                historicalData: JSON.parse(localStorage.getItem('holder_historical')) || {},
                fundamentalsData: JSON.parse(localStorage.getItem('holder_fundamentals')) || {},
                ws: null, 
                charts: {}, 
                activeCard: null,
                settings: JSON.parse(localStorage.getItem('holder_settings')) || { 
                    strategy: 'balanced',
                    autoRefresh: true, 
                    refreshInterval: HOLDER_CONFIG.refreshInterval,
                    alertSounds: true, 
                    dcaEnabled: true,
                    riskProfile: 'moderate',
                    minMarketCap: HOLDER_CONFIG.minMarketCap,
                    showFundamentals: true
                },
                marketData: {}, 
                ohlcData: {}, 
                indicatorsData: {}, 
                scoreData: {},
                opportunities: []
            },

            // 1. BIBLIOTECA HOLDER - Conteúdo educacional específico para holders
            Library: {
                // Tooltips curtas para cards
                'm_score_short': "Score HOLDER 2.0: Avaliação completa para holders (0-100)",
                'm_phase_short': "Fase: Acumulação, Manter ou Realizar Lucros",
                'm_zone_short': "Zona: Percentil histórico (0-100%)",
                'm_price_short': "Preço atual em USDT",
                'm_mcap_short': "Market Cap: Valor de mercado total",
                'm_sma200_short': "Média móvel de 200 dias (tendência longa)",
                'm_historical_short': "Posição histórica vs últimos 2 anos",
                'rsi_weekly_short': "RSI semanal: Momentum de médio prazo",
                
                // Tooltips longas para overlay
                'm_score': { 
                    title: "Score HOLDER 2.0", 
                    what: "Pontuação de 0-100 baseada na fórmula: (Valuation × 0.40) + (Cycle × 0.30) + (Fundamentals × 0.20) + (Technical × 0.10). Avaliação completa para investidores de longo prazo.", 
                    interp: "70+ = acumulação agressiva, 40-70 = manter posição, abaixo de 40 = considerar realizar lucros.", 
                    tip: "Foque em ativos com score >70 para novas posições.",
                    example: "Score 85/100 = oportunidade excepcional"
                },
                'm_zone': { 
                    title: "Zona Percentil Histórico", 
                    what: "Posição do preço atual em relação ao histórico de 2 anos. Calculado como percentil (0-100%).", 
                    interp: "0-20% = acumulação agressiva, 20-40% = acumulação moderada, 40-60% = preço justo, 60-80% = realização parcial, 80-100% = realização total.", 
                    tip: "Acumule nas zonas 0-40%, realize nas zonas 60-100%.",
                    example: "Zona 25% = acumulação moderada"
                },
                'val_mcap': { 
                    title: "Market Cap (Capitalização de Mercado)", 
                    what: "Valor total de mercado = preço × oferta circulante. Indicador de tamanho e maturidade do projeto.", 
                    interp: "Maior market cap = menor risco, menor potencial. Menor market cap = maior risco, maior potencial.", 
                    tip: "Diversifique entre grandes, médias e pequenas caps.",
                    example: "BTC: $900B, ETH: $400B, SOL: $80B"
                },
                'val_fdv': { 
                    title: "FDV (Fully Diluted Valuation)", 
                    what: "Valor total se todas as moedas/tokens fossem emitidos. Mostra potencial diluição futura.", 
                    interp: "FDV muito maior que Market Cap = alta diluição futura. Ideal: FDV próximo ao Market Cap.", 
                    tip: "Evite projetos com FDV > 3x Market Cap.",
                    example: "Market Cap: $100M, FDV: $300M = diluição 3x"
                },
                'val_mcap_ath': { 
                    title: "Market Cap ATH", 
                    what: "Máxima capitalização de mercado já atingida pelo ativo.", 
                    interp: "Compare com atual para ver potencial de recuperação. Quanto maior o desconto, maior potencial.", 
                    tip: "Busque descontos >70% do ATH para oportunidades.",
                    example: "ATH: $100B, Atual: $30B (70% desconto)"
                },
                'val_inflation': { 
                    title: "Inflação/Emissão Anual", 
                    what: "Percentual de novos tokens emitidos anualmente. Impacta diretamente o preço por diluição.", 
                    interp: "Baixa inflação = melhor para holders. Alta inflação = pressão vendedora constante.", 
                    tip: "Prefira ativos com inflação <5% ao ano.",
                    example: "BTC: 1.7%, ETH: 0%, SOL: 8%"
                },
                'analysis_asymmetry': { 
                    title: "Assimetria de Risco/Retorno", 
                    what: "Relação entre potencial de alta vs potencial de baixa. Calculado como (alvo alto - preço) / (preço - suporte).", 
                    interp: ">3 = excelente assimetria (alto retorno, baixo risco). <1 = má assimetria.", 
                    tip: "Só invista com assimetria >2.",
                    example: "Assimetria 4:1 = ganha 4x mais do que pode perder"
                },
                'analysis_probability': { 
                    title: "Probabilidade de Retorno (3 anos)", 
                    what: "Probabilidade estimada de retorno positivo em 3 anos baseada em histórico, fundamentals e ciclos.", 
                    interp: ">80% = alta probabilidade, 60-80% = moderada, <60% = baixa.", 
                    tip: "Invista apenas quando probabilidade >70%.",
                    example: "85% = alta chance de lucro em 3 anos"
                },
                'zone_agressive': { 
                    title: "Zona 0-20%: Acumulação Agressiva", 
                    what: "Preço está nos 20% mais baixos do histórico de 2 anos. Máxima oportunidade de acumulação.", 
                    interp: "Momento ideal para DCA agressivo. Risco baixo, retorno potencial alto.", 
                    tip: "Acumule de forma consistente nesta zona.",
                    example: "BTC a $30k quando histórico é $30k-$70k"
                },
                'zone_moderate': { 
                    title: "Zona 20-40%: Acumulação Moderada", 
                    what: "Preço está entre 20-40% do range histórico. Boa oportunidade com risco moderado.", 
                    interp: "Continue DCA mas de forma mais conservadora.", 
                    tip: "Aumente posição gradualmente.",
                    example: "ETH a $2.5k quando histórico é $1k-$5k"
                },
                'zone_fair': { 
                    title: "Zona 40-60%: Preço Justo", 
                    what: "Preço está na metade do range histórico. Valuation razoável.", 
                    interp: "Mantenha posições, não acumule nem realize.", 
                    tip: "Apenas rebalanceie portfólio.",
                    example: "Preço médio do histórico"
                },
                'zone_partial': { 
                    title: "Zona 60-80%: Realização Parcial", 
                    what: "Preço está entre 60-80% do range histórico. Considere realizar lucros parciais.", 
                    interp: "Realize 20-30% da posição para garantir lucros.", 
                    tip: "Nunca venda tudo de uma vez.",
                    example: "Realizar 25% aos 70% do range"
                },
                'zone_full': { 
                    title: "Zona 80-100%: Realização Total", 
                    what: "Preço está nos 20% mais altos do histórico. Máxima realização de lucros.", 
                    interp: "Considere realizar 50-70% da posição.", 
                    tip: "Deixe runner para ciclos futuros.",
                    example: "Realizar 60% aos 90% do range"
                },
                'opportunities_title': { 
                    title: "Top 10 Oportunidades HOLDER", 
                    what: "Lista dos 10 ativos com melhor Score HOLDER 2.0 entre os tokens monitorados.", 
                    interp: "Foque nestas oportunidades para alocação de capital. Ordenadas por score (melhor primeiro).", 
                    tip: "Diversifique entre as top 5 oportunidades.",
                    example: "BTC, ETH, SOL com scores >80"
                }
            },

            // 2. CORE ENGINE HOLDER
            Core: {
                init: async () => {
                    App.UI.tooltips();
                    
                    // Carregar dados iniciais
                    await App.Core.preloadAllOHLC();
                    await App.Core.loadHistoricalData();
                    await App.Fundamentals.loadFundamentals(); // Carregar dados fundamentais
                    
                    // Inicializar UI
                    App.UI.grid(); 
                    App.UI.tables(); 
                    App.Opportunities.generate();
                    
                    // Configurar auto-refresh (12 minutos)
                    setInterval(() => { 
                        let e = document.getElementById('countdown'), v = +e.innerText.replace('s',''); 
                        e.innerText = (v <= 0 ? HOLDER_CONFIG.refreshInterval : v - 1) + 's'; 
                        if (v <= 0 && App.State.settings.autoRefresh) App.Core.refreshData(); 
                    }, 1000);
                    
                    // Atualização incremental (6 minutos)
                    setInterval(() => {
                        App.State.tokens.forEach(token => {
                            HOLDER_CONFIG.timeframes.forEach(tf => { 
                                App.Core.incrementalUpdateOHLC(token.symbol, tf); 
                            });
                        });
                    }, 360000); // 6 minutos
                    
                    // Verificar alertas (10 segundos)
                    setInterval(() => App.Alerts.checkAllAlerts(), 10000);

                    // Mobile menu toggle
                    document.getElementById('mobile-menu-toggle').addEventListener('click', function() {
                        const controls = document.getElementById('header-controls');
                        controls.classList.toggle('hidden');
                        controls.classList.toggle('flex');
                    });

                    // Inicializar alertas
                    App.Alerts.renderAlertsPanel();
                    
                    document.getElementById('last-update').innerText = new Date().toLocaleTimeString();
                    
                    // Configurar contador inicial
                    document.getElementById('countdown').innerText = HOLDER_CONFIG.refreshInterval + 's';
                },
                
                refreshData: () => { 
                    App.Core.preloadAllOHLC(); 
                    App.Fundamentals.loadFundamentals();
                    document.getElementById('last-update').innerText = new Date().toLocaleTimeString(); 
                },
                
                // Removido WebSocket - não necessário para holders
                
                fetchOHLC: async function(symbol, interval = "1d", limit = 500) {
                    try {
                        const r = await fetch(`${BINANCE_REST}?symbol=${symbol.toUpperCase()}&interval=${interval}&limit=${limit}`);
                        const j = await r.json();
                        return j.map(k => ({ 
                            time: k[0], 
                            open: parseFloat(k[1]), 
                            high: parseFloat(k[2]), 
                            low: parseFloat(k[3]), 
                            close: parseFloat(k[4]), 
                            volume: parseFloat(k[5]) 
                        }));
                    } catch (err) { 
                        console.error(`Erro ao buscar OHLC para ${symbol}:`, err);
                        return []; 
                    }
                },
                
                loadAllOHLC: async function(symbol) {
                    if (!App.State.ohlcData[symbol]) App.State.ohlcData[symbol] = {};
                    for (let tf of HOLDER_CONFIG.timeframes) { 
                        const limit = HOLDER_CONFIG.ohlcLimits[tf] || 500;
                        App.State.ohlcData[symbol][tf] = await App.Core.fetchOHLC(symbol, tf, limit); 
                    }
                },
                
                preloadAllOHLC: async function() {
                    for (let token of App.State.tokens) {
                        await App.Core.loadAllOHLC(token.symbol.toUpperCase());
                    }
                    App.State.tokens.forEach(token => { 
                        HOLDER_CONFIG.timeframes.forEach(tf => { 
                            App.Indicators.updateIndicators(token.symbol.toLowerCase(), tf); 
                        }); 
                    });
                    
                    // Calcular scores
                    App.State.tokens.forEach(token => {
                        App.Score.calculate(token.symbol);
                    });
                    
                    // Atualizar UI
                    App.UI.updateAllCards();
                    App.UI.tables();
                    App.Opportunities.generate();
                },
                
                incrementalUpdateOHLC: async function(symbol, tf) {
                    const url = `${BINANCE_REST}?symbol=${symbol.toUpperCase()}&interval=${tf}&limit=3`;
                    try {
                        const response = await fetch(url); 
                        const raw = await response.json();
                        const newCandles = raw.map(k => ({ 
                            time: k[0], 
                            open: parseFloat(k[1]), 
                            high: parseFloat(k[2]), 
                            low: parseFloat(k[3]), 
                            close: parseFloat(k[4]), 
                            volume: parseFloat(k[5]) 
                        }));
                        
                        if (!App.State.ohlcData[symbol] || !App.State.ohlcData[symbol][tf]) { 
                            App.State.ohlcData[symbol] = App.State.ohlcData[symbol] || {}; 
                            App.State.ohlcData[symbol][tf] = newCandles; 
                        } else { 
                            const existing = App.State.ohlcData[symbol][tf]; 
                            newCandles.forEach(c => { 
                                const idx = existing.findIndex(x => x.time === c.time); 
                                if (idx === -1) existing.push(c); 
                                else existing[idx] = c; 
                            }); 
                            existing.sort((a, b) => a.time - b.time); 
                        }
                        App.Core.triggerOHLCUpdate(symbol.toLowerCase(), tf);
                        App.Indicators.updateIndicators(symbol.toLowerCase(), tf);
                    } catch (err) {
                        console.error(`Erro incremental update ${symbol} ${tf}:`, err);
                    }
                },
                
                getOHLC: (symbol, tf) => (App.State.ohlcData[symbol.toUpperCase()] || {})[tf] || [],
                getCloseArray: (symbol, tf) => App.Core.getOHLC(symbol, tf).map(c => c.close),
                
                // Carregar dados históricos para análise de valuation
                loadHistoricalData: async function() {
                    if (Object.keys(App.State.historicalData).length > 0) return;
                    
                    // Para cada token, calcular estatísticas históricas
                    for (let token of App.State.tokens) {
                        const symbol = token.symbol;
                        const ohlc1d = App.Core.getOHLC(symbol, "1d");
                        if (ohlc1d.length > 0) {
                            const closes = ohlc1d.map(c => c.close);
                            const highs = ohlc1d.map(c => c.high);
                            const lows = ohlc1d.map(c => c.low);
                            
                            App.State.historicalData[symbol] = {
                                ath: Math.max(...highs),
                                atl: Math.min(...lows),
                                avg2y: closes.length >= 730 ? 
                                    closes.slice(-730).reduce((a, b) => a + b, 0) / 730 :
                                    closes.reduce((a, b) => a + b, 0) / closes.length,
                                currentPercentile: 0,
                                volatility: App.Indicators.calculateHistoricalVolatility(closes),
                                priceZones: App.Indicators.calculatePriceZones(closes)
                            };
                        }
                    }
                    
                    localStorage.setItem('holder_historical', JSON.stringify(App.State.historicalData));
                },
                
                ohlcCallbacks: [],
                onOHLCUpdate: (cb) => App.Core.ohlcCallbacks.push(cb),
                triggerOHLCUpdate: (symbol, tf) => App.Core.ohlcCallbacks.forEach(cb => cb(symbol, tf)),
                
                // Calcular variação de preço
                calculatePriceChange: (symbol, period) => {
                    // Buscar preço atual via API REST
                    const currentPrice = App.State.marketData[symbol.toLowerCase()]?.lastPrice;
                    if (!currentPrice || currentPrice === 0) return 0;
                    
                    let pastPrice = 0;
                    let ohlc;
                    
                    try {
                        switch(period) {
                            case "1h":
                                // Para 1h, buscar candle recente
                                const url1h = `${BINANCE_REST}?symbol=${symbol.toUpperCase()}&interval=1h&limit=2`;
                                return fetch(url1h)
                                    .then(r => r.json())
                                    .then(data => {
                                        if (data.length >= 2) {
                                            pastPrice = parseFloat(data[0][4]); // close do candle anterior
                                            return ((currentPrice - pastPrice) / pastPrice) * 100;
                                        }
                                        return 0;
                                    })
                                    .catch(() => 0);
                                
                            case "24h":
                                // Buscar ticker de 24h
                                const url24h = `https://api.binance.com/api/v3/ticker/24hr?symbol=${symbol.toUpperCase()}`;
                                return fetch(url24h)
                                    .then(r => r.json())
                                    .then(data => parseFloat(data.priceChangePercent) || 0)
                                    .catch(() => 0);
                                
                            case "7d":
                                ohlc = App.Core.getOHLC(symbol, "1d");
                                if (ohlc && ohlc.length >= 7) {
                                    pastPrice = ohlc[ohlc.length - 7].close;
                                    return ((currentPrice - pastPrice) / pastPrice) * 100;
                                }
                                return 0;
                                
                            case "30d":
                                ohlc = App.Core.getOHLC(symbol, "1d");
                                if (ohlc && ohlc.length >= 30) {
                                    pastPrice = ohlc[ohlc.length - 30].close;
                                    return ((currentPrice - pastPrice) / pastPrice) * 100;
                                }
                                return 0;
                                
                            default:
                                return 0;
                        }
                        
                    } catch (error) {
                        return 0;
                    }
                },
                
                // Buscar preço atual
                fetchCurrentPrice: async function(symbol) {
                    try {
                        const response = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol.toUpperCase()}`);
                        const data = await response.json();
                        const price = parseFloat(data.price);
                        
                        if (!App.State.marketData[symbol.toLowerCase()]) {
                            App.State.marketData[symbol.toLowerCase()] = {};
                        }
                        App.State.marketData[symbol.toLowerCase()].lastPrice = price;
                        
                        return price;
                    } catch (error) {
                        console.error(`Erro ao buscar preço de ${symbol}:`, error);
                        return 0;
                    }
                }
            },

            // 3. INDICATORS HOLDER
            Indicators: {
                // Calcular SMA para qualquer período
                calculateSMA: (closes, period) => {
                    if (closes.length < period) return null;
                    const sum = closes.slice(-period).reduce((a, b) => a + b, 0);
                    return sum / period;
                },
                
                // Calcular EMA
                calculateEMA: (closes, period) => {
                    if (closes.length < period) return null;
                    const k = 2 / (period + 1);
                    let ema = closes.slice(0, period).reduce((a, b) => a + b, 0) / period;
                    
                    for (let i = period; i < closes.length; i++) {
                        ema = (closes[i] - ema) * k + ema;
                    }
                    return ema;
                },
                
                // Calcular volatilidade histórica
                calculateHistoricalVolatility: (closes, period = 30) => {
                    if (closes.length < period + 1) return 0;
                    
                    const returns = [];
                    for (let i = 1; i < closes.length; i++) {
                        returns.push((closes[i] - closes[i-1]) / closes[i-1]);
                    }
                    
                    const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
                    const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length;
                    return Math.sqrt(variance) * Math.sqrt(365); // Anualizada
                },
                
                // Calcular percentil histórico
                calculateHistoricalPercentile: (currentPrice, historicalCloses) => {
                    if (historicalCloses.length === 0) return 50;
                    
                    const sorted = [...historicalCloses].sort((a, b) => a - b);
                    const countBelow = sorted.filter(price => price < currentPrice).length;
                    return (countBelow / sorted.length) * 100;
                },
                
                // Calcular zonas de preço baseadas em percentis históricos
                calculatePriceZones: (historicalCloses) => {
                    if (historicalCloses.length < 100) return null;
                    
                    const sorted = [...historicalCloses].sort((a, b) => a - b);
                    return {
                        zone0_20: sorted[Math.floor(sorted.length * 0.0)], // 0% (mínimo)
                        zone20_40: sorted[Math.floor(sorted.length * 0.2)], // 20%
                        zone40_60: sorted[Math.floor(sorted.length * 0.4)], // 40%
                        zone60_80: sorted[Math.floor(sorted.length * 0.6)], // 60%
                        zone80_100: sorted[Math.floor(sorted.length * 0.8)], // 80%
                        zone100: sorted[Math.floor(sorted.length * 0.95)] // 95% (quase máximo)
                    };
                },
                
                // Calcular RSI
                calculateRSI: (closes, period = 14) => {
                    if (closes.length < period + 1) return null;
                    
                    let gains = [];
                    let losses = [];
                    
                    for (let i = 1; i < closes.length; i++) {
                        const change = closes[i] - closes[i - 1];
                        gains.push(change > 0 ? change : 0);
                        losses.push(change < 0 ? -change : 0);
                    }
                    
                    const avgGain = gains.slice(-period).reduce((a, b) => a + b, 0) / period;
                    const avgLoss = losses.slice(-period).reduce((a, b) => a + b, 0) / period;
                    
                    if (avgLoss === 0) return 100;
                    const rs = avgGain / avgLoss;
                    return 100 - (100 / (1 + rs));
                },
                
                // Interpretação do RSI para holders
                interpretRSI: (rsi) => {
                    if (!rsi) return 'N/A';
                    if (rsi < 30) return 'Oversold (Acumular)';
                    if (rsi > 70) return 'Overbought (Considerar realizar)';
                    return 'Neutro (Manter)';
                },
                
                // Determinar zona baseada no percentil
                determineZone: (percentile) => {
                    if (percentile < 20) return { zone: '0-20%', name: 'Acumulação Agressiva', color: 'zone-agressive' };
                    if (percentile < 40) return { zone: '20-40%', name: 'Acumulação Moderada', color: 'zone-moderate' };
                    if (percentile < 60) return { zone: '40-60%', name: 'Preço Justo', color: 'zone-fair' };
                    if (percentile < 80) return { zone: '60-80%', name: 'Realização Parcial', color: 'zone-partial' };
                    return { zone: '80-100%', name: 'Realização Total', color: 'zone-full' };
                },
                
                // Determinar fase holder
                determineHolderPhase: (percentile, rsiWeekly) => {
                    if (percentile < 40 || (rsiWeekly && rsiWeekly < 35)) {
                        return 'accumulation';
                    } else if (percentile > 70 || (rsiWeekly && rsiWeekly > 70)) {
                        return 'profit_taking';
                    } else {
                        return 'holding';
                    }
                },
                
                // Atualizar indicadores
                updateIndicators: (symbol, tf) => {
                    const ohlc = App.Core.getOHLC(symbol, tf);
                    const closes = ohlc.map(c => c.close);
                    
                    if (!App.State.indicatorsData[symbol]) App.State.indicatorsData[symbol] = {};
                    if (!App.State.indicatorsData[symbol][tf]) App.State.indicatorsData[symbol][tf] = {};
                    
                    const ind = App.State.indicatorsData[symbol][tf];
                    
                    // Dados do timeframe diário são os principais
                    if (tf === "1d") {
                        // SMA200 apenas no diário
                        ind.sma200 = App.Indicators.calculateSMA(closes, 200);
                        ind.ema200 = App.Indicators.calculateEMA(closes, 200);
                        
                        // Percentil histórico
                        const historical = App.State.historicalData[symbol.toUpperCase()];
                        const currentPrice = App.State.marketData[symbol.toLowerCase()]?.lastPrice || closes[closes.length - 1];
                        
                        if (historical && closes.length > 0) {
                            ind.historicalPercentile = App.Indicators.calculateHistoricalPercentile(currentPrice, closes);
                            ind.zone = App.Indicators.determineZone(ind.historicalPercentile);
                        }
                        
                        // Volatilidade
                        ind.volatility = App.Indicators.calculateHistoricalVolatility(closes, 30);
                    }
                    
                    // RSI semanal
                    if (tf === "1w") {
                        ind.rsiWeekly = App.Indicators.calculateRSI(closes, 14);
                    }
                    
                    // RSI mensal
                    if (tf === "1m") {
                        ind.rsiMonthly = App.Indicators.calculateRSI(closes, 14);
                    }
                    
                    // Calcular fase holder
                    const percentile = ind.historicalPercentile || 50;
                    const rsiWeekly = App.State.indicatorsData[symbol]?.["1w"]?.rsiWeekly;
                    ind.holderPhase = App.Indicators.determineHolderPhase(percentile, rsiWeekly);
                }
            },

            // 4. FUNDAMENTALS MODULE
            Fundamentals: {
                // Carregar dados fundamentais
                loadFundamentals: async function() {
                    // Para cada token, buscar dados do CoinGecko
                    for (let token of App.State.tokens) {
                        if (!token.coinId) continue;
                        
                        try {
                            const response = await fetch(`${COINGECKO_API}${token.coinId}?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=false`);
                            const data = await response.json();
                            
                            App.State.fundamentalsData[token.symbol] = {
                                marketCap: data.market_data?.market_cap?.usd || 0,
                                fdv: data.market_data?.fully_diluted_valuation?.usd || 0,
                                totalVolume: data.market_data?.total_volume?.usd || 0,
                                circulatingSupply: data.market_data?.circulating_supply || 0,
                                totalSupply: data.market_data?.total_supply || 0,
                                maxSupply: data.market_data?.max_supply || 0,
                                ath: data.market_data?.ath?.usd || 0,
                                athChangePercentage: data.market_data?.ath_change_percentage?.usd || 0,
                                atl: data.market_data?.atl?.usd || 0,
                                atlChangePercentage: data.market_data?.atl_change_percentage?.usd || 0,
                                priceChange24h: data.market_data?.price_change_percentage_24h || 0,
                                priceChange7d: data.market_data?.price_change_percentage_7d || 0,
                                priceChange30d: data.market_data?.price_change_percentage_30d || 0,
                                lastUpdated: data.last_updated
                            };
                            
                            // Calcular inflação anual
                            if (data.market_data?.circulating_supply && data.market_data?.total_supply) {
                                const inflation = ((data.market_data.total_supply - data.market_data.circulating_supply) / data.market_data.circulating_supply) * 100;
                                App.State.fundamentalsData[token.symbol].annualInflation = Math.min(inflation, 100);
                            }
                            
                        } catch (error) {
                            console.error(`Erro ao buscar dados de ${token.coinId}:`, error);
                        }
                    }
                    
                    localStorage.setItem('holder_fundamentals', JSON.stringify(App.State.fundamentalsData));
                },
                
                // Calcular score de fundamentos (0-100)
                calculateFundamentalsScore: (symbol) => {
                    const fund = App.State.fundamentalsData[symbol] || {};
                    let score = 50;
                    
                    // Market Cap (30%)
                    if (fund.marketCap > 10000000000) score += 30; // >$10B
                    else if (fund.marketCap > 1000000000) score += 20; // >$1B
                    else if (fund.marketCap > 100000000) score += 10; // >$100M
                    else if (fund.marketCap < 10000000) score -= 10; // <$10M
                    
                    // Volume/Market Cap ratio (20%)
                    if (fund.marketCap > 0) {
                        const volumeRatio = (fund.totalVolume || 0) / fund.marketCap;
                        if (volumeRatio > 0.1) score += 20; // Alta liquidez
                        else if (volumeRatio > 0.05) score += 10;
                        else if (volumeRatio < 0.01) score -= 10; // Baixa liquidez
                    }
                    
                    // FDV/Market Cap ratio (20%)
                    if (fund.marketCap > 0 && fund.fdv > 0) {
                        const fdvRatio = fund.fdv / fund.marketCap;
                        if (fdvRatio < 1.5) score += 20; // Baixa diluição futura
                        else if (fdvRatio < 3) score += 10;
                        else if (fdvRatio > 5) score -= 10; // Alta diluição
                    }
                    
                    // Inflação anual (30%)
                    if (fund.annualInflation !== undefined) {
                        if (fund.annualInflation < 2) score += 30; // Baixa inflação
                        else if (fund.annualInflation < 5) score += 20;
                        else if (fund.annualInflation < 10) score += 10;
                        else if (fund.annualInflation > 20) score -= 10; // Alta inflação
                    }
                    
                    return Math.max(0, Math.min(100, score));
                }
            },

            // 5. SCORE HOLDER 2.0 MODULE
            Score: {
                // Submódulo Valuation (0-100)
                calculateValuationScore: (symbol) => {
                    const historical = App.State.historicalData[symbol] || {};
                    const fund = App.State.fundamentalsData[symbol] || {};
                    const currentPrice = App.State.marketData[symbol.toLowerCase()]?.lastPrice || 0;
                    
                    let score = 50;
                    
                    // Desconto da média histórica (40%)
                    if (historical.avg2y && currentPrice > 0) {
                        const discount = ((historical.avg2y - currentPrice) / historical.avg2y) * 100;
                        if (discount > 40) score += 40;
                        else if (discount > 30) score += 30;
                        else if (discount > 20) score += 20;
                        else if (discount > 10) score += 10;
                        else if (discount < -20) score -= 20;
                        else if (discount < -10) score -= 10;
                    }
                    
                    // Desconto do ATH (30%)
                    if (fund.ath && currentPrice > 0) {
                        const athDiscount = ((fund.ath - currentPrice) / fund.ath) * 100;
                        if (athDiscount > 80) score += 30;
                        else if (athDiscount > 70) score += 20;
                        else if (athDiscount > 60) score += 10;
                        else if (athDiscount < 20) score -= 10;
                    }
                    
                    // Market Cap discount (30%)
                    if (fund.marketCap && fund.ath && fund.athChangePercentage) {
                        const mcapDiscount = Math.abs(fund.athChangePercentage);
                        if (mcapDiscount > 80) score += 30;
                        else if (mcapDiscount > 70) score += 20;
                        else if (mcapDiscount > 60) score += 10;
                    }
                    
                    return Math.max(0, Math.min(100, score));
                },
                
                // Submódulo Cycle (0-100)
                calculateCycleScore: (symbol) => {
                    const ind = App.State.indicatorsData[symbol.toLowerCase()] || {};
                    const weekly = ind["1w"] || {};
                    const monthly = ind["1m"] || {};
                    
                    let score = 50;
                    
                    // RSI Semanal (50%)
                    if (weekly.rsiWeekly) {
                        if (weekly.rsiWeekly < 30) score += 50;
                        else if (weekly.rsiWeekly < 40) score += 30;
                        else if (weekly.rsiWeekly < 50) score += 20;
                        else if (weekly.rsiWeekly > 70) score -= 20;
                        else if (weekly.rsiWeekly > 60) score -= 10;
                    }
                    
                    // RSI Mensal (30%)
                    if (monthly.rsiMonthly) {
                        if (monthly.rsiMonthly < 30) score += 30;
                        else if (monthly.rsiMonthly < 40) score += 20;
                        else if (monthly.rsiMonthly < 50) score += 10;
                        else if (monthly.rsiMonthly > 70) score -= 10;
                    }
                    
                    // Posição no ciclo (20%)
                    const historical = App.State.historicalData[symbol] || {};
                    if (historical.currentPercentile !== undefined) {
                        if (historical.currentPercentile < 30) score += 20;
                        else if (historical.currentPercentile < 50) score += 10;
                        else if (historical.currentPercentile > 80) score -= 10;
                    }
                    
                    return Math.max(0, Math.min(100, score));
                },
                
                // Submódulo Fundamentals (0-100)
                calculateFundamentalsScore: (symbol) => {
                    return App.Fundamentals.calculateFundamentalsScore(symbol);
                },
                
                // Submódulo Technical (0-100)
                calculateTechnicalScore: (symbol) => {
                    const ind = App.State.indicatorsData[symbol.toLowerCase()]?.["1d"] || {};
                    const currentPrice = App.State.marketData[symbol.toLowerCase()]?.lastPrice || 0;
                    
                    let score = 50;
                    
                    // Posição vs SMA200 (60%)
                    if (ind.sma200 && currentPrice > 0) {
                        const smaDistance = ((currentPrice - ind.sma200) / ind.sma200) * 100;
                        if (smaDistance < -20) score += 60; // Muito abaixo, bom para acumular
                        else if (smaDistance < -10) score += 40;
                        else if (smaDistance < 0) score += 20;
                        else if (smaDistance > 30) score -= 20; // Muito acima
                        else if (smaDistance > 20) score -= 10;
                    }
                    
                    // Volatilidade (40%)
                    if (ind.volatility) {
                        if (ind.volatility < 0.7) score += 40; // Baixa volatilidade
                        else if (ind.volatility < 1.2) score += 20;
                        else if (ind.volatility > 2.0) score -= 20; // Alta volatilidade
                    }
                    
                    return Math.max(0, Math.min(100, score));
                },
                
                // Calcular Score HOLDER 2.0 completo
                calculate: (symbol) => {
                    const valuation = App.Score.calculateValuationScore(symbol) * HOLDER_CONFIG.fundamentalsWeight.valuation;
                    const cycle = App.Score.calculateCycleScore(symbol) * HOLDER_CONFIG.fundamentalsWeight.cycle;
                    const fundamentals = App.Score.calculateFundamentalsScore(symbol) * HOLDER_CONFIG.fundamentalsWeight.fundamentals;
                    const technical = App.Score.calculateTechnicalScore(symbol) * HOLDER_CONFIG.fundamentalsWeight.technical;
                    
                    const totalScore = Math.round(valuation + cycle + fundamentals + technical);
                    
                    if (!App.State.scoreData[symbol]) {
                        App.State.scoreData[symbol] = {};
                    }
                    
                    App.State.scoreData[symbol] = {
                        total: totalScore,
                        valuation: Math.round(valuation / HOLDER_CONFIG.fundamentalsWeight.valuation),
                        cycle: Math.round(cycle / HOLDER_CONFIG.fundamentalsWeight.cycle),
                        fundamentals: Math.round(fundamentals / HOLDER_CONFIG.fundamentalsWeight.fundamentals),
                        technical: Math.round(technical / HOLDER_CONFIG.fundamentalsWeight.technical),
                        timestamp: Date.now()
                    };
                    
                    return totalScore;
                },
                
                // Gerar análise automática
                generateAnalysis: (symbol) => {
                    const score = App.State.scoreData[symbol]?.total || 50;
                    const ind = App.State.indicatorsData[symbol.toLowerCase()]?.["1d"] || {};
                    const fund = App.State.fundamentalsData[symbol] || {};
                    const currentPrice = App.State.marketData[symbol.toLowerCase()]?.lastPrice || 0;
                    
                    // Determinar fase
                    let phase, recommendation, horizon, confidence;
                    let asymmetry = 0;
                    let probability = 0;
                    
                    if (score >= 70) {
                        phase = "Acumulação Agressiva";
                        recommendation = "Acumular (DCA)";
                        horizon = "2-3 anos";
                        confidence = "Alta";
                        asymmetry = 3 + (score - 70) / 10; // 3.0 - 6.0
                        probability = 70 + (score - 70) / 2; // 70% - 85%
                    } else if (score >= 40) {
                        phase = "Manter Posição";
                        recommendation = "Manter/Rebalancear";
                        horizon = "1-2 anos";
                        confidence = "Moderada";
                        asymmetry = 2 + (score - 40) / 30; // 2.0 - 3.0
                        probability = 50 + (score - 40); // 50% - 70%
                    } else {
                        phase = "Realizar Lucros";
                        recommendation = "Realizar Parcialmente";
                        horizon = "6-12 meses";
                        confidence = "Baixa";
                        asymmetry = 1 + (score / 40); // 1.0 - 2.0
                        probability = 30 + score; // 30% - 50%
                    }
                    
                    // Calcular alvos
                    const target1y = currentPrice * (1 + (score / 100));
                    const target2y = currentPrice * (1 + (score / 50));
                    const target3y = currentPrice * (1 + (score / 33));
                    
                    return {
                        phase,
                        recommendation,
                        horizon,
                        confidence,
                        asymmetry: asymmetry.toFixed(1),
                        probability: Math.min(95, probability).toFixed(0),
                        target1y: target1y.toFixed(2),
                        target2y: target2y.toFixed(2),
                        target3y: target3y.toFixed(2)
                    };
                }
            },

            // 6. OPPORTUNITIES MODULE
            Opportunities: {
                // Gerar lista de oportunidades
                generate: () => {
                    const opportunities = [];
                    
                    // Para cada token, calcular dados
                    App.State.tokens.forEach(token => {
                        const symbol = token.symbol;
                        const s = symbol.toLowerCase();
                        const ind = App.State.indicatorsData[s]?.["1d"] || {};
                        const fund = App.State.fundamentalsData[symbol] || {};
                        const score = App.State.scoreData[symbol] || { total: 50 };
                        const analysis = App.Score.generateAnalysis(symbol);
                        const currentPrice = App.State.marketData[s]?.lastPrice || 0;
                        
                        // Filtrar por market cap mínimo
                        if (fund.marketCap < App.State.settings.minMarketCap) return;
                        
                        opportunities.push({
                            symbol: symbol,
                            name: token.name,
                            price: currentPrice,
                            score: score.total,
                            phase: ind.holderPhase || 'holding',
                            zone: ind.zone?.zone || '--',
                            percentile: ind.historicalPercentile || 50,
                            asymmetry: analysis.asymmetry,
                            probability: analysis.probability,
                            horizon: analysis.horizon,
                            marketCap: fund.marketCap || 0,
                            mcapDiscount: fund.athChangePercentage ? Math.abs(fund.athChangePercentage).toFixed(1) : '--'
                        });
                    });
                    
                    // Ordenar por score (maior primeiro)
                    opportunities.sort((a, b) => b.score - a.score);
                    
                    // Limitar a 10 melhores
                    App.State.opportunities = opportunities.slice(0, 10);
                    
                    // Renderizar
                    App.Opportunities.render();
                },
                
                // Renderizar tabela de oportunidades
                render: () => {
                    const tbody = document.getElementById('opportunities-body');
                    if (!tbody) return;
                    
                    tbody.innerHTML = '';
                    
                    App.State.opportunities.forEach((item, index) => {
                        const zoneColor = item.zone === '0-20%' ? 'text-zone-agressive' :
                                         item.zone === '20-40%' ? 'text-zone-moderate' :
                                         item.zone === '40-60%' ? 'text-zone-fair' :
                                         item.zone === '60-80%' ? 'text-zone-partial' : 'text-zone-full';
                        
                        const phaseColor = item.phase === 'accumulation' ? 'text-green-400' : 
                                          item.phase === 'profit_taking' ? 'text-red-400' : 'text-blue-400';
                        
                        const scoreColor = item.score > 70 ? 'text-green-400' : 
                                          item.score < 40 ? 'text-red-400' : 'text-blue-400';
                        
                        tbody.innerHTML += `
                            <tr class="table-row-hover border-b border-gray-800 cursor-pointer hover:bg-dark-800/50" onclick="App.UI.toggleCard(document.querySelector('.card[data-symbol=${item.symbol}]'))">
                                <td class="p-2 text-center text-gray-500 font-bold">${index + 1}</td>
                                <td class="p-2 font-bold text-white">
                                    <div>${item.symbol.replace('USDT', '')}</div>
                                    <div class="text-[10px] text-gray-500">${item.name}</div>
                                </td>
                                <td class="p-2 text-center font-bold ${scoreColor}">${item.score}</td>
                                <td class="p-2 text-center font-bold ${phaseColor}">${item.phase === 'accumulation' ? 'Acumular' : item.phase === 'profit_taking' ? 'Realizar' : 'Manter'}</td>
                                <td class="p-2 text-center font-bold ${zoneColor}">${item.zone}</td>
                                <td class="p-2 text-center font-mono text-white">$${item.price.toFixed(2)}</td>
                                <td class="p-2 text-center font-mono ${item.asymmetry > 2 ? 'text-green-400' : 'text-yellow-400'}">${item.asymmetry}:1</td>
                                <td class="p-2 text-center font-mono ${parseInt(item.probability) > 70 ? 'text-green-400' : parseInt(item.probability) > 50 ? 'text-blue-400' : 'text-yellow-400'}">${item.probability}%</td>
                                <td class="p-2 text-center text-gray-400">${item.horizon}</td>
                                <td class="p-2 text-center">
                                    <button onclick="event.stopPropagation(); App.Alerts.openForSymbol('${item.symbol}')" class="text-holder-accumulation hover:text-green-300 p-1 text-xs">
                                        <i class="fa-solid fa-bell"></i>
                                    </button>
                                </td>
                            </tr>`;
                    });
                    
                    // Atualizar outras tabelas
                    App.Opportunities.updateZoneTables();
                },
                
                // Atualizar tabelas por zona
                updateZoneTables: () => {
                    // Agressiva (0-20%)
                    const agressive = App.State.opportunities.filter(x => x.zone === '0-20%');
                    App.UI.renderTable('list-agressive', agressive.slice(0, 5),
                        x => x.symbol.replace('USDT', ''),
                        x => x.zone,
                        x => `${x.asymmetry}:1`);
                    
                    // Justo (40-60%)
                    const fair = App.State.opportunities.filter(x => x.zone === '40-60%');
                    App.UI.renderTable('list-fair', fair.slice(0, 5),
                        x => x.symbol.replace('USDT', ''),
                        x => x.zone,
                        x => x.phase === 'accumulation' ? 'Acumular' : x.phase === 'profit_taking' ? 'Realizar' : 'Manter');
                    
                    // Total (80-100%)
                    const full = App.State.opportunities.filter(x => x.zone === '80-100%');
                    App.UI.renderTable('list-full', full.slice(0, 5),
                        x => x.symbol.replace('USDT', ''),
                        x => x.zone,
                        x => `+${(100 - x.percentile).toFixed(0)}%`);
                }
            },

            // 7. UI HOLDER
            UI: {
                tooltips: () => {
                    const ov = document.getElementById('metric-tooltip-overlay');
                    const show = (t) => {
                        let d = App.Library[t.dataset.tip];
                        if(!d) {
                            // Tentar tooltip curta
                            const shortTip = App.Library[t.dataset.tip + '_short'];
                            if (shortTip) {
                                ov.innerHTML = `
                                    <div class="flex-1 min-w-[280px]">
                                        <h4 class="text-holder-accumulation font-bold text-lg mb-3">${t.dataset.tip.replace('_', ' ').toUpperCase()}</h4>
                                        <p class="text-sm text-gray-300 leading-relaxed text-justify">${shortTip}</p>
                                    </div>`;
                            } else {
                                return;
                            }
                        } else {
                            ov.innerHTML = `
                                <div class="flex-1 min-w-[280px] lg:border-r border-gray-800 lg:pr-6">
                                    <h4 class="text-holder-accumulation font-bold text-lg mb-3">${d.title}</h4>
                                    <p class="text-sm text-gray-300 leading-relaxed text-justify">${d.what}</p>
                                </div>
                                <div class="flex-1 min-w-[280px] lg:border-r border-gray-800 lg:pr-6 lg:pl-6">
                                    <div class="mb-3">
                                        <div class="tip-label">Interpretação</div>
                                        <p class="tip-val text-justify">${d.interp||'-'}</p>
                                    </div>
                                    ${d.example ? `<div class="mt-3"><div class="tip-label">Exemplo</div><p class="tip-val">${d.example}</p></div>` : ''}
                                </div>
                                <div class="flex-1 min-w-[250px] lg:pl-6">
                                    <div class="bg-holder-accumulation/20 border border-holder-accumulation/30 p-4 rounded-lg shadow-inner">
                                        <div class="tip-label text-holder-accumulation">Dica HOLDER</div>
                                        <p class="text-xs text-green-100 italic leading-relaxed">"${d.tip||''}"</p>
                                    </div>
                                </div>`;
                        }
                        
                        ov.classList.remove('tooltip-hidden'); 
                        ov.classList.add('tooltip-visible');
                    };
                    
                    const hide = () => { 
                        ov.classList.remove('tooltip-visible'); 
                        ov.classList.add('tooltip-hidden'); 
                    };
                    
                    document.body.addEventListener('click', (e) => { 
                        let t = e.target.closest('[data-tip]'); 
                        if(t){ show(t); e.stopPropagation(); } 
                        else if(!e.target.closest('#metric-tooltip-overlay')) hide(); 
                    });
                },
                
                renderTable: (id, data, col1Fn, col2Fn, col3Fn) => {
                    const tbody = document.getElementById(id);
                    if (!tbody) return;
                    
                    tbody.innerHTML = data.map(item => `
                        <tr class="hover:bg-white/5 cursor-pointer transition-colors border-b border-gray-800/50" 
                            onclick="App.UI.toggleCard(document.querySelector('.card[data-symbol=${item.symbol}]'))">
                            <td class="p-2 font-bold text-white">${col1Fn(item)}</td>
                            <td class="p-2 text-center font-mono text-gray-400">${col2Fn(item)}</td>
                            <td class="p-2 text-right font-mono ${item.score > 70 ? 'text-green-400' : item.score < 40 ? 'text-red-400' : 'text-blue-400'}">${col3Fn(item)}</td>
                        </tr>
                    `).join('');
                },
                
                grid: () => {
                    let g = document.getElementById('cards-grid');
                    g.innerHTML='';
                    App.State.tokens.forEach(token => {
                        let el = document.getElementById('card-template').content.cloneNode(true).querySelector('.card');
                        el.dataset.symbol = token.symbol;
                        el.querySelector('.symbol-ticker').innerText = token.symbol.replace('USDT','');
                        el.querySelector('.symbol-name').innerText = token.name;
                        el.querySelector('.btn-remove').onclick = (e)=>{e.stopPropagation(); App.Token.rem(token.symbol)};
                        g.appendChild(el);
                        App.UI.updateTokenCard(token.symbol);
                        App.Alerts.renderInCard(token.symbol);
                    });
                },
                
                formatColor: (val) => val > 0 ? 'text-green-400' : val < 0 ? 'text-red-400' : 'text-gray-400',
                
                updateAllCards: () => {
                    App.State.tokens.forEach(token => {
                        App.UI.updateTokenCard(token.symbol);
                    });
                },
                
                updateTokenCard: async (symbol) => {
                    const card = document.querySelector(`.card[data-symbol="${symbol}"]`);
                    if(!card) return;
                    
                    const s = symbol.toLowerCase();
                    const token = App.State.tokens.find(t => t.symbol === symbol);
                    
                    // Buscar preço atual se não existir
                    if (!App.State.marketData[s]?.lastPrice) {
                        const price = await App.Core.fetchCurrentPrice(symbol);
                        App.State.marketData[s] = { lastPrice: price };
                    }
                    
                    const m = App.State.marketData[s];
                    const i = App.State.indicatorsData[s]?.["1d"];
                    const fund = App.State.fundamentalsData[symbol];
                    const historical = App.State.historicalData[symbol];
                    const score = App.State.scoreData[symbol];
                    const analysis = App.Score.generateAnalysis(symbol);
                    
                    if(m && m.lastPrice) {
                        card.querySelector('.price-display').innerText = '$' + m.lastPrice.toFixed(2);
                        
                        // Atualizar variações
                        const updateVar = async (sel, period) => {
                            const change = await App.Core.calculatePriceChange(symbol, period);
                            const el = card.querySelector(sel);
                            if (el) {
                                el.innerText = (change > 0 ? '+' : '') + change.toFixed(2) + '%';
                                el.className = `text-[10px] font-bold font-mono ${App.UI.formatColor(change)}`;
                            }
                        };
                        
                        // Atualizar todas as variações
                        updateVar('.val-1h', '1h');
                        updateVar('.val-24h', '24h');
                        updateVar('.val-7d', '7d');
                        updateVar('.val-30d', '30d');
                        
                        // Atualizar market cap
                        if (fund?.marketCap) {
                            const mcapText = fund.marketCap > 1000000000 ? `$${(fund.marketCap / 1000000000).toFixed(1)}B` :
                                            fund.marketCap > 1000000 ? `$${(fund.marketCap / 1000000).toFixed(1)}M` :
                                            `$${(fund.marketCap / 1000).toFixed(1)}K`;
                            card.querySelector('.market-cap-value').innerText = mcapText;
                        }
                    }
                    
                    if(i) {
                        // Atualizar métricas principais
                        card.querySelector('.metric-sma200').innerText = i.sma200 ? `$${i.sma200.toFixed(2)}` : '--';
                        card.querySelector('.metric-historical').innerText = i.historicalPercentile ? `${i.historicalPercentile.toFixed(0)}%` : '--';
                        
                        // RSI Semanal
                        const rsiWeekly = App.State.indicatorsData[s]?.["1w"]?.rsiWeekly;
                        const rsiWeeklyEl = card.querySelector('.metric-rsi-weekly');
                        if (rsiWeekly) {
                            rsiWeeklyEl.innerText = rsiWeekly.toFixed(0);
                            if (rsiWeekly < 30) {
                                rsiWeeklyEl.className = 'metric-rsi-weekly text-rsi-oversold';
                            } else if (rsiWeekly > 70) {
                                rsiWeeklyEl.className = 'metric-rsi-weekly text-rsi-overbought';
                            } else {
                                rsiWeeklyEl.className = 'metric-rsi-weekly text-rsi-neutral';
                            }
                        }
                        
                        // Atualizar fase e zona
                        const phaseText = i.holderPhase === 'accumulation' ? 'ACUMULAR' : 
                                         i.holderPhase === 'profit_taking' ? 'REALIZAR' : 'MANTER';
                        const phaseColor = i.holderPhase === 'accumulation' ? 'bg-green-900 text-green-400' : 
                                          i.holderPhase === 'profit_taking' ? 'bg-red-900 text-red-400' : 'bg-blue-900 text-blue-400';
                        
                        card.querySelector('.phase-badge').innerText = `Fase: ${phaseText}`;
                        card.querySelector('.phase-badge').className = `phase-badge text-[8px] font-bold uppercase px-1.5 py-0.5 rounded ${phaseColor} mt-1 inline-block cursor-help`;
                        
                        // Zona
                        if (i.zone) {
                            const zoneColor = i.zone.zone === '0-20%' ? 'bg-zone-agressive/20 text-zone-agressive' :
                                            i.zone.zone === '20-40%' ? 'bg-zone-moderate/20 text-zone-moderate' :
                                            i.zone.zone === '40-60%' ? 'bg-zone-fair/20 text-zone-fair' :
                                            i.zone.zone === '60-80%' ? 'bg-zone-partial/20 text-zone-partial' :
                                            'bg-zone-full/20 text-zone-full';
                            
                            card.querySelector('.zone-badge').innerText = `Zona: ${i.zone.zone}`;
                            card.querySelector('.zone-badge').className = `zone-badge text-[8px] font-bold uppercase px-1.5 py-0.5 rounded ${zoneColor} inline-block cursor-help`;
                        }
                        
                        // Atualizar classe do card baseado na fase
                        card.classList.remove('holder-phase-accumulation', 'holder-phase-holding', 'holder-phase-profit');
                        card.classList.add(`holder-phase-${i.holderPhase}`);
                        
                        // Score Holder
                        const totalScore = score?.total || 50;
                        const scoreBadge = card.querySelector('.score-badge');
                        scoreBadge.innerText = totalScore.toFixed(0);
                        scoreBadge.className = `score-badge w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold text-black border border-white shadow-sm cursor-help ${totalScore>70?'bg-score-high':totalScore<40?'bg-score-low':'bg-score-mid'}`;
                        
                        // Atualizar posição histórica
                        const historicalIndicator = card.querySelector('.historical-indicator');
                        const historicalPosition = card.querySelector('.historical-position');
                        if (historicalIndicator && historicalPosition && i.historicalPercentile) {
                            historicalIndicator.style.left = `${i.historicalPercentile}%`;
                            historicalPosition.innerText = i.historicalPercentile.toFixed(0);
                        }
                        
                        // Atualizar valuation e fundamentos
                        if (fund) {
                            // Formatar valores
                            const formatBillions = (val) => val > 1000000000 ? `$${(val / 1000000000).toFixed(1)}B` : `$${(val / 1000000).toFixed(1)}M`;
                            
                            card.querySelector('.val-mcap').innerText = formatBillions(fund.marketCap || 0);
                            card.querySelector('.val-fdv').innerText = fund.fdv ? formatBillions(fund.fdv) : '--';
                            card.querySelector('.val-mcap-ath').innerText = fund.ath ? formatBillions(fund.ath) : '--';
                            
                            // Desconto do ATH
                            if (fund.ath && m.lastPrice) {
                                const discount = ((fund.ath - m.lastPrice) / fund.ath) * 100;
                                card.querySelector('.val-mcap-discount').innerText = `${discount.toFixed(1)}%`;
                                card.querySelector('.val-mcap-discount').className = `val-mcap-discount ${discount > 50 ? 'text-green-400' : discount > 30 ? 'text-yellow-400' : 'text-red-400'}`;
                            }
                            
                            // Inflação
                            if (fund.annualInflation !== undefined) {
                                card.querySelector('.val-inflation').innerText = `${fund.annualInflation.toFixed(1)}%`;
                                card.querySelector('.val-inflation').className = `val-inflation ${fund.annualInflation < 5 ? 'text-green-400' : fund.annualInflation < 10 ? 'text-yellow-400' : 'text-red-400'}`;
                            }
                        }
                        
                        // Atualizar zonas de preço
                        if (historical?.priceZones) {
                            card.querySelector('.zone-agg').innerText = `$${historical.priceZones.zone0_20.toFixed(2)}`;
                            card.querySelector('.zone-mod').innerText = `$${historical.priceZones.zone20_40.toFixed(2)}`;
                            card.querySelector('.zone-fair').innerText = `$${historical.priceZones.zone40_60.toFixed(2)}`;
                            card.querySelector('.zone-partial').innerText = `$${historical.priceZones.zone60_80.toFixed(2)}`;
                            card.querySelector('.zone-full').innerText = `$${historical.priceZones.zone80_100.toFixed(2)}`;
                        }
                        
                        // Atualizar momentum
                        const rsiWeeklyValue = App.State.indicatorsData[s]?.["1w"]?.rsiWeekly;
                        const rsiMonthlyValue = App.State.indicatorsData[s]?.["1m"]?.rsiMonthly;
                        
                        if (rsiWeeklyValue) {
                            card.querySelector('.rsi-weekly-value').innerText = rsiWeeklyValue.toFixed(2);
                            card.querySelector('.rsi-weekly-value').className = `rsi-weekly-value ${rsiWeeklyValue < 30 ? 'text-rsi-oversold' : rsiWeeklyValue > 70 ? 'text-rsi-overbought' : 'text-rsi-neutral'}`;
                            
                            card.querySelector('.rsi-interpretation').innerText = App.Indicators.interpretRSI(rsiWeeklyValue);
                        }
                        
                        if (rsiMonthlyValue) {
                            card.querySelector('.rsi-monthly-value').innerText = rsiMonthlyValue.toFixed(2);
                            card.querySelector('.rsi-monthly-value').className = `rsi-monthly-value ${rsiMonthlyValue < 30 ? 'text-rsi-oversold' : rsiMonthlyValue > 70 ? 'text-rsi-overbought' : 'text-rsi-neutral'}`;
                        }
                        
                        // Atualizar análise holder
                        if (analysis) {
                            const analysisContent = card.querySelector('.analysis-holder-content');
                            if (analysisContent) {
                                analysisContent.innerHTML = `
                                    <div class="flex justify-between">
                                        <span class="cursor-help" data-tip="analysis_score">Score HOLDER 2.0:</span>
                                        <span class="analysis-score font-bold ${totalScore > 70 ? 'text-green-400' : totalScore < 40 ? 'text-red-400' : 'text-blue-400'}">${totalScore}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="cursor-help" data-tip="analysis_phase">Fase do Ciclo:</span>
                                        <span class="analysis-phase ${phaseColor.split(' ')[1]}">${analysis.phase}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="cursor-help" data-tip="analysis_recommendation">Recomendação:</span>
                                        <span class="analysis-recommendation ${i.holderPhase === 'accumulation' ? 'text-green-400' : i.holderPhase === 'profit_taking' ? 'text-red-400' : 'text-blue-400'}">${analysis.recommendation}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="cursor-help" data-tip="analysis_horizon">Horizonte Ideal:</span>
                                        <span class="analysis-horizon">${analysis.horizon}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="cursor-help" data-tip="analysis_asymmetry">Assimetria:</span>
                                        <span class="analysis-asymmetry ${analysis.asymmetry > 2 ? 'text-green-400' : 'text-yellow-400'}">${analysis.asymmetry}:1</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="cursor-help" data-tip="analysis_probability">Prob. Retorno (3 anos):</span>
                                        <span class="analysis-probability ${parseInt(analysis.probability) > 70 ? 'text-green-400' : parseInt(analysis.probability) > 50 ? 'text-blue-400' : 'text-yellow-400'}">${analysis.probability}%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="cursor-help" data-tip="analysis_confidence">Confiança:</span>
                                        <span class="analysis-confidence ${analysis.confidence === 'Alta' ? 'text-green-400' : analysis.confidence === 'Moderada' ? 'text-blue-400' : 'text-yellow-400'}">${analysis.confidence}</span>
                                    </div>
                                `;
                            }
                            
                            // Atualizar alvos
                            card.querySelector('.target-1y').innerText = `$${analysis.target1y}`;
                            card.querySelector('.target-2y').innerText = `$${analysis.target2y}`;
                            card.querySelector('.target-3y').innerText = `$${analysis.target3y}`;
                        }
                    }
                    
                    // Adicionar gráfico se o card estiver expandido
                    if (!card.querySelector('.card-body').classList.contains('hidden')) {
                        App.UI.updateChart(card);
                    }
                },
                
                updateChart: (card) => {
                    const sym = card.dataset.symbol;
                    const c = card.querySelector('.chart-container');
                    if (!c || c.querySelector('canvas')) return;
                    
                    c.innerHTML='';
                    
                    let chart = LightweightCharts.createChart(c, {
                        layout:{background:{color:'#000000'},textColor:'#6b7280'},
                        grid:{vertLines:{color:'#1f2937'},horzLines:{color:'#1f2937'}},
                        timeScale:{timeVisible:true, secondsVisible:false}
                    });
                    
                    let s = chart.addCandlestickSeries({upColor:'#10b981',downColor:'#ef4444'});
                    let d = App.Core.getOHLC(sym, "1w");
                    s.setData(d.map(x=>({time:x.time/1000,open:x.open,high:x.high,low:x.low,close:x.close})));
                    
                    // Adicionar SMA200
                    let smaLine = chart.addLineSeries({
                        color: '#3b82f6',
                        lineWidth: 2,
                        lineStyle: 0
                    });
                    
                    const closes = d.map(x => x.close);
                    const sma200Data = [];
                    for (let i = 0; i < closes.length; i++) {
                        if (i >= 199) {
                            const sma = closes.slice(i-199, i+1).reduce((a,b) => a + b, 0) / 200;
                            sma200Data.push({time: d[i].time/1000, value: sma});
                        }
                    }
                    smaLine.setData(sma200Data);
                    
                    chart.timeScale().fitContent();
                },
                
                toggleCard: (el) => {
                    let card = el.closest('.card');
                    if(!card) return;
                    
                    let b = card.querySelector('.card-body');
                    if(b.classList.contains('hidden')) {
                        document.querySelectorAll('.card-body').forEach(e=>e.classList.add('hidden'));
                        b.classList.remove('hidden');
                        card.scrollIntoView({behavior:'smooth',block:'center'});
                        
                        // Atualizar gráfico
                        App.UI.updateChart(card);
                    } else {
                        b.classList.add('hidden');
                    }
                }
            },

            // 8. ALERTAS HOLDER (mantido da versão anterior)
            Alerts: {
                saveToStorage: () => localStorage.setItem("holder_alerts", JSON.stringify(App.State.alerts)),
                
                openModal: (btn = null) => {
                    const modal = document.getElementById('alertsModal');
                    const symbolSelect = document.getElementById('alert-symbol');
                    
                    symbolSelect.innerHTML = '<option value="">Selecione um ativo</option>';
                    App.State.tokens.forEach(token => {
                        const option = document.createElement('option');
                        option.value = token.symbol;
                        option.textContent = `${token.name} (${token.symbol.replace('USDT', '')})`;
                        symbolSelect.appendChild(option);
                    });
                    
                    if (btn) {
                        const card = btn.closest('.card');
                        const symbol = card.dataset.symbol;
                        if (symbol) {
                            symbolSelect.value = symbol;
                        }
                    }
                    
                    document.getElementById('alert-price').value = '';
                    document.getElementById('alert-notes').value = '';
                    
                    modal.classList.remove('hidden');
                },
                
                openForSymbol: (symbol) => {
                    App.Alerts.openModal();
                    document.getElementById('alert-symbol').value = symbol;
                },
                
                closeModal: () => {
                    document.getElementById('alertsModal').classList.add('hidden');
                },
                
                createAlert: () => {
                    const symbol = document.getElementById('alert-symbol').value;
                    const type = document.getElementById('alert-type').value;
                    const price = parseFloat(document.getElementById('alert-price').value);
                    const metric = document.getElementById('alert-metric').value;
                    const notes = document.getElementById('alert-notes').value;
                    
                    if (!symbol || !price || isNaN(price)) {
                        alert('Preencha ativo e preço alvo válido!');
                        return;
                    }
                    
                    const currentPrice = App.State.marketData[symbol.toLowerCase()]?.lastPrice || 0;
                    const percent = currentPrice ? ((price - currentPrice) / currentPrice) * 100 : 0;
                    
                    const alert = {
                        id: Date.now(),
                        symbol: symbol.toUpperCase(),
                        type,
                        targetPrice: price,
                        metric,
                        currentPrice,
                        percent,
                        notes,
                        createdAt: new Date().toLocaleString(),
                        triggered: false,
                        triggeredAt: null,
                        actualPrice: null
                    };
                    
                    App.State.alerts.push(alert);
                    App.Alerts.saveToStorage();
                    App.Alerts.renderAlertsPanel();
                    App.Alerts.closeModal();
                    
                    App.Alerts.renderInCard(symbol);
                },
                
                openForCard: (btn) => {
                    App.Alerts.openModal(btn);
                },
                
                checkAlerts: (symbol, currentPrice) => {
                    if (!symbol || !currentPrice) return;
                    
                    const symbolUpper = symbol.toUpperCase();
                    let triggeredAny = false;
                    
                    App.State.alerts.forEach(alert => {
                        if (alert.symbol === symbolUpper && !alert.triggered) {
                            let shouldTrigger = false;
                            
                            if (alert.type === 'dca_buy' && currentPrice <= alert.targetPrice) {
                                shouldTrigger = true;
                            } else if (alert.type === 'profit_take' && currentPrice >= alert.targetPrice) {
                                shouldTrigger = true;
                            }
                            
                            if (shouldTrigger) {
                                alert.triggered = true;
                                alert.triggeredAt = new Date().toLocaleString();
                                alert.actualPrice = currentPrice;
                                triggeredAny = true;
                                
                                App.Alerts.showNotification(alert);
                            }
                        }
                    });
                    
                    if (triggeredAny) {
                        App.Alerts.saveToStorage();
                        App.Alerts.renderAlertsPanel();
                        App.Alerts.renderInCard(symbolUpper);
                    }
                },
                
                showNotification: (alert) => {
                    const notification = document.createElement('div');
                    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                        alert.type === 'dca_buy' ? 'bg-green-900 border-green-500' : 'bg-orange-900 border-orange-500'
                    } border`;
                    
                    notification.innerHTML = `
                        <div class="flex items-center gap-3">
                            <i class="fa-solid ${alert.type === 'dca_buy' ? 'fa-arrow-down text-green-400' : 'fa-arrow-up text-orange-400'}"></i>
                            <div>
                                <strong class="text-white">${alert.symbol.replace('USDT', '')}</strong>
                                <div class="text-sm ${alert.type === 'dca_buy' ? 'text-green-300' : 'text-orange-300'}">
                                    ${alert.type === 'dca_buy' ? 'DCA: Comprar a' : 'Realizar: Vender a'} $${alert.targetPrice.toFixed(2)}
                                </div>
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-white">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 10000);
                },
                
                remove: (id) => {
                    App.State.alerts = App.State.alerts.filter(alert => alert.id !== id);
                    App.Alerts.saveToStorage();
                    App.Alerts.renderAlertsPanel();
                    
                    App.State.tokens.forEach(token => {
                        App.Alerts.renderInCard(token.symbol);
                    });
                },
                
                calculateRemainingPercent: (alert) => {
                    const currentPrice = App.State.marketData[alert.symbol.toLowerCase()]?.lastPrice || alert.currentPrice;
                    if (!currentPrice) return alert.percent;
                    
                    const remainingPercent = ((alert.targetPrice - currentPrice) / currentPrice) * 100;
                    return Math.abs(remainingPercent);
                },
                
                getAlertColorClass: (alert) => {
                    if (alert.triggered) {
                        return 'bg-green-900/20 border-green-500';
                    }
                    
                    const remainingPercent = App.Alerts.calculateRemainingPercent(alert);
                    if (remainingPercent <= 5) {
                        return 'bg-yellow-900/20 border-yellow-500';
                    } else {
                        return 'bg-red-900/20 border-red-500';
                    }
                },
                
                renderAlertsPanel: () => {
                    const container = document.getElementById('alertsContent');
                    
                    if (App.State.alerts.length === 0) {
                        container.innerHTML = '<div class="text-gray-500 text-center py-4 text-sm">Configure alertas DCA para acumulação inteligente</div>';
                        return;
                    }
                    
                    const sortedAlerts = [...App.State.alerts].sort((a, b) => {
                        const aRemaining = App.Alerts.calculateRemainingPercent(a);
                        const bRemaining = App.Alerts.calculateRemainingPercent(b);
                        return aRemaining - bRemaining;
                    });
                    
                    container.innerHTML = '';
                    sortedAlerts.forEach(alert => {
                        const currentPrice = App.State.marketData[alert.symbol.toLowerCase()]?.lastPrice || alert.currentPrice;
                        const remainingPercent = App.Alerts.calculateRemainingPercent(alert);
                        const isDCA = alert.type === 'dca_buy';
                        
                        const colorClass = App.Alerts.getAlertColorClass(alert);
                        const textColor = alert.triggered ? 'text-green-400' : 
                                         remainingPercent <= 5 ? 'text-yellow-400' : 'text-red-400';
                        
                        const alertEl = document.createElement('div');
                        alertEl.className = `p-3 rounded border mb-2 ${colorClass}`;
                        
                        alertEl.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <strong class="${textColor}">${alert.symbol.replace('USDT', '')}</strong>
                                    <span class="text-xs ${isDCA ? 'text-green-500' : 'text-orange-500'} ml-2">${isDCA ? 'DCA' : 'REALIZAR'}</span>
                                    ${alert.triggered ? '<span class="text-xs text-green-300 ml-2">✓ ATINGIDO</span>' : ''}
                                </div>
                                <button onclick="App.Alerts.remove(${alert.id})" class="text-gray-500 hover:text-red-500 text-xs">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                            </div>
                            <div class="mt-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Alvo:</span>
                                    <span class="text-white">$${alert.targetPrice.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Atual:</span>
                                    <span class="text-white">$${currentPrice.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">${alert.triggered ? 'Atingido em:' : 'Falta:'}</span>
                                    <span class="${textColor}">
                                        ${alert.triggered ? 
                                            alert.triggeredAt.split(' ')[0] : 
                                            remainingPercent.toFixed(1) + '%'
                                        }
                                    </span>
                                </div>
                                ${alert.notes ? `<div class="mt-1 text-xs text-gray-500">${alert.notes}</div>` : ''}
                            </div>
                        `;
                        
                        container.appendChild(alertEl);
                    });
                },
                
                renderInCard: (symbol) => {
                    const card = document.querySelector(`.card[data-symbol="${symbol}"]`);
                    if (!card) return;
                    
                    const alertList = card.querySelector('.alert-list');
                    const alerts = App.State.alerts.filter(alert => alert.symbol === symbol);
                    
                    if (alerts.length === 0) {
                        alertList.innerHTML = '<div class="text-gray-500 text-center py-2 text-xs">Sem alertas DCA</div>';
                        return;
                    }
                    
                    const sortedAlerts = [...alerts].sort((a, b) => {
                        const aRemaining = App.Alerts.calculateRemainingPercent(a);
                        const bRemaining = App.Alerts.calculateRemainingPercent(b);
                        return aRemaining - bRemaining;
                    });
                    
                    alertList.innerHTML = '';
                    sortedAlerts.forEach(alert => {
                        const currentPrice = App.State.marketData[symbol.toLowerCase()]?.lastPrice || alert.currentPrice;
                        const remainingPercent = App.Alerts.calculateRemainingPercent(alert);
                        const isDCA = alert.type === 'dca_buy';
                        
                        let bgColor = 'bg-red-900/30', borderColor = 'border-red-700/30', textColor = 'text-red-400';
                        
                        if (alert.triggered) {
                            bgColor = 'bg-green-900/30';
                            borderColor = 'border-green-700/30';
                            textColor = 'text-green-400';
                        } else if (remainingPercent <= 5) {
                            bgColor = 'bg-yellow-900/30';
                            borderColor = 'border-yellow-700/30';
                            textColor = 'text-yellow-400';
                        }
                        
                        const alertEl = document.createElement('div');
                        alertEl.className = `flex justify-between items-center p-1 rounded text-xs ${bgColor} ${borderColor} border mb-1`;
                        alertEl.innerHTML = `
                            <span class="${textColor} font-bold">${isDCA ? 'D' : 'R'}</span>
                            <span class="text-white text-[10px]">$${alert.targetPrice.toFixed(2)}</span>
                            <span class="${textColor} text-[10px]">
                                ${alert.triggered ? '✓' : remainingPercent.toFixed(1) + '%'}
                            </span>
                            <button onclick="App.Alerts.remove(${alert.id})" class="text-red-500 text-[8px] hover:text-red-300">×</button>
                        `;
                        
                        alertList.appendChild(alertEl);
                    });
                },
                
                checkAllAlerts: () => {
                    App.State.tokens.forEach(token => {
                        const currentPrice = App.State.marketData[token.symbol.toLowerCase()]?.lastPrice;
                        if (currentPrice) {
                            App.Alerts.checkAlerts(token.symbol, currentPrice);
                        }
                    });
                }
            },

            // 9. TOKEN MANAGEMENT HOLDER (mantido da versão anterior)
            Token: {
                add: async () => {
                    const input = document.getElementById('add-input');
                    let val = input.value.trim().toUpperCase();
                    if (!val) return;
                    
                    let name = '', symbol = '';
                    if (val.includes(':')) {
                        const parts = val.split(':');
                        name = parts[0].trim();
                        symbol = parts[1].trim().toUpperCase();
                    } else {
                        name = val;
                        symbol = val.toUpperCase();
                    }
                    
                    if (!symbol.endsWith('USDT')) {
                        symbol = symbol + 'USDT';
                    }
                    
                    if (App.State.tokens.some(t => t.symbol === symbol)) { 
                        alert('Ativo já na lista.'); 
                        return; 
                    }
                    
                    try {
                        const res = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`);
                        const data = await res.json();
                        if (data.symbol) {
                            // Tentar encontrar coinId no CoinGecko
                            let coinId = symbol.replace('USDT', '').toLowerCase();
                            App.State.tokens.push({symbol, name, coinId});
                            localStorage.setItem('holder_tokens', JSON.stringify(App.State.tokens));
                            location.reload();
                        } else { 
                            alert('Ativo não encontrado na Binance.'); 
                        }
                    } catch (e) { 
                        alert('Erro de validação. Verifique se o símbolo está correto.'); 
                    }
                },
                
                rem: (symbol) => {
                    App.State.tokens = App.State.tokens.filter(x => x.symbol !== symbol);
                    localStorage.setItem('holder_tokens', JSON.stringify(App.State.tokens));
                    location.reload();
                },
                
                addBatch: () => {
                    const textarea = document.getElementById('batch-tokens');
                    const lines = textarea.value.trim().split('\n');
                    let added = 0;
                    
                    lines.forEach(line => {
                        line = line.trim();
                        if (!line) return;
                        
                        let name = '', symbol = '';
                        if (line.includes(':')) {
                            const parts = line.split(':');
                            name = parts[0].trim();
                            symbol = parts[1].trim().toUpperCase();
                        } else {
                            name = line;
                            symbol = line.toUpperCase();
                        }
                        
                        if (!symbol.endsWith('USDT')) {
                            symbol = symbol + 'USDT';
                        }
                        
                        if (!App.State.tokens.some(t => t.symbol === symbol)) {
                            let coinId = symbol.replace('USDT', '').toLowerCase();
                            App.State.tokens.push({symbol, name, coinId});
                            added++;
                        }
                    });
                    
                    if (added > 0) {
                        localStorage.setItem('holder_tokens', JSON.stringify(App.State.tokens));
                        alert(`${added} ativos adicionados com sucesso!`);
                        location.reload();
                    } else {
                        alert('Nenhum ativo novo foi adicionado.');
                    }
                },
                
                removeSelected: () => {
                    const checkboxes = document.querySelectorAll('#settings-tokens-list .token-checkbox:checked');
                    if (checkboxes.length === 0) {
                        alert('Selecione pelo menos um ativo para remover.');
                        return;
                    }
                    
                    const symbolsToRemove = Array.from(checkboxes).map(cb => cb.value);
                    App.State.tokens = App.State.tokens.filter(t => !symbolsToRemove.includes(t.symbol));
                    localStorage.setItem('holder_tokens', JSON.stringify(App.State.tokens));
                    
                    App.Settings.renderTokensList();
                    App.UI.grid();
                    App.UI.tables();
                    App.Opportunities.generate();
                    
                    alert(`${symbolsToRemove.length} ativos removidos com sucesso!`);
                }
            },

            // 10. SETTINGS HOLDER (mantido da versão anterior)
            Settings: {
                openModal: () => {
                    document.getElementById('settingsModal').classList.remove('hidden');
                    App.Settings.renderTokensList();
                },
                
                closeModal: () => document.getElementById('settingsModal').classList.add('hidden'),
                
                setStrategy: (strategy) => {
                    App.State.settings.strategy = strategy;
                    document.querySelectorAll('#settingsModal button').forEach(btn => {
                        btn.classList.remove('border-holder-accumulation');
                        btn.classList.add('border-gray-700');
                    });
                    event.target.classList.remove('border-gray-700');
                    event.target.classList.add('border-holder-accumulation');
                },
                
                save: () => {
                    localStorage.setItem('holder_settings', JSON.stringify(App.State.settings));
                    App.Settings.closeModal();
                },
                
                renderTokensList: () => {
                    const container = document.getElementById('settings-tokens-list');
                    container.innerHTML = '';
                    
                    App.State.tokens.forEach(token => {
                        const tokenEl = document.createElement('span');
                        tokenEl.className = 'bg-dark-800 px-2 py-1 rounded border border-gray-600 text-xs flex gap-2 items-center';
                        tokenEl.innerHTML = `
                            <input type="checkbox" class="token-checkbox" value="${token.symbol}">
                            <span>${token.name} (${token.symbol.replace('USDT', '')})</span>
                        `;
                        container.appendChild(tokenEl);
                    });
                }
            },

            // 11. EXPORT HOLDER (mantido da versão anterior)
            Export: {
                openModal: () => document.getElementById('export-modal').classList.remove('hidden'),
                closeModal: () => document.getElementById('export-modal').classList.add('hidden'),
                gen: (type) => {
                    if (type === 'xlsx') {
                        const data = App.State.opportunities.map(opp => ({
                            'Ativo': opp.symbol.replace('USDT', ''),
                            'Nome': opp.name,
                            'Preço Atual': opp.price,
                            'Score HOLDER 2.0': opp.score,
                            'Fase': opp.phase === 'accumulation' ? 'Acumular' : opp.phase === 'profit_taking' ? 'Realizar' : 'Manter',
                            'Zona': opp.zone,
                            'Assimetria': opp.asymmetry,
                            'Prob. Retorno (3 anos)': opp.probability + '%',
                            'Horizonte': opp.horizon,
                            'Market Cap': opp.marketCap,
                            'Desconto MC ATH': opp.mcapDiscount + '%'
                        }));
                        
                        const ws = XLSX.utils.json_to_sheet(data);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "Oportunidades HOLDER");
                        XLSX.writeFile(wb, "CryptoPanel_Holder_Oportunidades.xlsx");
                    } else if (type === 'portfolio') {
                        // Exportar portfólio baseado nas oportunidades
                        const portfolioData = App.State.opportunities.map((opp, index) => ({
                            'Posição': index + 1,
                            'Ativo': opp.symbol.replace('USDT', ''),
                            'Nome': opp.name,
                            'Score': opp.score,
                            'Alocação Sugerida': (100 / App.State.opportunities.length).toFixed(1) + '%',
                            'Preço Atual': opp.price,
                            'Zona': opp.zone,
                            'Assimetria': opp.asymmetry,
                            'Probabilidade': opp.probability + '%',
                            'Horizonte': opp.horizon,
                            'Ação Recomendada': opp.phase === 'accumulation' ? 'Acumular (DCA)' : 
                                               opp.phase === 'profit_taking' ? 'Realizar Lucros' : 'Manter Posição'
                        }));
                        
                        const ws = XLSX.utils.json_to_sheet(portfolioData);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "Portfólio HOLDER");
                        XLSX.writeFile(wb, "Portfólio_Holder_Recomendado.xlsx");
                    }
                    
                    App.Export.closeModal();
                }
            }
        };

        // Inicialização
        App.Core.onOHLCUpdate((s, tf) => {
            App.UI.updateTokenCard(s.toUpperCase());
            App.Opportunities.generate();
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            App.Core.init();
            document.getElementById('refreshData').addEventListener('click', App.Core.refreshData);
            document.getElementById('openSettings').addEventListener('click', App.Settings.openModal);
            document.getElementById('searchToken').addEventListener('input', (e) => {
                const term = e.target.value.toUpperCase();
                document.querySelectorAll('.card').forEach(c => {
                    const symbol = c.dataset.symbol;
                    const name = c.querySelector('.symbol-name')?.textContent || '';
                    c.style.display = (symbol.includes(term) || name.toUpperCase().includes(term)) ? 'flex' : 'none';
                });
            });
        });
    </script>
</body>
</html>
