<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoPanel HOLDER PRO v4.5 - Institutional Grade</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        dark: { 950: '#05070a', 900: '#0b0e14', 800: '#151a23', 700: '#232a3b', 600: '#374151' },
                        // Zonas de Risco Institucional
                        zone: {
                            0: '#22c55e',   // 0-20 (Deep Value)
                            20: '#84cc16',  // 20-40 (Value)
                            40: '#facc15',  // 40-60 (Fair)
                            60: '#f97316',  // 60-80 (Overvalued)
                            80: '#ef4444',  // 80-100 (Risk)
                            100: '#7e22ce'  // 100+ (Bubble/Mania)
                        }
                    },
                    animation: { 
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.3s ease-in-out'
                    },
                    keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } }
                }
            }
        }
    </script>

    <style>
        body { background-color: #05070a; color: #e5e7eb; overflow-x: hidden; padding-bottom: 200px; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0b0e14; }
        ::-webkit-scrollbar-thumb { background: #232a3b; border-radius: 3px; }
        
        .glass { background: rgba(11, 14, 20, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        #metric-tooltip-overlay { 
            position: fixed; bottom: 0; left: 0; right: 0;
            height: auto; max-height: 60vh;
            background-color: #0b0e14;
            border-top: 2px solid #3b82f6;
            box-shadow: 0 -10px 60px rgba(0,0,0,0.95);
            z-index: 9999;
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex; flex-direction: column; gap: 1rem;
        }
        @media(min-width: 1024px) { #metric-tooltip-overlay { flex-direction: row; max-height: 35vh; } }

        .tooltip-hidden { transform: translateY(110%); opacity: 0; pointer-events: none; }
        .tooltip-visible { transform: translateY(0); opacity: 1; pointer-events: auto; }

        .tip-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #60a5fa; font-weight: 800; margin-bottom: 6px; border-bottom: 1px solid rgba(96, 165, 250, 0.2); display: inline-block; }
        .tip-val { font-size: 0.9rem; color: #d1d5db; line-height: 1.6; }
        
        .risk-btn { transition: all 0.3s; opacity: 0.6; }
        .risk-btn.active { opacity: 1; box-shadow: 0 0 10px currentColor; transform: translateY(-1px); }

        .zone-indicator-bar { height: 6px; width: 100%; display: flex; border-radius: 3px; overflow: hidden; margin-top: 4px; background: #1f2937; }
        .zone-seg { height: 100%; transition: opacity 0.3s; opacity: 0.3; }
        .zone-seg.active { opacity: 1; box-shadow: 0 0 10px currentColor; }
        
        .card-enter { animation: slideUp 0.5s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .table-scroller { overflow-y: auto; max-height: 350px; scrollbar-width: thin; }
        .modal-bg { background-color: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
        
        /* Estilos de Alerta */
        .alert-panel { border-color: rgba(139, 92, 246, 0.5) !important; }
        .alert-header { background-color: rgba(139, 92, 246, 0.1) !important; border-color: rgba(139, 92, 246, 0.3) !important; }
        .alert-button { background-color: #8b5cf6 !important; }
        .alert-button:hover { background-color: #7c3aed !important; }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col font-sans selection:bg-brand-500 selection:text-white">

    <header class="glass sticky top-0 z-50 border-b border-gray-800 shadow-lg">
        <div class="max-w-[1800px] mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-900 rounded-lg flex items-center justify-center shadow-lg border border-blue-500/30 cursor-help" data-tip="sys_logo">
                    <i class="fa-solid fa-gem text-white"></i>
                </div>
                <div>
                    <h1 class="font-bold text-xl text-white tracking-tight">CryptoPanel <span class="text-blue-500">HOLDER PRO</span></h1>
                    <div class="flex items-center gap-2 text-[10px] text-gray-400 font-mono">
                        <span>v4.5 INSTITUTIONAL</span>
                        <span class="w-1 h-1 rounded-full bg-gray-600"></span>
                        <span id="last-update" data-tip="sys_update">Iniciando...</span>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="hidden lg:flex bg-dark-800 rounded-lg p-1 border border-gray-700 mr-4">
                    <button onclick="App.Core.setRiskMode('conservative')" class="risk-btn active px-3 py-1 text-[10px] font-bold rounded text-green-400" id="btn-conservative" data-tip="mode_conservative">Conservador</button>
                    <button onclick="App.Core.setRiskMode('moderate')" class="risk-btn px-3 py-1 text-[10px] font-bold rounded text-yellow-400" id="btn-moderate" data-tip="mode_moderate">Moderado</button>
                    <button onclick="App.Core.setRiskMode('aggressive')" class="risk-btn px-3 py-1 text-[10px] font-bold rounded text-red-400" id="btn-aggressive" data-tip="mode_aggressive">Agressivo</button>
                </div>

                <div class="hidden md:flex flex-col items-end mr-2 cursor-help" data-tip="sys_refresh">
                    <span class="text-[9px] text-gray-500 uppercase tracking-widest">Next Refresh</span>
                    <span id="countdown" class="text-xs font-mono font-bold text-blue-500">600s</span>
                </div>
                <button onclick="App.Token.addPrompt()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded-lg text-xs font-bold transition-all shadow-lg hover:shadow-blue-500/20" data-tip="act_add_token"><i class="fa-solid fa-plus mr-1"></i> Add</button>
                <button onclick="App.Alerts.openModal()" class="bg-dark-800 hover:text-yellow-400 border border-gray-700 text-gray-400 px-3 py-2 rounded-lg text-xs font-bold transition-all" data-tip="act_alerts"><i class="fa-solid fa-bell mr-1"></i> Alertas</button>
                <button onclick="localStorage.clear(); location.reload()" class="p-2 bg-dark-800 hover:text-red-400 border border-gray-700 rounded-lg transition-all" data-tip="act_reset"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>
    </header>

    <div class="bg-dark-900 border-b border-gray-800 py-2">
        <div class="max-w-[1800px] mx-auto px-4 flex gap-4 overflow-x-auto text-[10px] uppercase font-bold tracking-wider text-gray-500 cursor-help" data-tip="legend_zones">
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-zone-0"></span> Acumula√ß√£o Forte</span>
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-zone-20"></span> Acumula√ß√£o</span>
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-zone-40"></span> Fair Value</span>
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-zone-60"></span> Sobrepre√ßo</span>
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-zone-80"></span> Risco Extremo</span>
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-zone-100"></span> Mania (>100%)</span>
        </div>
    </div>

    <main class="flex-1 max-w-[1800px] mx-auto px-4 py-6 w-full flex flex-col gap-6">
        
        <section id="alerts-panel" class="glass rounded-xl overflow-hidden border border-purple-500/30 flex flex-col shadow-lg alert-panel mb-4">
            <div class="bg-purple-900/20 p-3 border-b border-purple-500/30 flex justify-between items-center alert-header">
                <h3 class="text-purple-400 font-bold text-sm flex items-center gap-2" data-tip="panel_alerts_title"><i class="fa-solid fa-bell"></i> Monitor de Alertas Ativos</h3>
                <button onclick="App.Alerts.openModal()" class="px-3 py-1 bg-purple-600 hover:bg-purple-500 text-white rounded-lg text-xs alert-button">+ Criar Alerta</button>
            </div>
            <div class="p-3 bg-dark-900/50">
                <div id="alertsContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 max-h-40 overflow-y-auto">
                    <div class="text-gray-500 text-xs italic p-2">Nenhum alerta configurado.</div>
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <div class="glass rounded-xl overflow-hidden border border-gray-800 flex flex-col shadow-lg lg:col-span-2 h-[450px]">
                <div class="bg-dark-800/50 p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 class="text-white font-bold text-sm flex items-center gap-2" data-tip="panel_ranking"><i class="fa-solid fa-list-ol text-blue-500"></i> Top 10 Oportunidades Holder</h3>
                    <span id="current-mode-label" class="text-[10px] text-gray-500 bg-dark-900 px-2 py-1 rounded border border-gray-700 hidden sm:inline-block">Modo: Conservador</span>
                </div>
                <div class="flex-1 table-scroller">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-dark-950 text-gray-500 sticky top-0 z-10 font-bold">
                            <tr>
                                <th class="p-3 text-center">#</th>
                                <th class="p-3" data-tip="col_asset">Ativo</th>
                                <th class="p-3 text-right" data-tip="col_price">Pre√ßo</th>
                                <th class="p-3 text-center" data-tip="col_score">Score</th>
                                <th class="p-3 text-center" data-tip="quant_asymmetry">Assimetria 2.0</th>
                                <th class="p-3 text-right" data-tip="col_discount">Potencial (Cap)</th>
                            </tr>
                        </thead>
                        <tbody id="opportunity-list" class="divide-y divide-gray-800 text-gray-300">
                            <tr><td colspan="6" class="p-4 text-center text-gray-500 animate-pulse">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="glass rounded-xl overflow-hidden border border-gray-800 flex flex-col shadow-lg h-[450px]">
                <div class="bg-dark-800/50 p-4 border-b border-gray-700">
                    <h3 class="text-white font-bold text-sm flex items-center gap-2" data-tip="panel_pulse"><i class="fa-solid fa-bolt text-yellow-500"></i> Pulso 24h</h3>
                </div>
                <div class="flex-1 flex flex-col">
                    <div class="p-2 bg-dark-900 text-[10px] font-bold text-green-500 uppercase tracking-wider text-center border-b border-gray-800">Maiores Altas</div>
                    <div class="flex-1 overflow-y-auto" id="list-gainers"></div>
                    
                    <div class="p-2 bg-dark-900 text-[10px] font-bold text-red-500 uppercase tracking-wider text-center border-y border-gray-800">Maiores Baixas</div>
                    <div class="flex-1 overflow-y-auto" id="list-losers"></div>
                </div>
            </div>

            <div class="glass rounded-xl overflow-hidden border border-gray-800 flex flex-col shadow-lg h-[450px]">
                <div class="bg-dark-800/50 p-4 border-b border-gray-700">
                    <h3 class="text-white font-bold text-sm flex items-center gap-2" data-tip="panel_stats"><i class="fa-solid fa-chart-pie text-purple-500"></i> Quant Stats</h3>
                </div>
                <div class="p-6 flex flex-col gap-6 items-center flex-1 overflow-y-auto">
                    <div class="text-center w-full pb-4 border-b border-gray-800">
                        <div class="text-4xl font-bold text-white mb-1" id="global-score">--</div>
                        <div class="text-xs text-gray-500 uppercase tracking-widest">Score M√©dio Global</div>
                    </div>
                    <div class="w-full space-y-3">
                        <div class="flex justify-between text-xs text-gray-400"><span>Oportunidades</span><span id="stat-buy" class="text-white font-bold">0</span></div>
                        <div class="flex justify-between text-xs text-gray-400"><span>Neutros</span><span id="stat-hold" class="text-white font-bold">0</span></div>
                        <div class="flex justify-between text-xs text-gray-400"><span>Venda</span><span id="stat-sell" class="text-white font-bold">0</span></div>
                    </div>
                    <div class="w-full pt-4">
                        <div class="text-[9px] text-gray-500 uppercase text-center mb-1">Tend√™ncia Macro (EMA Cross)</div>
                        <div class="flex justify-center gap-2 text-xs font-bold" id="macro-trend-stats">
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex items-center justify-between mt-4">
            <h2 class="text-lg font-bold text-white" data-tip="grid_title">An√°lise Quantitativa</h2>
            <div class="text-xs text-gray-500 hidden sm:block"><i class="fa-solid fa-info-circle mr-1"></i> Dados: Binance + CoinGecko (H√≠brido)</div>
        </div>
        
        <div id="cards-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6 pb-20">
            </div>

    </main>

    <div id="alertsModal" class="fixed inset-0 z-[120] hidden modal-bg flex items-center justify-center p-4">
        <div class="bg-dark-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-md sm:max-w-2xl overflow-hidden mx-2">
            <div class="bg-dark-800 p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-white font-bold">Criar Alerta de Pre√ßo</h3>
                <button onclick="App.Alerts.closeModal()" class="text-gray-500 hover:text-white p-2"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Token</label>
                        <select id="alert-symbol" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white outline-none"></select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Tipo</label>
                        <select id="alert-type" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white outline-none">
                            <option value="buy">Alerta de COMPRA (Se cair para...)</option>
                            <option value="sell">Alerta de VENDA (Se subir para...)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Pre√ßo Alvo (USDT)</label>
                        <input type="number" id="alert-price" step="0.0001" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white outline-none" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Notas (Opcional)</label>
                        <textarea id="alert-notes" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white outline-none" rows="2" placeholder="Ex: Comprar suporte Fibonacci..."></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button onclick="App.Alerts.closeModal()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg">Cancelar</button>
                    <button onclick="App.Alerts.createAlert()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg">Salvar Alerta</button>
                </div>
            </div>
        </div>
    </div>

    <div id="metric-tooltip-overlay" class="tooltip-hidden"></div>

    <template id="card-template">
        <div class="card glass rounded-xl overflow-hidden hover:border-blue-500/50 transition-all duration-300 card-enter flex flex-col group relative" data-symbol="">
            <div class="p-5 relative z-10 bg-gradient-to-b from-dark-800/50 to-transparent cursor-pointer" onclick="App.UI.toggleDetails(this)">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-3">
                        <div class="relative">
                            <div class="score-circle w-12 h-12 rounded-full border-4 flex items-center justify-center text-sm font-bold bg-dark-900 z-10 relative shadow-lg" data-tip="metric_score">--</div>
                        </div>
                        <div>
                            <h3 class="font-bold text-white text-xl symbol-ticker leading-none tracking-tight" data-tip="card_ticker">BTC</h3>
                            <div class="flex gap-1 mt-1">
                                <div class="dilution-badge text-[9px] font-bold uppercase px-1.5 py-0.5 rounded bg-gray-800 text-gray-500 cursor-help" data-tip="quant_dilution">FDV: --</div>
                                <div class="macro-badge text-[9px] font-bold uppercase px-1.5 py-0.5 rounded bg-gray-800 text-gray-500 cursor-help" data-tip="quant_macro_trend">TREND: --</div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-mono font-bold text-white price-display" data-tip="metric_price">$0.00</div>
                        <button onclick="event.stopPropagation(); App.Alerts.openForCard(this)" class="text-gray-500 hover:text-yellow-400 transition-colors mt-1" data-tip="act_quick_alert"><i class="fa-regular fa-bell"></i></button>
                    </div>
                </div>

                <div class="flex justify-between text-[10px] font-mono text-gray-400 mb-3 border-b border-gray-800/50 pb-2">
                    <div class="text-center" data-tip="quant_asymmetry">Assimetria 2.0 <span class="val-asym font-bold text-white">--</span></div>
                    <div class="text-center" data-tip="metric_var24h">24h <span class="var-24h font-bold">--</span></div>
                    <div class="text-center" data-tip="quant_vol_regime">Regime <span class="val-regime font-bold">--</span></div>
                </div>

                <div class="mb-4" data-tip="zone_position">
                    <div class="zone-indicator-bar bg-dark-900">
                        <div class="zone-seg w-1/6 bg-zone-0"></div>
                        <div class="zone-seg w-1/6 bg-zone-20"></div>
                        <div class="zone-seg w-1/6 bg-zone-40"></div>
                        <div class="zone-seg w-1/6 bg-zone-60"></div>
                        <div class="zone-seg w-1/6 bg-zone-80"></div>
                        <div class="zone-seg w-1/6 bg-zone-100" title="Mania Zone"></div>
                    </div>
                    <div class="relative w-full h-2 mt-[-8px]">
                        <div class="absolute top-0 w-0.5 h-4 bg-white shadow-[0_0_10px_white] transition-all duration-1000 price-needle" style="left: 50%"></div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2 pt-2">
                    <div class="text-center" data-tip="quant_cheapness">
                        <div class="text-[9px] text-gray-500 uppercase">Log-Cheapness</div>
                        <div class="text-xs font-bold text-white val-cheap">--%</div>
                    </div>
                    <div class="text-center" data-tip="metric_rsi_macro">
                        <div class="text-[9px] text-gray-500 uppercase">Macro RSI</div>
                        <div class="text-xs font-bold text-white val-rsi">--</div>
                    </div>
                    <div class="text-center" data-tip="quant_potential">
                        <div class="text-[9px] text-gray-500 uppercase">Alvo 3A (Teto)</div>
                        <div class="text-xs font-bold text-blue-400 val-pot3y">--</div>
                    </div>
                </div>
            </div>

            <div class="card-details hidden bg-dark-900 border-t border-gray-800 p-5 space-y-5 animate-fade-in">
                
                <div class="bg-dark-950 p-3 rounded border border-gray-800/50">
                    <h4 class="text-[10px] text-blue-500 font-bold uppercase mb-2">An√°lise Quantitativa</h4>
                    <p class="text-xs text-gray-300 leading-relaxed analysis-text mb-3">Calculando...</p>
                    
                    <div class="grid grid-cols-2 gap-2 text-[10px] font-mono border-t border-gray-800 pt-2">
                        <div data-tip="fib_buy">
                            <div class="text-gray-500">Zona Ouro (0.618)</div>
                            <div class="text-yellow-400 font-bold val-fib-gold">--</div>
                        </div>
                        <div class="text-right" data-tip="fib_deep">
                            <div class="text-gray-500">Fundo (0.786)</div>
                            <div class="text-green-400 font-bold val-fib-deep">--</div>
                        </div>
                    </div>
                </div>

                <div class="h-32 w-full bg-black rounded border border-gray-800 chart-container"></div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h5 class="text-[9px] text-gray-500 uppercase font-bold mb-2">Hist√≥rico</h5>
                        <div class="space-y-1 text-[10px]">
                            <div class="flex justify-between" data-tip="metric_ath"><span class="text-gray-600">ATH:</span> <span class="text-gray-300 val-ath">--</span></div>
                            <div class="flex justify-between" data-tip="metric_atl"><span class="text-gray-600">ATL:</span> <span class="text-gray-300 val-atl">--</span></div>
                            <div class="flex justify-between" data-tip="metric_vola"><span class="text-gray-600">Volatilidade:</span> <span class="text-gray-300 val-vola">--</span></div>
                        </div>
                    </div>
                    <div>
                        <h5 class="text-[9px] text-gray-500 uppercase font-bold mb-2">Fundamentos</h5>
                        <div class="space-y-1 text-[10px]">
                            <div class="flex justify-between" data-tip="metric_mcap"><span class="text-gray-600">Mcap:</span> <span class="text-gray-300 val-mcap-full">--</span></div>
                            <div class="flex justify-between" data-tip="metric_fdv"><span class="text-gray-600">FDV:</span> <span class="text-gray-300 val-fdv">--</span></div>
                        </div>
                    </div>
                </div>

                <button class="w-full py-2 bg-red-900/20 hover:bg-red-900/40 text-red-500 text-xs rounded border border-red-900/30 transition-colors" onclick="App.Token.remove(this)">Remover da Watchlist</button>
            </div>
        </div>
    </template>

    <script>
        const CONFIG = {
            refreshInterval: 600,
            wsThrottle: 5000,
            historyDays: 1400, // Aumentado para pegar EMA 100W com seguran√ßa
            volatilityWindow: 180,
            
            cgMapping: {
                'BTCUSDT': 'bitcoin', 'ETHUSDT': 'ethereum', 'SOLUSDT': 'solana', 'BNBUSDT': 'binancecoin',
                'ADAUSDT': 'cardano', 'XRPUSDT': 'ripple', 'DOTUSDT': 'polkadot', 'DOGEUSDT': 'dogecoin',
                'AVAXUSDT': 'avalanche-2', 'MATICUSDT': 'matic-network', 'LINKUSDT': 'chainlink',
                'UNIUSDT': 'uniswap', 'LTCUSDT': 'litecoin', 'ATOMUSDT': 'cosmos', 'NEARUSDT': 'near',
                'APTUSDT': 'aptos', 'ARBUSDT': 'arbitrum', 'OPUSDT': 'optimism', 'RNDRUSDT': 'render-token'
            },
            
            defaultTokens: [
                {s: 'BTCUSDT', n: 'Bitcoin'}, 
                {s: 'ETHUSDT', n: 'Ethereum'}, 
                {s: 'SOLUSDT', n: 'Solana'}, 
                {s: 'BNBUSDT', n: 'BNB'}
            ]
        };

        const App = {
            data: {
                tokens: JSON.parse(localStorage.getItem('holder_tokens')) || CONFIG.defaultTokens,
                alerts: JSON.parse(localStorage.getItem('holder_alerts')) || [],
                history: {},
                fundamentals: {}, 
                metrics: {},
                market: {},
                riskMode: 'conservative', // Padr√£o: Conservador para Holder Real
                lastUpdate: 0
            },

            // --- BIBLIOTECA EDUCACIONAL QUANTITATIVA ---
            Library: {
                'mode_conservative': { t: 'Modo Conservador', d: 'Foca em Valor e Fundamentos (45/30). Ideal para prote√ß√£o patrimonial.', hint: 'Use para acumular apenas o "Fil√© Mignon" do mercado.' },
                'mode_moderate': { t: 'Modo Moderado', d: 'Equil√≠brio padr√£o.', hint: '' },
                'mode_aggressive': { t: 'Modo Agressivo', d: 'Foca em Ciclo e T√©cnico.', hint: 'Maior risco.' },
                
                'quant_asymmetry': { t: 'Assimetria 2.0 (Ajustada)', d: 'Risco/Retorno penalizado por Volatilidade e Dilui√ß√£o. F√≥rmula: (Upside/Downside) * (1/Dilution) * (1/Vol).', hint: 'Uma assimetria > 5x ajustada √© rar√≠ssima e valiosa.' },
                'quant_macro_trend': { t: 'Tend√™ncia Macro (EMA Cross)', d: 'Cruzamento das M√©dias Semanais 50 e 100.', hint: 'GOLDEN (50>100) = Bull Market Secular. DEATH (50<100) = Acumula√ß√£o/Bear.' },
                'metric_rsi_macro': { t: 'RSI Macro (Smoothed)', d: 'M√©dia ponderada do RSI 14W (70%) e RSI 28W (30%). Remove ru√≠do de curto prazo.', hint: 'Sinais abaixo de 40 no Macro RSI s√£o fundos de ciclo confi√°veis.' },
                'quant_cheapness': { t: 'Cheapness (Log-Percentile)', d: 'Percentil hist√≥rico calculado em escala logar√≠tmica para ignorar outliers de pre√ßo (wicks).', hint: 'Mede o qu√£o barato o ativo est√° vs sua pr√≥pria hist√≥ria real.' },
                'quant_potential': { t: 'Potencial 3A (Capped)', d: 'Proje√ß√£o logar√≠tmica limitada a 10x o Market Cap atual para realismo.', hint: 'Evita proje√ß√µes de trilh√µes de d√≥lares para shitcoins.' },
                
                // Mantidos
                'quant_dilution': { t: 'Risco de Dilui√ß√£o', d: 'FDV / Mcap.', hint: '> 3.0 √© perigoso.' },
                'quant_vol_regime': { t: 'Regime de Volatilidade', d: 'Atual vs M√©dia Hist√≥rica.', hint: 'Compress√£o precede explos√£o.' },
                'sys_logo': { t: 'CryptoPanel Quant', d: 'v4.5 Institutional Grade.', hint: '' },
                'sys_update': { t: 'Sync', d: 'Binance + CoinGecko.', hint: '' },
                'act_add_token': { t: 'Add', d: '', hint: '' }, 'act_alerts': { t: 'Alertas', d: '', hint: '' }, 'act_reset': { t: 'Reset', d: '', hint: '' },
                'metric_score': { t: 'Score Holder 2.0', d: 'Nota 0-100 ponderada.', hint: '' }, 'card_ticker': { t: 'Ativo', d: '', hint: '' }, 'metric_price': { t: 'Pre√ßo', d: '', hint: '' }, 'act_quick_alert': { t: 'Alerta', d: '', hint: '' },
                'metric_var24h': { t: '24h', d: '', hint: '' }, 'zone_position': { t: 'Posi√ß√£o Hist√≥rica', d: '', hint: '' },
                'fib_buy': { t: 'Fib 0.618', d: '', hint: '' }, 'fib_deep': { t: 'Fib 0.786', d: '', hint: '' },
                'metric_ath': { t: 'ATH', d: '', hint: '' }, 'metric_atl': { t: 'ATL', d: '', hint: '' }, 'metric_vola': { t: 'Volatilidade', d: '', hint: '' }, 'metric_mcap': { t: 'Mcap', d: '', hint: '' }, 'metric_fdv': { t: 'FDV', d: '', hint: '' }
            },

            Core: {
                init: async () => {
                    App.UI.setupTooltips();
                    App.UI.renderGrid();
                    App.Alerts.renderList();
                    await App.Core.refreshAll();
                    App.Core.startWS();
                    setInterval(App.Core.refreshAll, CONFIG.refreshInterval * 1000);
                    setInterval(() => {
                        let el = document.getElementById('countdown');
                        let next = App.data.lastUpdate + (CONFIG.refreshInterval * 1000);
                        let remain = Math.max(0, Math.ceil((next - Date.now()) / 1000));
                        el.innerText = remain + 's';
                    }, 1000);
                },

                setRiskMode: (mode) => {
                    App.data.riskMode = mode;
                    document.querySelectorAll('.risk-btn').forEach(b => b.classList.remove('active', 'border-white'));
                    document.getElementById(`btn-${mode}`).classList.add('active', 'border-white');
                    document.getElementById('current-mode-label').innerText = `Modo: ${mode.charAt(0).toUpperCase() + mode.slice(1)}`;
                    for(let t of App.data.tokens) App.Analysis.calc(t.s);
                    App.UI.updateAll();
                },

                refreshAll: async () => {
                    const statusEl = document.getElementById('last-update');
                    statusEl.innerText = "üîÑ Calc...";
                    statusEl.className = "text-yellow-500 animate-pulse";
                    try {
                        for(let t of App.data.tokens) await App.Core.fetchHistory(t.s);
                        await App.Core.fetchFundamentals();
                        for(let t of App.data.tokens) App.Analysis.calc(t.s);
                        App.data.lastUpdate = Date.now();
                        statusEl.innerText = new Date().toLocaleTimeString();
                        statusEl.className = "";
                        App.UI.updateAll();
                        App.Alerts.check();
                    } catch (error) { console.error(error); statusEl.innerText = "Erro"; statusEl.className = "text-red-500"; }
                },

                fetchHistory: async (symbol) => {
                    // Busca dados suficientes para EMA 100W
                    let r1 = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1d&limit=${CONFIG.historyDays}`);
                    let d1 = await r1.json();
                    let r2 = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1w&limit=200`);
                    let d2 = await r2.json();
                    App.data.history[symbol] = { d1: d1.map(x=>({t:x[0],c:+x[4]})), w1: d2.map(x=>({t:x[0],c:+x[4]})) };
                },

                fetchFundamentals: async () => {
                    const ids = App.data.tokens.map(t => CONFIG.cgMapping[t.s] || '').filter(x => x).join(',');
                    if(!ids) return;
                    const res = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${ids}&order=market_cap_desc&sparkline=false`);
                    const data = await res.json();
                    data.forEach(coin => {
                        const binanceSymbol = Object.keys(CONFIG.cgMapping).find(key => CONFIG.cgMapping[key] === coin.id);
                        if(binanceSymbol) {
                            App.data.fundamentals[binanceSymbol] = {
                                mcap: coin.market_cap, fdv: coin.fully_diluted_valuation || coin.market_cap,
                                ath: coin.ath, atl: coin.atl, supply: coin.circulating_supply
                            };
                        }
                    });
                },

                startWS: () => {
                    const ws = new WebSocket("wss://stream.binance.com:9443/ws/!ticker@arr");
                    let lastDraw = 0;
                    ws.onmessage = (e) => {
                        const data = JSON.parse(e.data);
                        let needsUpdate = false;
                        data.forEach(t => {
                            if(App.data.tokens.find(k => k.s === t.s)) {
                                App.data.market[t.s] = { p: +t.c, P: +t.P, q: +t.q };
                                needsUpdate = true;
                            }
                        });
                        if(needsUpdate && (Date.now() - lastDraw > CONFIG.wsThrottle)) {
                            App.UI.updatePricesOnly();
                            lastDraw = Date.now();
                        }
                    };
                }
            },

            Indicators: {
                sma: (arr, p) => arr.length < p ? arr[arr.length-1] : arr.slice(-p).reduce((a,b)=>a+b,0)/p,
                ema: (arr, p) => {
                    if (arr.length < p) return null;
                    const k = 2 / (p + 1);
                    let ema = arr.slice(0, p).reduce((a, b) => a + b, 0) / p; // SMA inicial
                    for (let i = p; i < arr.length; i++) {
                        ema = (arr[i] - ema) * k + ema;
                    }
                    return ema;
                },
                rsiWilder: (arr, p=14) => {
                    if (arr.length <= p) return 50;
                    let avgGain=0, avgLoss=0;
                    for(let i=1; i<=p; i++) { let c = arr[i]-arr[i-1]; if(c>0) avgGain+=c; else avgLoss+=Math.abs(c); }
                    avgGain/=p; avgLoss/=p;
                    for(let i=p+1; i<arr.length; i++) {
                        let c = arr[i]-arr[i-1];
                        avgGain = ((avgGain*(p-1)) + (c>0?c:0))/p;
                        avgLoss = ((avgLoss*(p-1)) + (c<0?Math.abs(c):0))/p;
                    }
                    return avgLoss===0 ? 100 : 100-(100/(1+(avgGain/avgLoss)));
                },
                volatilityLog: (arr, w=180) => {
                    if(arr.length < w+1) return 0;
                    let logs = [];
                    for(let i=arr.length-w; i<arr.length; i++) logs.push(Math.log(arr[i]/arr[i-1]));
                    const mean = logs.reduce((a,b)=>a+b,0)/logs.length;
                    const variance = logs.reduce((a,b)=>a+Math.pow(b-mean,2),0)/logs.length;
                    return Math.sqrt(variance)*Math.sqrt(365)*100;
                }
            },

            Analysis: {
                calc: (symbol) => {
                    const h = App.data.history[symbol];
                    const fund = App.data.fundamentals[symbol];
                    const mkt = App.data.market[symbol];
                    if(!h || !h.d1.length || !mkt) return;

                    const closesD = h.d1.map(x => x.c);
                    const closesW = h.w1.map(x => x.c);
                    const currentPrice = mkt.p;

                    const ath = fund ? fund.ath : Math.max(...closesD);
                    const atl = fund ? fund.atl : Math.min(...closesD);

                    // 1. Valuation Logar√≠tmico (Robust Cheapness)
                    // Usamos Log para que picos de pre√ßo n√£o distor√ßam o ranking
                    const logCloses = closesD.map(p => Math.log(p));
                    const currentLog = Math.log(currentPrice);
                    const sortedLogs = [...logCloses].sort((a,b) => a-b);
                    let rank = sortedLogs.findIndex(x => x >= currentLog);
                    if (rank === -1) rank = 0; 
                    const percentile = (rank / sortedLogs.length) * 100;
                    
                    const cheapness = 100 - percentile;
                    const scoreVal = Math.max(0, cheapness);

                    // 2. Assimetria 2.0 (Ajustada ao Risco)
                    const upside = Math.max(0, ath - currentPrice);
                    const downside = Math.max(1, currentPrice - atl);
                    const rawAsymmetry = downside > 0 ? (upside / downside) : 50;
                    
                    // Fatores de penalidade
                    const volAvg = App.Indicators.volatilityLog(closesD, 180);
                    const dilutionRisk = (fund && fund.mcap > 0) ? fund.fdv / fund.mcap : 1.0;
                    
                    // Assimetria Real = Bruta / (Risco Dilui√ß√£o * Fator Volatilidade)
                    // Volatilidade alta penaliza a assimetria
                    const volFactor = Math.max(1, volAvg / 50); 
                    const dilutionFactor = Math.max(1, dilutionRisk);
                    const asymmetry = rawAsymmetry / (dilutionFactor * volFactor);

                    // 3. RSI Macro Holder (Smoothed)
                    const rsi14 = App.Indicators.rsiWilder(closesW, 14);
                    const rsi28 = App.Indicators.rsiWilder(closesW, 28);
                    const rsiMacro = (rsi14 * 0.7) + (rsi28 * 0.3);
                    let scoreCycle = rsiMacro <= 30 ? 100 : rsiMacro >= 80 ? 0 : 100 - ((rsiMacro - 30) * 2);

                    // 4. Fundamentos
                    let scoreFund = 50;
                    if(fund) {
                        if(dilutionRisk < 1.2) scoreFund += 20; 
                        else if(dilutionRisk > 3.0) scoreFund -= 20;
                        if(((ath-currentPrice)/ath) > 0.9) scoreFund -= 10;
                    }

                    // 5. T√©cnico Macro (EMA Cross)
                    const sma200 = App.Indicators.sma(closesD, 200);
                    const ema50w = App.Indicators.ema(closesW, 50);
                    const ema100w = App.Indicators.ema(closesW, 100);
                    
                    let macroTrend = "Neutro";
                    let scoreTech = 50;
                    
                    if (ema50w && ema100w) {
                        if (ema50w > ema100w) {
                            macroTrend = "GOLDEN"; // Bull Market Secular
                            scoreTech += 20;
                        } else {
                            macroTrend = "DEATH"; // Bear Market / Accumulation
                            // Para Holder, Death Cross pode ser bom se o pre√ßo estiver muito abaixo (acumula√ß√£o)
                            if (percentile < 20) scoreTech += 30; // Deep Value Accumulation
                            else scoreTech -= 10; // Bear Trend normal
                        }
                    }

                    // PESOS DIN√ÇMICOS (Institucional v4.5)
                    // Foco: Valuation e Fundamentos
                    let wVal=0.45, wFun=0.30, wCyc=0.15, wTec=0.10; // Conservador padr√£o
                    
                    if(App.data.riskMode === 'moderate') { wVal=0.35; wFun=0.25; wCyc=0.25; wTec=0.15; }
                    if(App.data.riskMode === 'aggressive') { wVal=0.20; wFun=0.10; wCyc=0.40; wTec=0.30; }

                    const finalScore = (scoreVal * wVal) + (scoreCycle * wCyc) + (scoreFund * wFun) + (scoreTech * wTec);
                    
                    // Alvos Fibonacci 
                    const range = ath - atl;
                    const buyZone1 = ath - (range * 0.618);
                    const buyZone2 = ath - (range * 0.786);

                    // 6. Potencial Logar√≠tmico com Teto (Capped)
                    // Crescimento base + bonus volatilidade
                    const volNorm = volAvg / 100; 
                    const growthRate = 0.2 + (volNorm * 0.5); 
                    const scoreFactor = finalScore / 50; 
                    let potential = currentPrice * Math.exp(growthRate * 3 * scoreFactor);
                    
                    // Teto de Market Cap (Institucional)
                    if (fund && fund.mcap > 0) {
                        const maxMultiplier = 10; // Cap de 10x no Mcap atual
                        const maxPrice = currentPrice * maxMultiplier;
                        potential = Math.min(potential, maxPrice);
                    }

                    const volRegime = App.Indicators.volatilityLog(closesD, 30) < volAvg ? "Compress√£o" : "Expans√£o";

                    App.data.metrics[symbol] = {
                        score: Math.round(finalScore),
                        percentile, cheapness, asymmetry, dilutionRisk, volRegime,
                        rsiW: rsiMacro, // Exibimos o Macro agora
                        sma200, ema50w, ema100w, macroTrend,
                        ath, atl,
                        discountAth: ((ath - currentPrice)/ath)*100,
                        volatility: volAvg,
                        potential3y: potential,
                        mcap: fund ? fund.mcap : 0, fdv: fund ? fund.fdv : 0,
                        fibGold: buyZone1, fibDeep: buyZone2
                    };
                }
            },

            Alerts: {
                saveToStorage: () => localStorage.setItem("holder_alerts", JSON.stringify(App.data.alerts)),
                openModal: (btn = null) => {
                    const modal = document.getElementById('alertsModal');
                    const symbolSelect = document.getElementById('alert-symbol');
                    symbolSelect.innerHTML = '<option value="">Selecione um token</option>';
                    App.data.tokens.forEach(t => {
                        const option = document.createElement('option');
                        option.value = t.s; option.textContent = t.n; symbolSelect.appendChild(option);
                    });
                    if (btn) { const card = btn.closest('.card'); if (card) symbolSelect.value = card.dataset.symbol; }
                    document.getElementById('alert-price').value = '';
                    document.getElementById('alert-notes').value = '';
                    modal.classList.remove('hidden');
                },
                closeModal: () => document.getElementById('alertsModal').classList.add('hidden'),
                openForCard: (btn) => App.Alerts.openModal(btn),
                createAlert: () => {
                    const symbol = document.getElementById('alert-symbol').value;
                    const type = document.getElementById('alert-type').value;
                    const price = parseFloat(document.getElementById('alert-price').value);
                    const notes = document.getElementById('alert-notes').value;
                    if (!symbol || !price) return alert('Preencha os dados!');
                    const mkt = App.data.market[symbol];
                    App.data.alerts.push({
                        id: Date.now(), symbol, type, targetPrice: price, initialPrice: mkt ? mkt.p : 0, notes, triggered: false
                    });
                    App.Alerts.saveToStorage(); App.Alerts.renderList(); App.Alerts.closeModal();
                },
                remove: (id) => {
                    App.data.alerts = App.data.alerts.filter(a => a.id !== id);
                    App.Alerts.saveToStorage(); App.Alerts.renderList();
                },
                check: () => {
                    let changed = false;
                    App.data.alerts.forEach(a => {
                        if(a.triggered) return;
                        const mkt = App.data.market[a.symbol];
                        if(!mkt) return;
                        let hit = (a.type === 'buy' && mkt.p <= a.targetPrice) || (a.type === 'sell' && mkt.p >= a.targetPrice);
                        if(hit) { a.triggered = true; changed = true; alert(`ALERTA: ${a.symbol} atingiu $${a.targetPrice}`); }
                    });
                    if(changed) { App.Alerts.saveToStorage(); App.Alerts.renderList(); }
                },
                renderList: () => {
                    const div = document.getElementById('alertsContent');
                    if(!App.data.alerts.length) { div.innerHTML = '<div class="text-gray-500 text-xs italic p-2">Nenhum alerta configurado.</div>'; return; }
                    div.innerHTML = App.data.alerts.map(a => {
                        const mkt = App.data.market[a.symbol];
                        const curr = mkt ? mkt.p : a.initialPrice;
                        const dist = ((a.targetPrice - curr)/curr)*100;
                        return `
                        <div class="bg-dark-800 border ${a.triggered ? 'border-green-500' : 'border-gray-700'} p-2 rounded relative group">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-xs ${a.type==='buy'?'text-green-400':'text-red-400'}">${a.symbol.replace('USDT','')} ${a.type==='buy'?'C':'V'}</span>
                                <button onclick="App.Alerts.remove(${a.id})" class="text-gray-600 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                            </div>
                            <div class="flex justify-between text-[10px] font-mono">
                                <span class="text-gray-400">Alvo: $${a.targetPrice}</span>
                                <span class="${a.triggered ? 'text-green-500 font-bold' : 'text-yellow-500'}">${a.triggered ? 'ATINGIDO' : dist.toFixed(1)+'%'}</span>
                            </div>
                        </div>`;
                    }).join('');
                },
                renderInCard: (symbol) => { /* Mantido no template */ }
            },

            UI: {
                renderGrid: () => {
                    const grid = document.getElementById('cards-grid');
                    grid.innerHTML = '';
                    App.data.tokens.forEach(t => {
                        const clone = document.getElementById('card-template').content.cloneNode(true);
                        const card = clone.querySelector('.card');
                        card.dataset.symbol = t.s;
                        card.querySelector('.symbol-ticker').innerText = t.n;
                        grid.appendChild(card);
                    });
                },

                updateAll: () => {
                    App.UI.updatePricesOnly();
                    App.UI.updateTables();
                    App.UI.updateStats();
                    App.UI.updateMarketPulse();
                },

                updatePricesOnly: () => {
                    App.data.tokens.forEach(t => {
                        const m = App.data.metrics[t.s];
                        const p = App.data.market[t.s];
                        const card = document.querySelector(`.card[data-symbol="${t.s}"]`);
                        if(!card || !p) return;

                        card.querySelector('.price-display').innerText = '$' + (p.p < 1 ? p.p.toFixed(4) : p.p.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                        
                        const setVar = (sel, val) => {
                            const el = card.querySelector(sel);
                            el.innerText = (val>0?'+':'') + val.toFixed(1) + '%';
                            el.className = `font-bold ${sel.replace('.','')} ${val>=0 ? 'text-green-400' : 'text-red-400'}`;
                        };
                        setVar('.var-24h', p.P);

                        if(!m) return;

                        // Score
                        const scoreEl = card.querySelector('.score-circle');
                        scoreEl.innerText = m.score;
                        scoreEl.className = `score-circle w-12 h-12 rounded-full border-4 flex items-center justify-center text-sm font-bold z-10 relative shadow-lg transition-colors duration-500
                            ${m.score >= 70 ? 'bg-zone-0 text-black border-green-900' : 
                              m.score >= 40 ? 'bg-zone-40 text-black border-yellow-900' : 
                              'bg-zone-80 text-white border-red-900'}`;

                        // Barra Zona (Com Mania Zone > 100%)
                        const needle = card.querySelector('.price-needle');
                        const pVis = Math.min(100, Math.max(2, m.percentile));
                        needle.style.left = `${pVis}%`;
                        needle.style.backgroundColor = m.percentile > 80 ? '#ef4444' : '#22c55e';
                        
                        // Badges
                        card.querySelector('.macro-badge').innerText = m.macroTrend || 'WAIT';
                        card.querySelector('.macro-badge').className = `macro-badge text-[9px] font-bold uppercase px-1.5 py-0.5 rounded cursor-help ${m.macroTrend === 'GOLDEN' ? 'bg-yellow-900 text-yellow-400' : 'bg-gray-800 text-gray-500'}`;

                        // M√©tricas Quant
                        card.querySelector('.val-cheap').innerText = m.cheapness.toFixed(0) + '%';
                        card.querySelector('.val-asym').innerText = m.asymmetry.toFixed(1) + 'x';
                        card.querySelector('.val-asym').className = `val-asym font-bold ${m.asymmetry > 3 ? 'text-green-400' : 'text-white'}`;
                        
                        card.querySelector('.val-regime').innerText = m.volRegime;
                        card.querySelector('.val-regime').className = `val-regime font-bold ${m.volRegime === 'Compress√£o' ? 'text-green-400' : 'text-red-400'}`;

                        const dilutionBadge = card.querySelector('.dilution-badge');
                        dilutionBadge.innerText = `FDV: ${m.dilutionRisk.toFixed(1)}x`;
                        dilutionBadge.className = `dilution-badge text-[9px] font-bold uppercase px-1.5 py-0.5 rounded mt-1 inline-block cursor-help ${m.dilutionRisk < 1.5 ? 'bg-green-900 text-green-400' : m.dilutionRisk > 3 ? 'bg-red-900 text-red-400' : 'bg-gray-800 text-gray-500'}`;

                        const formatUSD = (v) => v >= 1e9 ? `$${(v/1e9).toFixed(1)}B` : v >= 1e6 ? `$${(v/1e6).toFixed(0)}M` : '-';
                        card.querySelector('.val-mcap-mini').innerText = m.mcap ? formatUSD(m.mcap) : '-';
                        card.querySelector('.val-pot3y').innerText = m.potential3y ? '$'+(m.potential3y<1?m.potential3y.toFixed(4):m.potential3y.toLocaleString(undefined,{maximumFractionDigits:0})) : '-';

                        const rsiEl = card.querySelector('.val-rsi');
                        rsiEl.innerText = m.rsiW.toFixed(0);
                        rsiEl.className = `text-xs font-bold val-rsi ${m.rsiW < 30 ? 'text-green-400 animate-pulse' : m.rsiW > 70 ? 'text-red-400' : 'text-white'}`;

                        if(!card.querySelector('.card-details').classList.contains('hidden')) {
                            App.UI.fillDetails(card, t.s, m, p);
                        }
                    });
                },

                fillDetails: (card, s, m, p) => {
                    const formatUSD = (v) => v >= 1e9 ? `$${(v/1e9).toFixed(2)}B` : `$${(v/1e6).toFixed(2)}M`;
                    
                    let action = m.score > 70 ? "COMPRA" : m.score < 40 ? "VENDA" : "AGUARDE";
                    card.querySelector('.analysis-text').innerText = 
                        `Score ${m.score} (${App.data.riskMode}). Tend√™ncia Macro: ${m.macroTrend}. Assimetria: ${m.asymmetry.toFixed(1)}x. Regime: ${m.volRegime}. A√ß√£o sugerida: ${action}.`;

                    card.querySelector('.val-fib-gold').innerText = `$${m.fibGold.toLocaleString(undefined, {maximumFractionDigits:2})}`;
                    card.querySelector('.val-fib-deep').innerText = `$${m.fibDeep.toLocaleString(undefined, {maximumFractionDigits:2})}`;
                    card.querySelector('.val-ath').innerText = '$'+m.ath.toLocaleString();
                    card.querySelector('.val-atl').innerText = m.atl ? '$'+m.atl.toLocaleString() : 'N/A';
                    card.querySelector('.val-vola').innerText = m.volatility.toFixed(1) + '%';
                    card.querySelector('.val-mcap-full').innerText = m.mcap ? formatUSD(m.mcap) : 'N/A';
                    card.querySelector('.val-fdv').innerText = m.fdv ? formatUSD(m.fdv) : 'N/A';

                    App.UI.renderChart(card, s);
                },

                updateMarketPulse: () => {
                    const all = App.data.tokens.map(t => ({n: t.n, P: App.data.market[t.s]?.P || 0}));
                    const gainers = [...all].sort((a,b) => b.P - a.P).slice(0, 5);
                    const losers = [...all].sort((a,b) => a.P - b.P).slice(0, 5);
                    const mkRow = (i) => `<div class="flex justify-between p-2 text-xs border-b border-gray-800/50 hover:bg-white/5"><span>${i.n}</span><span class="font-mono font-bold ${i.P>=0?'text-green-400':'text-red-400'}">${i.P>0?'+':''}${i.P.toFixed(2)}%</span></div>`;
                    document.getElementById('list-gainers').innerHTML = gainers.map(mkRow).join('');
                    document.getElementById('list-losers').innerHTML = losers.map(mkRow).join('');
                },

                renderChart: (card, symbol) => {
                    const container = card.querySelector('.chart-container');
                    if(container.querySelector('canvas')) return;
                    const chart = LightweightCharts.createChart(container, {
                        layout: { background: { color: 'transparent' }, textColor: '#6b7280' },
                        grid: { vertLines: { color: '#1f2937' }, horzLines: { color: '#1f2937' } },
                        timeScale: { visible: true }, rightPriceScale: { borderVisible: false }
                    });
                    const series = chart.addLineSeries({ color: '#3b82f6', lineWidth: 2 });
                    const wData = App.data.history[symbol]?.w1 || [];
                    series.setData(wData.map(x => ({time: x.t/1000, value: x.c})));
                    chart.timeScale().fitContent();
                },

                toggleDetails: (el) => {
                    const card = el.parentElement;
                    const details = card.querySelector('.card-details');
                    document.querySelectorAll('.card-details').forEach(d => { if(d !== details) d.classList.add('hidden'); });
                    details.classList.toggle('hidden');
                    if(!details.classList.contains('hidden')) {
                        const s = card.dataset.symbol;
                        App.UI.fillDetails(card, s, App.data.metrics[s], App.data.market[s]);
                    }
                },

                updateTables: () => {
                    const list = App.data.tokens.map(t => ({
                        ...t, 
                        m: App.data.metrics[t.s] || {score:0, discountAth:0, percentile:50, potential3y: 0, asymmetry: 0},
                        p: App.data.market[t.s]?.p || 0
                    })).sort((a,b) => b.m.score - a.m.score).slice(0, 10); // TOP 10

                    const tbody = document.getElementById('opportunity-list');
                    tbody.innerHTML = list.map((item, i) => `
                        <tr class="hover:bg-white/5 border-b border-gray-800/50 transition-colors cursor-pointer" onclick="document.querySelector('.card[data-symbol=${item.s}]').scrollIntoView({behavior:'smooth'}); App.UI.toggleDetails(document.querySelector('.card[data-symbol=${item.s}] > div'))">
                            <td class="p-3 text-center text-gray-500 font-mono">#${i+1}</td>
                            <td class="p-3 font-bold">
                                <span class="text-white">${item.n}</span>
                                <span class="text-[10px] text-gray-500 block">${item.s.replace('USDT','')}</span>
                            </td>
                            <td class="p-3 text-right font-mono text-gray-300">$${item.p < 1 ? item.p.toFixed(4) : item.p.toFixed(2)}</td>
                            <td class="p-3 text-center">
                                <span class="px-2 py-1 rounded text-[10px] font-bold ${item.m.score > 70 ? 'bg-green-900/40 text-green-400' : item.m.score < 40 ? 'bg-red-900/40 text-red-400' : 'bg-gray-800 text-gray-400'}">${item.m.score}</span>
                            </td>
                            <td class="p-3 text-center text-[10px] font-mono ${item.m.asymmetry > 3 ? 'text-green-400' : 'text-gray-500'}">
                                ${item.m.asymmetry.toFixed(1)}x
                            </td>
                            <td class="p-3 text-right font-mono text-xs text-blue-400">
                                $${item.m.potential3y < 1 ? item.m.potential3y.toFixed(4) : item.m.potential3y.toLocaleString(undefined, {maximumFractionDigits:0})}
                            </td>
                        </tr>
                    `).join('');
                },

                updateStats: () => {
                    let totalScore=0, counts={buy:0, hold:0, sell:0};
                    let golden=0, death=0;
                    if(!App.data.tokens.length) return;
                    App.data.tokens.forEach(t => {
                        const m = App.data.metrics[t.s];
                        if(!m) return;
                        totalScore += m.score;
                        if(m.score >= 60) counts.buy++; else if(m.score <= 30) counts.sell++; else counts.hold++;
                        if(m.macroTrend === 'GOLDEN') golden++; else death++;
                    });
                    document.getElementById('global-score').innerText = (totalScore / App.data.tokens.length).toFixed(0);
                    document.getElementById('stat-buy').innerText = counts.buy;
                    document.getElementById('stat-buy').className = counts.buy > 0 ? 'text-green-400 font-bold' : 'text-gray-500';
                    document.getElementById('stat-hold').innerText = counts.hold;
                    document.getElementById('stat-sell').innerText = counts.sell;
                    document.getElementById('macro-trend-stats').innerHTML = 
                        `<span class="text-yellow-400">GOLDEN: ${golden}</span> <span class="text-gray-500">BEAR: ${death}</span>`;
                },

                setupTooltips: () => {
                    const ov = document.getElementById('metric-tooltip-overlay');
                    document.body.addEventListener('mouseover', e => {
                        const t = e.target.closest('[data-tip]');
                        if(t) {
                            const info = App.Library[t.dataset.tip];
                            if(info) {
                                ov.innerHTML = `
                                    <div class="flex-1 min-w-[280px] lg:border-r border-gray-800 lg:pr-6">
                                        <h4 class="text-blue-500 font-bold text-lg mb-2">${info.t}</h4>
                                        <p class="text-sm text-gray-300">${info.d}</p>
                                    </div>
                                    <div class="flex-1 min-w-[250px] lg:pl-6">
                                        <div class="bg-blue-900/20 border border-blue-500/30 p-3 rounded-lg">
                                            <div class="tip-label text-blue-400">Dica Pr√°tica</div>
                                            <p class="text-xs text-blue-100 italic">"${info.hint}"</p>
                                        </div>
                                    </div>`;
                                ov.classList.remove('tooltip-hidden'); ov.classList.add('tooltip-visible');
                            }
                        }
                    });
                    document.body.addEventListener('mouseout', e => { if(e.target.closest('[data-tip]')) { ov.classList.add('tooltip-hidden'); ov.classList.remove('tooltip-visible'); } });
                }
            },
            
            Token: {
                addPrompt: () => {
                    const input = prompt("Par Binance (ex: AVAX):"); if(!input) return;
                    let s = input.toUpperCase().trim(); if(!s.endsWith('USDT')) s+='USDT';
                    App.data.tokens.push({s, n: s.replace('USDT','')}); localStorage.setItem('holder_tokens', JSON.stringify(App.data.tokens)); location.reload();
                },
                remove: (btn) => {
                    if(!confirm('Remover?')) return;
                    const s = btn.closest('.card').dataset.symbol;
                    App.data.tokens = App.data.tokens.filter(t => t.s !== s); localStorage.setItem('holder_tokens', JSON.stringify(App.data.tokens)); location.reload();
                }
            }
        };

        window.onload = App.Core.init;
    </script>
</body>
</html>
