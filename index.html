<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CryptoPanel HOLDER PRO v4.6 - Master Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        dark: { 950: '#05070a', 900: '#0b0e14', 800: '#151a23', 700: '#232a3b', 600: '#374151' },
                        zone: { 0: '#22c55e', 20: '#84cc16', 40: '#facc15', 60: '#f97316', 80: '#ef4444', 100: '#7e22ce' }
                    },
                    animation: { 'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite', 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        /* Mobile & Base Styles */
        body { background-color: #05070a; color: #e5e7eb; overflow-x: hidden; padding-bottom: 120px; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #0b0e14; }
        ::-webkit-scrollbar-thumb { background: #232a3b; border-radius: 2px; }
        
        .glass { background: rgba(11, 14, 20, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        /* Tooltip Overlay Mobile-First */
        #metric-tooltip-overlay { 
            position: fixed; bottom: 0; left: 0; right: 0;
            height: auto; max-height: 80vh;
            background-color: #0b0e14;
            border-top: 2px solid #3b82f6;
            box-shadow: 0 -10px 60px rgba(0,0,0,0.95);
            z-index: 9999;
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex; flex-direction: column; gap: 1rem;
        }
        @media(min-width: 1024px) { #metric-tooltip-overlay { flex-direction: row; max-height: 40vh; } }

        .tooltip-hidden { transform: translateY(110%); opacity: 0; pointer-events: none; }
        .tooltip-visible { transform: translateY(0); opacity: 1; pointer-events: auto; }

        .tip-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; color: #60a5fa; font-weight: 800; margin-bottom: 4px; border-bottom: 1px solid rgba(96, 165, 250, 0.2); display: inline-block; }
        .tip-val { font-size: 0.85rem; color: #d1d5db; line-height: 1.5; }
        
        .risk-btn { transition: all 0.3s; opacity: 0.5; border: 1px solid transparent; }
        .risk-btn.active { opacity: 1; border-color: currentColor; background: rgba(255,255,255,0.05); }

        .zone-indicator-bar { height: 6px; width: 100%; display: flex; border-radius: 3px; overflow: hidden; margin-top: 4px; background: #1f2937; }
        .zone-seg { height: 100%; transition: opacity 0.3s; opacity: 0.3; }
        .zone-seg.active { opacity: 1; box-shadow: 0 0 10px currentColor; }
        
        .card-enter { animation: slideUp 0.5s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .table-scroller { overflow-y: auto; overflow-x: auto; max-height: 350px; scrollbar-width: thin; }
        .modal-bg { background-color: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
        
        /* Ajustes Mobile */
        @media(max-width: 640px) {
            .mobile-stack { flex-direction: column; align-items: stretch; }
            .mobile-hide { display: none; }
            .card-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col font-sans selection:bg-brand-500 selection:text-white">

    <div id="connection-error" class="hidden bg-red-900/90 text-white p-4 text-center text-sm border-b border-red-500 sticky top-0 z-[100]">
        <p class="font-bold"><i class="fa-solid fa-triangle-exclamation mr-2"></i> Erro de Conex√£o Detectado</p>
        <p class="mt-1 opacity-90">Este sistema precisa de um servidor local para acessar as APIs (Binance/CoinGecko).</p>
        <p class="mt-2 text-xs font-mono bg-black/30 p-1 inline-block rounded">Instale a extens√£o "Live Server" no VS Code e clique com bot√£o direito -> Open with Live Server.</p>
    </div>

    <header class="glass sticky top-0 z-50 border-b border-gray-800 shadow-lg">
        <div class="max-w-[1800px] mx-auto px-4 py-3 flex flex-wrap items-center justify-between gap-3">
            <div class="flex items-center gap-3 w-full sm:w-auto justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 bg-gradient-to-br from-blue-600 to-indigo-900 rounded-lg flex items-center justify-center shadow-lg border border-blue-500/30 cursor-help" onclick="App.UI.showTip('sys_logo')">
                        <i class="fa-solid fa-gem text-white text-sm"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg text-white tracking-tight leading-tight">HOLDER PRO <span class="text-[10px] bg-blue-900/50 px-1 rounded text-blue-300 border border-blue-800">v4.6</span></h1>
                        <div class="flex items-center gap-2 text-[9px] text-gray-400 font-mono cursor-help" onclick="App.UI.showTip('sys_update')">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                            <span id="last-update">Conectando...</span>
                        </div>
                    </div>
                </div>
                <div class="sm:hidden flex flex-col items-end cursor-help" onclick="App.UI.showTip('sys_refresh')">
                    <span class="text-[8px] text-gray-600 font-bold uppercase">Update</span>
                    <span id="countdown-mobile" class="text-xs font-mono font-bold text-blue-500">60s</span>
                </div>
            </div>
            
            <div class="flex items-center gap-2 w-full sm:w-auto justify-end overflow-x-auto pb-1 sm:pb-0">
                <div class="flex bg-dark-800 rounded-lg p-0.5 border border-gray-700 mr-2 shrink-0">
                    <button onclick="App.Core.setRiskMode('conservative')" class="risk-btn active px-2 py-1 text-[9px] font-bold rounded text-green-400 uppercase tracking-wider" id="btn-conservative">Defesa</button>
                    <button onclick="App.Core.setRiskMode('moderate')" class="risk-btn px-2 py-1 text-[9px] font-bold rounded text-yellow-400 uppercase tracking-wider" id="btn-moderate">Mod.</button>
                    <button onclick="App.Core.setRiskMode('aggressive')" class="risk-btn px-2 py-1 text-[9px] font-bold rounded text-red-400 uppercase tracking-wider" id="btn-aggressive">Ataque</button>
                </div>

                <div class="hidden sm:flex flex-col items-end mr-2 cursor-help" onclick="App.UI.showTip('sys_refresh')">
                    <span class="text-[8px] text-gray-500 uppercase tracking-widest">Refresh</span>
                    <span id="countdown" class="text-xs font-mono font-bold text-blue-500">60s</span>
                </div>
                
                <button onclick="App.Token.addPrompt()" class="bg-blue-600 hover:bg-blue-500 text-white w-8 h-8 flex items-center justify-center rounded-lg shadow-lg hover:shadow-blue-500/20 shrink-0" onclick="App.UI.showTip('act_add_token')"><i class="fa-solid fa-plus"></i></button>
                <button onclick="App.Alerts.openModal()" class="bg-dark-800 border border-gray-700 text-gray-400 hover:text-yellow-400 w-8 h-8 flex items-center justify-center rounded-lg shrink-0" onclick="App.UI.showTip('act_alerts')"><i class="fa-solid fa-bell"></i></button>
                <button onclick="if(confirm('Resetar sistema?')) { localStorage.clear(); location.reload(); }" class="bg-dark-800 border border-gray-700 text-gray-400 hover:text-red-400 w-8 h-8 flex items-center justify-center rounded-lg shrink-0"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>
    </header>

    <div class="bg-dark-900 border-b border-gray-800 py-2 shadow-inner">
        <div class="max-w-[1800px] mx-auto px-4 overflow-x-auto no-scrollbar" onclick="App.UI.showTip('legend_zones')">
            <div class="flex gap-4 text-[9px] uppercase font-bold tracking-wider text-gray-500 whitespace-nowrap min-w-max">
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-zone-0"></span> Acumula√ß√£o Forte</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-zone-20"></span> Acumula√ß√£o</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-zone-40"></span> Pre√ßo Justo</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-zone-60"></span> Sobrepre√ßo</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-zone-80"></span> Risco Extremo</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-zone-100"></span> Mania (>100%)</span>
            </div>
        </div>
    </div>

    <main class="flex-1 max-w-[1800px] mx-auto px-4 py-6 w-full flex flex-col gap-6">
        
        <section id="alerts-panel" class="glass rounded-xl overflow-hidden border border-purple-500/30 flex flex-col shadow-lg alert-panel mb-4">
            <div class="bg-purple-900/20 p-3 border-b border-purple-500/30 flex justify-between items-center alert-header">
                <h3 class="text-purple-400 font-bold text-sm flex items-center gap-2 cursor-pointer" onclick="App.UI.showTip('panel_alerts_title')"><i class="fa-solid fa-bell"></i> Monitor de Alertas</h3>
                <button onclick="App.Alerts.openModal()" class="px-3 py-1 bg-purple-600 hover:bg-purple-500 text-white rounded-lg text-xs alert-button">+ Alerta</button>
            </div>
            <div class="p-3 bg-dark-900/50">
                <div id="alertsContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 max-h-40 overflow-y-auto">
                    <div class="text-gray-500 text-xs italic p-2 text-center">Nenhum alerta configurado.</div>
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <div class="glass rounded-xl overflow-hidden border border-gray-800 flex flex-col shadow-lg lg:col-span-2 h-[450px]">
                <div class="bg-dark-800/50 p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 class="text-white font-bold text-sm flex items-center gap-2 cursor-pointer" onclick="App.UI.showTip('panel_ranking')"><i class="fa-solid fa-list-ol text-blue-500"></i> Top 10 Oportunidades</h3>
                    <span id="current-mode-label" class="text-[10px] text-gray-500 bg-dark-900 px-2 py-1 rounded border border-gray-700 hidden sm:inline-block">Modo: Conservador</span>
                </div>
                <div class="flex-1 table-scroller">
                    <table class="w-full text-left text-xs min-w-[600px]">
                        <thead class="bg-dark-950 text-gray-500 sticky top-0 z-10 font-bold">
                            <tr>
                                <th class="p-3 text-center">#</th>
                                <th class="p-3 cursor-pointer" onclick="App.UI.showTip('col_asset')">Ativo</th>
                                <th class="p-3 text-right cursor-pointer" onclick="App.UI.showTip('col_price')">Pre√ßo</th>
                                <th class="p-3 text-center cursor-pointer" onclick="App.UI.showTip('col_score')">Score</th>
                                <th class="p-3 text-center cursor-pointer" onclick="App.UI.showTip('quant_asymmetry')">Assimetria</th>
                                <th class="p-3 text-right cursor-pointer" onclick="App.UI.showTip('quant_potential')">Potencial (Cap)</th>
                            </tr>
                        </thead>
                        <tbody id="opportunity-list" class="divide-y divide-gray-800 text-gray-300">
                            <tr><td colspan="6" class="p-4 text-center text-gray-500 animate-pulse">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="glass rounded-xl overflow-hidden border border-gray-800 flex flex-col shadow-lg h-[450px]">
                <div class="bg-dark-800/50 p-4 border-b border-gray-700">
                    <h3 class="text-white font-bold text-sm flex items-center gap-2 cursor-pointer" onclick="App.UI.showTip('panel_pulse')"><i class="fa-solid fa-bolt text-yellow-500"></i> Pulso 24h</h3>
                </div>
                <div class="flex-1 flex flex-col">
                    <div class="p-2 bg-dark-900 text-[10px] font-bold text-green-500 uppercase tracking-wider text-center border-b border-gray-800 cursor-pointer" onclick="App.UI.showTip('pulse_gainers')">Maiores Altas</div>
                    <div class="flex-1 overflow-y-auto" id="list-gainers"></div>
                    
                    <div class="p-2 bg-dark-900 text-[10px] font-bold text-red-500 uppercase tracking-wider text-center border-y border-gray-800 cursor-pointer" onclick="App.UI.showTip('pulse_losers')">Maiores Baixas</div>
                    <div class="flex-1 overflow-y-auto" id="list-losers"></div>
                </div>
            </div>

            <div class="glass rounded-xl overflow-hidden border border-gray-800 flex flex-col shadow-lg h-[450px]">
                <div class="bg-dark-800/50 p-4 border-b border-gray-700">
                    <h3 class="text-white font-bold text-sm flex items-center gap-2 cursor-pointer" onclick="App.UI.showTip('panel_stats')"><i class="fa-solid fa-chart-pie text-purple-500"></i> Quant Stats</h3>
                </div>
                <div class="p-6 flex flex-col gap-6 items-center flex-1 overflow-y-auto">
                    <div class="text-center w-full pb-4 border-b border-gray-800">
                        <div class="text-4xl font-bold text-white mb-1 cursor-pointer" id="global-score" onclick="App.UI.showTip('stat_global_score')">--</div>
                        <div class="text-xs text-gray-500 uppercase tracking-widest">Score M√©dio Global</div>
                    </div>
                    <div class="w-full space-y-3">
                        <div class="flex justify-between text-xs text-gray-400"><span>Oportunidades</span><span id="stat-buy" class="text-white font-bold">0</span></div>
                        <div class="flex justify-between text-xs text-gray-400"><span>Neutros</span><span id="stat-hold" class="text-white font-bold">0</span></div>
                        <div class="flex justify-between text-xs text-gray-400"><span>Venda</span><span id="stat-sell" class="text-white font-bold">0</span></div>
                    </div>
                    <div class="w-full pt-4">
                        <div class="text-[9px] text-gray-500 uppercase text-center mb-1 cursor-pointer" onclick="App.UI.showTip('quant_macro_trend')">Tend√™ncia Macro (EMA Cross)</div>
                        <div class="flex justify-center gap-2 text-xs font-bold" id="macro-trend-stats">
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex items-center justify-between mt-4">
            <h2 class="text-lg font-bold text-white cursor-pointer" onclick="App.UI.showTip('grid_title')">An√°lise Quantitativa</h2>
            <div class="text-xs text-gray-500 hidden sm:block"><i class="fa-solid fa-info-circle mr-1"></i> Dados: Binance + CoinGecko (H√≠brido)</div>
        </div>
        
        <div id="cards-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6 pb-20">
            </div>

    </main>

    <div id="alertsModal" class="fixed inset-0 z-[120] hidden modal-bg flex items-center justify-center p-4">
        <div class="bg-dark-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-md sm:max-w-2xl overflow-hidden mx-2">
            <div class="bg-dark-800 p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-white font-bold">Criar Alerta de Pre√ßo</h3>
                <button onclick="App.Alerts.closeModal()" class="text-gray-500 hover:text-white p-2"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Token</label>
                        <select id="alert-symbol" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white outline-none"></select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Tipo</label>
                        <select id="alert-type" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white outline-none">
                            <option value="buy">Alerta de COMPRA (Se cair para...)</option>
                            <option value="sell">Alerta de VENDA (Se subir para...)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Pre√ßo Alvo (USDT)</label>
                        <input type="number" id="alert-price" step="0.0001" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white outline-none" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Notas (Opcional)</label>
                        <textarea id="alert-notes" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white outline-none" rows="2" placeholder="Ex: Comprar suporte Fibonacci..."></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button onclick="App.Alerts.closeModal()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg">Cancelar</button>
                    <button onclick="App.Alerts.createAlert()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg">Salvar Alerta</button>
                </div>
            </div>
        </div>
    </div>

    <div id="metric-tooltip-overlay" class="tooltip-hidden" onclick="App.UI.hideTip()"></div>

    <template id="card-template">
        <div class="card glass rounded-xl overflow-hidden hover:border-blue-500/50 transition-all duration-300 card-enter flex flex-col group relative" data-symbol="">
            <div class="p-5 relative z-10 bg-gradient-to-b from-dark-800/50 to-transparent cursor-pointer" onclick="App.UI.toggleDetails(this)">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-3">
                        <div class="relative">
                            <div class="score-circle w-12 h-12 rounded-full border-4 flex items-center justify-center text-sm font-bold bg-dark-900 z-10 relative shadow-lg" onclick="event.stopPropagation(); App.UI.showTip('metric_score')">--</div>
                        </div>
                        <div>
                            <h3 class="font-bold text-white text-xl symbol-ticker leading-none tracking-tight" onclick="event.stopPropagation(); App.UI.showTip('card_ticker')">BTC</h3>
                            <div class="flex gap-1 mt-1 flex-wrap">
                                <div class="dilution-badge text-[8px] font-bold uppercase px-1.5 py-0.5 rounded bg-gray-800 text-gray-500" onclick="event.stopPropagation(); App.UI.showTip('quant_dilution')">FDV: --</div>
                                <div class="macro-badge text-[8px] font-bold uppercase px-1.5 py-0.5 rounded bg-gray-800 text-gray-500" onclick="event.stopPropagation(); App.UI.showTip('quant_macro_trend')">TREND: --</div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-mono font-bold text-white price-display" onclick="event.stopPropagation(); App.UI.showTip('metric_price')">$0.00</div>
                        <button onclick="event.stopPropagation(); App.Alerts.openForCard(this)" class="text-gray-500 hover:text-yellow-400 transition-colors mt-1 p-2" onclick="event.stopPropagation(); App.UI.showTip('act_quick_alert')"><i class="fa-regular fa-bell"></i></button>
                    </div>
                </div>

                <div class="flex justify-between text-[10px] font-mono text-gray-400 mb-3 border-b border-gray-800/50 pb-2">
                    <div class="text-center" onclick="event.stopPropagation(); App.UI.showTip('quant_asymmetry')">Assimetria <span class="val-asym font-bold text-white">--</span></div>
                    <div class="text-center" onclick="event.stopPropagation(); App.UI.showTip('metric_var24h')">24h <span class="var-24h font-bold">--</span></div>
                    <div class="text-center" onclick="event.stopPropagation(); App.UI.showTip('quant_vol_regime')">Regime <span class="val-regime font-bold">--</span></div>
                </div>

                <div class="mb-4" onclick="event.stopPropagation(); App.UI.showTip('zone_position')">
                    <div class="zone-indicator-bar bg-dark-900">
                        <div class="zone-seg w-1/6 bg-zone-0"></div><div class="zone-seg w-1/6 bg-zone-20"></div><div class="zone-seg w-1/6 bg-zone-40"></div>
                        <div class="zone-seg w-1/6 bg-zone-60"></div><div class="zone-seg w-1/6 bg-zone-80"></div><div class="zone-seg w-1/6 bg-zone-100"></div>
                    </div>
                    <div class="relative w-full h-2 mt-[-8px]">
                        <div class="absolute top-0 w-0.5 h-4 bg-white shadow-[0_0_10px_white] transition-all duration-1000 price-needle" style="left: 50%"></div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2 pt-2">
                    <div class="text-center" onclick="event.stopPropagation(); App.UI.showTip('quant_cheapness')">
                        <div class="text-[9px] text-gray-500 uppercase">Log-Cheapness</div>
                        <div class="text-xs font-bold text-white val-cheap">--%</div>
                    </div>
                    <div class="text-center" onclick="event.stopPropagation(); App.UI.showTip('metric_rsi_macro')">
                        <div class="text-[9px] text-gray-500 uppercase">Macro RSI</div>
                        <div class="text-xs font-bold text-white val-rsi">--</div>
                    </div>
                    <div class="text-center" onclick="event.stopPropagation(); App.UI.showTip('quant_potential')">
                        <div class="text-[9px] text-gray-500 uppercase">Alvo 3A (Teto)</div>
                        <div class="text-xs font-bold text-blue-400 val-pot3y">--</div>
                    </div>
                </div>
            </div>

            <div class="card-details hidden bg-dark-900 border-t border-gray-800 p-5 space-y-5 animate-fade-in">
                <div class="bg-dark-950 p-3 rounded border border-gray-800/50">
                    <h4 class="text-[10px] text-blue-500 font-bold uppercase mb-2">An√°lise Quantitativa</h4>
                    <p class="text-xs text-gray-300 leading-relaxed analysis-text mb-3">Calculando...</p>
                    <div class="grid grid-cols-2 gap-2 text-[10px] font-mono border-t border-gray-800 pt-2">
                        <div onclick="event.stopPropagation(); App.UI.showTip('fib_buy')">
                            <div class="text-gray-500">Zona Ouro (0.618)</div>
                            <div class="text-yellow-400 font-bold val-fib-gold">--</div>
                        </div>
                        <div class="text-right" onclick="event.stopPropagation(); App.UI.showTip('fib_deep')">
                            <div class="text-gray-500">Fundo (0.786)</div>
                            <div class="text-green-400 font-bold val-fib-deep">--</div>
                        </div>
                    </div>
                </div>
                <div class="h-40 w-full bg-black rounded border border-gray-800 chart-container"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h5 class="text-[9px] text-gray-500 uppercase font-bold mb-2">Hist√≥rico</h5>
                        <div class="space-y-1 text-[10px]">
                            <div class="flex justify-between" onclick="event.stopPropagation(); App.UI.showTip('metric_ath')"><span class="text-gray-600">ATH:</span> <span class="text-gray-300 val-ath">--</span></div>
                            <div class="flex justify-between" onclick="event.stopPropagation(); App.UI.showTip('metric_atl')"><span class="text-gray-600">ATL:</span> <span class="text-gray-300 val-atl">--</span></div>
                            <div class="flex justify-between" onclick="event.stopPropagation(); App.UI.showTip('metric_vola')"><span class="text-gray-600">Volatilidade:</span> <span class="text-gray-300 val-vola">--</span></div>
                        </div>
                    </div>
                    <div>
                        <h5 class="text-[9px] text-gray-500 uppercase font-bold mb-2">Fundamentos</h5>
                        <div class="space-y-1 text-[10px]">
                            <div class="flex justify-between" onclick="event.stopPropagation(); App.UI.showTip('metric_mcap')"><span class="text-gray-600">Mcap:</span> <span class="text-gray-300 val-mcap-full">--</span></div>
                            <div class="flex justify-between" onclick="event.stopPropagation(); App.UI.showTip('metric_fdv')"><span class="text-gray-600">FDV:</span> <span class="text-gray-300 val-fdv">--</span></div>
                        </div>
                    </div>
                </div>
                <button class="w-full py-2 bg-red-900/20 hover:bg-red-900/40 text-red-500 text-xs rounded border border-red-900/30 transition-colors" onclick="App.Token.remove(this)">Remover da Watchlist</button>
            </div>
        </div>
    </template>

    <script>
        const CONFIG = {
            refreshInterval: 600,
            wsThrottle: 5000,
            historyDays: 1400,
            volatilityWindow: 180,
            cgMapping: {
                'BTCUSDT': 'bitcoin', 'ETHUSDT': 'ethereum', 'SOLUSDT': 'solana', 'BNBUSDT': 'binancecoin',
                'ADAUSDT': 'cardano', 'XRPUSDT': 'ripple', 'DOTUSDT': 'polkadot', 'DOGEUSDT': 'dogecoin',
                'AVAXUSDT': 'avalanche-2', 'MATICUSDT': 'matic-network', 'LINKUSDT': 'chainlink',
                'UNIUSDT': 'uniswap', 'LTCUSDT': 'litecoin', 'ATOMUSDT': 'cosmos', 'NEARUSDT': 'near',
                'APTUSDT': 'aptos', 'ARBUSDT': 'arbitrum', 'OPUSDT': 'optimism', 'RNDRUSDT': 'render-token'
            },
            defaultTokens: [
                {s: 'BTCUSDT', n: 'Bitcoin'}, 
                {s: 'ETHUSDT', n: 'Ethereum'}, 
                {s: 'SOLUSDT', n: 'Solana'}, 
                {s: 'BNBUSDT', n: 'BNB'}
            ]
        };

        const App = {
            data: {
                tokens: JSON.parse(localStorage.getItem('holder_tokens')) || CONFIG.defaultTokens,
                alerts: JSON.parse(localStorage.getItem('holder_alerts')) || [],
                history: {},
                fundamentals: {}, 
                metrics: {},
                market: {},
                riskMode: 'conservative',
                lastUpdate: 0
            },

            // --- BIBLIOTECA EDUCACIONAL (100% COVERAGE) ---
            Library: {
                'mode_conservative': { t: 'Modo Conservador (Defesa)', d: 'Prioriza Valuation (pre√ßo barato) e Fundamentos s√≥lidos. O Score s√≥ sobe se o ativo estiver em "promo√ß√£o" real.', hint: 'Ideal para acumula√ß√£o em Bear Markets ou prote√ß√£o de patrim√¥nio.' },
                'mode_moderate': { t: 'Modo Moderado (Padr√£o)', d: 'Equil√≠brio entre Valor, Ciclo e Momentum. Reflete a estrat√©gia cl√°ssica de Swing Trade de longo prazo.', hint: 'Use como base para a maioria das decis√µes.' },
                'mode_aggressive': { t: 'Modo Agressivo (Ataque)', d: 'Prioriza Momentum e Tend√™ncia. O Score sobe mais r√°pido quando o pre√ßo come√ßa a andar.', hint: 'Use no in√≠cio de Bull Runs confirmadas.' },
                'quant_asymmetry': { t: 'Assimetria 2.0 (Ajustada)', d: 'C√°lculo de Risco/Retorno profissional: (Upside at√© ATH / Downside at√© ATL), penalizado pela volatilidade e infla√ß√£o do token.', hint: 'Uma assimetria acima de 5x ajustada √© o "Santo Graal" do Holder.' },
                'quant_macro_trend': { t: 'Tend√™ncia Macro (EMA Cross)', d: 'Cruzamento das M√©dias M√≥veis Semanais de 50 e 100 per√≠odos. Define se o mercado est√° em Alta Secular ou Baixa.', hint: 'GOLDEN (50>100) = Tend√™ncia de alta de longo prazo. DEATH (50<100) = Acumula√ß√£o ou Queda.' },
                'metric_rsi_macro': { t: 'RSI Macro (Suavizado)', d: 'Combina√ß√£o ponderada do RSI 14 Semanal (70%) e RSI 28 Semanal (30%). Remove ru√≠dos de semanas vol√°teis.', hint: 'Muito mais confi√°vel que o RSI padr√£o. Abaixo de 35 √© zona de compra hist√≥rica.' },
                'quant_cheapness': { t: '√çndice de "Barateza" (Log)', d: 'Percentil hist√≥rico calculado em escala logar√≠tmica. Mede o qu√£o barato o ativo est√° comparado √† sua pr√≥pria hist√≥ria, ignorando picos irreais.', hint: 'Acima de 80% indica que o pre√ßo est√° nas m√≠nimas hist√≥ricas reais.' },
                'quant_potential': { t: 'Potencial 3 Anos (Teto)', d: 'Proje√ß√£o matem√°tica de crescimento exponencial baseada na volatilidade hist√≥rica, mas limitada a 10x o Market Cap atual para manter o realismo.', hint: 'Evita proje√ß√µes fantasiosas de "trilh√µes de d√≥lares" para moedas pequenas.' },
                'quant_dilution': { t: 'Risco de Dilui√ß√£o (Inflation)', d: 'Rela√ß√£o entre Valor Dilu√≠do (FDV) e Valor de Mercado (Mcap). Indica quantos tokens ainda ser√£o despejados no mercado.', hint: 'Valor > 3.0 √© perigoso (muita infla√ß√£o por vir). Valor < 1.2 √© excelente (quase tudo em circula√ß√£o).' },
                'quant_vol_regime': { t: 'Regime de Volatilidade', d: 'Compara a volatilidade atual com a m√©dia hist√≥rica. "Compress√£o" significa que o pre√ßo est√° calmo demais e deve explodir em breve.', hint: 'Compre na Compress√£o (calmaria), Venda na Expans√£o (caos).' },
                'sys_logo': { t: 'CryptoPanel Holder Master', d: 'Vers√£o v4.6 Final. Sistema de intelig√™ncia quantitativa para investidores de longo prazo.', hint: 'Foque nos dados, ignore o ru√≠do.' },
                'sys_update': { t: 'Sincroniza√ß√£o de Dados', d: 'Status da conex√£o com Binance (Pre√ßos) e CoinGecko (Fundamentos).', hint: 'Se parar de piscar, verifique sua conex√£o.' },
                'act_add_token': { t: 'Adicionar Ativo', d: 'Insira o par da Binance (ex: AVAX) para iniciar o monitoramento.', hint: 'O sistema busca automaticamente o hist√≥rico.' },
                'act_alerts': { t: 'Gerenciar Alertas', d: 'Abra o painel para criar notifica√ß√µes de pre√ßo customizadas.', hint: 'Use alertas para n√£o precisar ficar olhando o gr√°fico todo dia.' },
                'act_reset': { t: 'Resetar Sistema', d: 'Limpa todos os dados locais e restaura a lista padr√£o.', hint: 'Use se notar algum bug de dados.' },
                'metric_score': { t: 'Score Holder 2.0', d: 'Nota final de 0 a 100, ponderada pelo seu perfil de risco (Defesa/Ataque).', hint: 'Verde (>70) = Compra. Vermelho (<40) = Venda.' },
                'card_ticker': { t: 'Ativo Monitorado', d: 'Par de negocia√ß√£o principal em USDT.', hint: 'Clique no card para ver detalhes profundos.' },
                'metric_price': { t: 'Pre√ßo Atual', d: '√öltima negocia√ß√£o registrada na Binance.', hint: 'Atualiza via WebSocket em tempo real.' },
                'act_quick_alert': { t: 'Alerta R√°pido', d: 'Cria um alerta para este ativo instantaneamente.', hint: '' },
                'metric_var24h': { t: 'Varia√ß√£o 24h', d: 'Mudan√ßa de pre√ßo no √∫ltimo dia.', hint: 'Serve para medir o pulso de curto prazo.' },
                'zone_position': { t: 'Term√¥metro de Ciclo', d: 'Onde estamos no ciclo de 4 anos? Esquerda (Verde) = Fundo. Direita (Vermelho/Roxo) = Topo.', hint: 'Nunca compre na zona roxa (Mania).' },
                'fib_buy': { t: 'Fibonacci 0.618', d: 'A "Propor√ß√£o √Åurea". N√≠vel de suporte mais forte em tend√™ncias de alta.', hint: '√ìtimo ponto para ordens limitadas de compra.' },
                'fib_deep': { t: 'Fibonacci 0.786', d: 'N√≠vel de "√öltima Chance". Se perder aqui, a tend√™ncia inverte.', hint: 'Compra agressiva com stop curto.' },
                'metric_ath': { t: 'Topo Hist√≥rico (ATH)', d: 'O maior pre√ßo j√° atingido.', hint: 'Alvo final de um Bull Market.' },
                'metric_atl': { t: 'Fundo Hist√≥rico (ATL)', d: 'O menor pre√ßo j√° atingido.', hint: 'Suporte final catastr√≥fico.' },
                'metric_vola': { t: 'Volatilidade (180d)', d: 'Risco medido pela oscila√ß√£o m√©dia em 6 meses.', hint: 'Value Investing prefere ativos est√°veis ou em compress√£o.' },
                'metric_mcap': { t: 'Market Cap', d: 'Valor total do projeto (Pre√ßo x Circulante).', hint: 'Projetos gigantes movem-se mais devagar.' },
                'metric_fdv': { t: 'Fully Diluted Valuation', d: 'Valor do projeto se todos os tokens existissem hoje.', hint: 'Importante para projetos novos com alta infla√ß√£o.' },
                'sys_refresh': { t: 'Pr√≥xima Atualiza√ß√£o', d: 'Tempo at√© recarregar dados on-chain pesados.', hint: 'O pre√ßo atualiza em tempo real, fundamentos a cada 10min.' },
                'legend_zones': { t: 'Legenda de Zonas', d: 'Guia de cores para o Term√¥metro de Ciclo. Vai de Compra Forte (Verde) at√© Mania/Bolha (Roxo).', hint: '' },
                'panel_alerts_title': { t: 'Painel de Alertas', d: 'Lista seus alertas ativos e dist√¢ncia para o alvo.', hint: '' },
                'panel_ranking': { t: 'Ranking Quant', d: 'Lista ordenada pela qualidade matem√°tica da oportunidade.', hint: 'Foque no Top 3.' },
                'col_asset': { t: 'Ativo', d: 'S√≠mbolo.', hint: '' }, 'col_price': { t: 'Pre√ßo', d: 'Valor atual.', hint: '' }, 'col_score': { t: 'Score', d: 'Nota Quant.', hint: '' },
                'col_discount': { t: 'Potencial', d: 'Proje√ß√£o 3 anos.', hint: '' },
                'panel_pulse': { t: 'Pulso de Mercado', d: 'Quem est√° se movendo hoje.', hint: '' },
                'pulse_gainers': { t: 'Altas', d: '', hint: '' }, 'pulse_losers': { t: 'Baixas', d: '', hint: '' },
                'panel_stats': { t: 'Estat√≠sticas', d: 'Resumo da carteira.', hint: '' },
                'stat_global_score': { t: 'Score Global', d: 'M√©dia do mercado.', hint: '<30 = Oportunidade Geracional.' },
                'grid_title': { t: 'Grid de Ativos', d: 'Vis√£o detalhada.', hint: '' }
            },

            // --- CORE & LOGIC ---
            Core: {
                checkEnv: () => {
                    if (window.location.protocol === 'file:') {
                        document.getElementById('connection-error').classList.remove('hidden');
                    }
                },
                init: async () => {
                    App.Core.checkEnv();
                    App.UI.renderGrid();
                    App.Alerts.renderList();
                    await App.Core.refreshAll();
                    App.Core.startWS();
                    setInterval(App.Core.refreshAll, CONFIG.refreshInterval * 1000);
                    setInterval(() => {
                        let el = document.getElementById('countdown');
                        let elMob = document.getElementById('countdown-mobile');
                        let next = App.data.lastUpdate + (CONFIG.refreshInterval * 1000);
                        let remain = Math.max(0, Math.ceil((next - Date.now()) / 1000));
                        if(el) el.innerText = remain + 's';
                        if(elMob) elMob.innerText = remain + 's';
                    }, 1000);
                },
                setRiskMode: (mode) => {
                    App.data.riskMode = mode;
                    document.querySelectorAll('.risk-btn').forEach(b => b.classList.remove('active', 'border-white'));
                    document.getElementById(`btn-${mode}`).classList.add('active', 'border-white');
                    document.getElementById('current-mode-label').innerText = `Modo: ${mode.charAt(0).toUpperCase() + mode.slice(1)}`;
                    for(let t of App.data.tokens) App.Analysis.calc(t.s);
                    App.UI.updateAll();
                },
                refreshAll: async () => {
                    const statusEl = document.getElementById('last-update');
                    statusEl.innerText = "üîÑ Calc...";
                    statusEl.className = "text-yellow-500 animate-pulse";
                    try {
                        for(let t of App.data.tokens) await App.Core.fetchHistory(t.s);
                        await App.Core.fetchFundamentals();
                        for(let t of App.data.tokens) App.Analysis.calc(t.s);
                        App.data.lastUpdate = Date.now();
                        statusEl.innerText = new Date().toLocaleTimeString();
                        statusEl.className = "";
                        App.UI.updateAll();
                        App.Alerts.check();
                    } catch (error) { console.error(error); statusEl.innerText = "Erro"; statusEl.className = "text-red-500"; }
                },
                fetchHistory: async (symbol) => {
                    try {
                        let r1 = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1d&limit=${CONFIG.historyDays}`);
                        let d1 = await r1.json();
                        let r2 = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1w&limit=200`);
                        let d2 = await r2.json();
                        App.data.history[symbol] = { d1: d1.map(x=>({t:x[0],c:+x[4]})), w1: d2.map(x=>({t:x[0],c:+x[4]})) };
                    } catch(e) { console.warn("Binance API error", e); }
                },
                fetchFundamentals: async () => {
                    try {
                        const ids = App.data.tokens.map(t => CONFIG.cgMapping[t.s] || '').filter(x => x).join(',');
                        if(!ids) return;
                        const res = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${ids}&order=market_cap_desc&sparkline=false`);
                        const data = await res.json();
                        data.forEach(coin => {
                            const binanceSymbol = Object.keys(CONFIG.cgMapping).find(key => CONFIG.cgMapping[key] === coin.id);
                            if(binanceSymbol) {
                                App.data.fundamentals[binanceSymbol] = {
                                    mcap: coin.market_cap, fdv: coin.fully_diluted_valuation || coin.market_cap,
                                    ath: coin.ath, atl: coin.atl, supply: coin.circulating_supply
                                };
                            }
                        });
                    } catch(e) { console.warn("CoinGecko API Limit/Error", e); }
                },
                startWS: () => {
                    try {
                        const ws = new WebSocket("wss://stream.binance.com:9443/ws/!ticker@arr");
                        let lastDraw = 0;
                        ws.onmessage = (e) => {
                            const data = JSON.parse(e.data);
                            let needsUpdate = false;
                            data.forEach(t => {
                                if(App.data.tokens.find(k => k.s === t.s)) {
                                    App.data.market[t.s] = { p: +t.c, P: +t.P, q: +t.q };
                                    needsUpdate = true;
                                }
                            });
                            if(needsUpdate && (Date.now() - lastDraw > CONFIG.wsThrottle)) {
                                App.UI.updatePricesOnly();
                                lastDraw = Date.now();
                            }
                        };
                    } catch(e) { console.error("WS Error", e); }
                }
            },

            Indicators: {
                sma: (arr, p) => arr.length < p ? arr[arr.length-1] : arr.slice(-p).reduce((a,b)=>a+b,0)/p,
                ema: (arr, p) => {
                    if (arr.length < p) return null;
                    const k = 2 / (p + 1);
                    let ema = arr.slice(0, p).reduce((a, b) => a + b, 0) / p;
                    for (let i = p; i < arr.length; i++) { ema = (arr[i] - ema) * k + ema; }
                    return ema;
                },
                rsiWilder: (arr, p=14) => {
                    if (arr.length <= p) return 50;
                    let avgGain=0, avgLoss=0;
                    for(let i=1; i<=p; i++) { let c = arr[i]-arr[i-1]; if(c>0) avgGain+=c; else avgLoss+=Math.abs(c); }
                    avgGain/=p; avgLoss/=p;
                    for(let i=p+1; i<arr.length; i++) {
                        let c = arr[i]-arr[i-1];
                        avgGain = ((avgGain*(p-1)) + (c>0?c:0))/p;
                        avgLoss = ((avgLoss*(p-1)) + (c<0?Math.abs(c):0))/p;
                    }
                    return avgLoss===0 ? 100 : 100-(100/(1+(avgGain/avgLoss)));
                },
                volatilityLog: (arr, w=180) => {
                    if(arr.length < w+1) return 0;
                    let logs = [];
                    for(let i=arr.length-w; i<arr.length; i++) logs.push(Math.log(arr[i]/arr[i-1]));
                    const mean = logs.reduce((a,b)=>a+b,0)/logs.length;
                    const variance = logs.reduce((a,b)=>a+Math.pow(b-mean,2),0)/logs.length;
                    return Math.sqrt(variance)*Math.sqrt(365)*100;
                }
            },

            Analysis: {
                calc: (symbol) => {
                    const h = App.data.history[symbol];
                    const fund = App.data.fundamentals[symbol];
                    const mkt = App.data.market[symbol];
                    if(!h || !h.d1.length || !mkt) return;

                    const closesD = h.d1.map(x => x.c);
                    const closesW = h.w1.map(x => x.c);
                    const currentPrice = mkt.p;
                    const ath = fund ? fund.ath : Math.max(...closesD);
                    const atl = fund ? fund.atl : Math.min(...closesD);

                    // 1. Valuation Logar√≠tmico
                    const logCloses = closesD.map(p => Math.log(p));
                    const currentLog = Math.log(currentPrice);
                    const sortedLogs = [...logCloses].sort((a,b) => a-b);
                    let rank = sortedLogs.findIndex(x => x >= currentLog);
                    if (rank === -1) rank = 0; 
                    const percentile = (rank / sortedLogs.length) * 100;
                    const cheapness = 100 - percentile;
                    const scoreVal = Math.max(0, cheapness);

                    // 2. Assimetria 2.0
                    const upside = Math.max(0, ath - currentPrice);
                    const downside = Math.max(1, currentPrice - atl);
                    const rawAsymmetry = downside > 0 ? (upside / downside) : 50;
                    const volAvg = App.Indicators.volatilityLog(closesD, 180);
                    const dilutionRisk = (fund && fund.mcap > 0) ? fund.fdv / fund.mcap : 1.0;
                    const volFactor = Math.max(1, volAvg / 50); 
                    const dilutionFactor = Math.max(1, dilutionRisk);
                    const asymmetry = rawAsymmetry / (dilutionFactor * volFactor);

                    // 3. RSI Macro
                    const rsi14 = App.Indicators.rsiWilder(closesW, 14);
                    const rsi28 = App.Indicators.rsiWilder(closesW, 28);
                    const rsiMacro = (rsi14 * 0.7) + (rsi28 * 0.3);
                    let scoreCycle = rsiMacro <= 30 ? 100 : rsiMacro >= 80 ? 0 : 100 - ((rsiMacro - 30) * 2);

                    // 4. Fundamentos
                    let scoreFund = 50;
                    if(fund) {
                        if(dilutionRisk < 1.2) scoreFund += 20; 
                        else if(dilutionRisk > 3.0) scoreFund -= 20;
                        if(((ath-currentPrice)/ath) > 0.9) scoreFund -= 10;
                    }

                    // 5. T√©cnico Macro
                    const sma200 = App.Indicators.sma(closesD, 200);
                    const ema50w = App.Indicators.ema(closesW, 50);
                    const ema100w = App.Indicators.ema(closesW, 100);
                    let macroTrend = "Neutro";
                    let scoreTech = 50;
                    if (ema50w && ema100w) {
                        if (ema50w > ema100w) { macroTrend = "GOLDEN"; scoreTech += 20; } 
                        else { macroTrend = "DEATH"; if (percentile < 20) scoreTech += 30; else scoreTech -= 10; }
                    }

                    // PESOS DIN√ÇMICOS
                    let wVal=0.45, wFun=0.30, wCyc=0.15, wTec=0.10;
                    if(App.data.riskMode === 'moderate') { wVal=0.35; wFun=0.25; wCyc=0.25; wTec=0.15; }
                    if(App.data.riskMode === 'aggressive') { wVal=0.20; wFun=0.10; wCyc=0.40; wTec=0.30; }

                    const finalScore = (scoreVal * wVal) + (scoreCycle * wCyc) + (scoreFund * wFun) + (scoreTech * wTec);
                    
                    const range = ath - atl;
                    const buyZone1 = ath - (range * 0.618);
                    const buyZone2 = ath - (range * 0.786);

                    // Potencial Log Capped
                    const volNorm = volAvg / 100; 
                    const growthRate = 0.2 + (volNorm * 0.5); 
                    const scoreFactor = finalScore / 50; 
                    let potential = currentPrice * Math.exp(growthRate * 3 * scoreFactor);
                    if (fund && fund.mcap > 0) {
                        const maxPrice = currentPrice * 10;
                        potential = Math.min(potential, maxPrice);
                    }

                    const volRegime = App.Indicators.volatilityLog(closesD, 30) < volAvg ? "Compress√£o" : "Expans√£o";

                    App.data.metrics[symbol] = {
                        score: Math.round(finalScore),
                        percentile, cheapness, asymmetry, dilutionRisk, volRegime,
                        rsiW: rsiMacro, sma200, ema50w, ema100w, macroTrend,
                        ath, atl, discountAth: ((ath - currentPrice)/ath)*100,
                        volatility: volAvg, potential3y: potential,
                        mcap: fund ? fund.mcap : 0, fdv: fund ? fund.fdv : 0,
                        fibGold: buyZone1, fibDeep: buyZone2
                    };
                }
            },

            // UI ENGINE (RESPONSIVE & TOOLTIPS)
            UI: {
                showTip: (key) => {
                    const info = App.Library[key];
                    if(!info) return;
                    const ov = document.getElementById('metric-tooltip-overlay');
                    ov.innerHTML = `
                        <div class="flex-1 min-w-[280px] lg:border-r border-gray-800 lg:pr-6">
                            <h4 class="text-blue-500 font-bold text-lg mb-2">${info.t}</h4>
                            <p class="text-sm text-gray-300 leading-relaxed">${info.d}</p>
                        </div>
                        <div class="flex-1 min-w-[250px] lg:pl-6 pt-4 lg:pt-0">
                            <div class="bg-blue-900/20 border border-blue-500/30 p-3 rounded-lg">
                                <div class="tip-label text-blue-400">Dica Pr√°tica</div>
                                <p class="text-xs text-blue-100 italic">"${info.hint}"</p>
                            </div>
                        </div>`;
                    ov.classList.remove('tooltip-hidden'); ov.classList.add('tooltip-visible');
                },
                hideTip: () => {
                    const ov = document.getElementById('metric-tooltip-overlay');
                    ov.classList.add('tooltip-hidden'); ov.classList.remove('tooltip-visible');
                },
                setupTooltips: () => { /* Now uses click handler on elements directly */ },
                
                renderGrid: () => {
                    const grid = document.getElementById('cards-grid');
                    grid.innerHTML = '';
                    App.data.tokens.forEach(t => {
                        const clone = document.getElementById('card-template').content.cloneNode(true);
                        const card = clone.querySelector('.card');
                        card.dataset.symbol = t.s;
                        card.querySelector('.symbol-ticker').innerText = t.n;
                        grid.appendChild(card);
                    });
                },

                updateAll: () => {
                    App.UI.updatePricesOnly();
                    App.UI.updateTables();
                    App.UI.updateStats();
                    App.UI.updateMarketPulse();
                },

                updatePricesOnly: () => {
                    App.data.tokens.forEach(t => {
                        const m = App.data.metrics[t.s];
                        const p = App.data.market[t.s];
                        const card = document.querySelector(`.card[data-symbol="${t.s}"]`);
                        if(!card || !p) return;

                        card.querySelector('.price-display').innerText = '$' + (p.p < 1 ? p.p.toFixed(4) : p.p.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                        
                        const setVar = (sel, val) => {
                            const el = card.querySelector(sel);
                            el.innerText = (val>0?'+':'') + val.toFixed(1) + '%';
                            el.className = `font-bold ${sel.replace('.','')} ${val>=0 ? 'text-green-400' : 'text-red-400'}`;
                        };
                        setVar('.var-24h', p.P);

                        if(!m) return;

                        const scoreEl = card.querySelector('.score-circle');
                        scoreEl.innerText = m.score;
                        scoreEl.className = `score-circle w-12 h-12 rounded-full border-4 flex items-center justify-center text-sm font-bold z-10 relative shadow-lg transition-colors duration-500
                            ${m.score >= 70 ? 'bg-zone-0 text-black border-green-900' : 
                              m.score >= 40 ? 'bg-zone-40 text-black border-yellow-900' : 
                              'bg-zone-80 text-white border-red-900'}`;

                        const needle = card.querySelector('.price-needle');
                        const pVis = Math.min(100, Math.max(2, m.percentile));
                        needle.style.left = `${pVis}%`;
                        needle.style.backgroundColor = m.percentile > 80 ? '#ef4444' : '#22c55e';
                        
                        card.querySelector('.dilution-badge').innerText = `FDV: ${m.dilutionRisk.toFixed(1)}x`;
                        card.querySelector('.macro-badge').innerText = m.macroTrend || 'WAIT';
                        card.querySelector('.macro-badge').className = `macro-badge text-[9px] font-bold uppercase px-1.5 py-0.5 rounded cursor-help ${m.macroTrend === 'GOLDEN' ? 'bg-yellow-900 text-yellow-400' : 'bg-gray-800 text-gray-500'}`;

                        card.querySelector('.val-cheap').innerText = m.cheapness.toFixed(0) + '%';
                        card.querySelector('.val-asym').innerText = m.asymmetry.toFixed(1) + 'x';
                        card.querySelector('.val-regime').innerText = m.volRegime;
                        card.querySelector('.val-regime').className = `val-regime font-bold ${m.volRegime === 'Compress√£o' ? 'text-green-400' : 'text-red-400'}`;

                        const formatUSD = (v) => v >= 1e9 ? `$${(v/1e9).toFixed(1)}B` : v >= 1e6 ? `$${(v/1e6).toFixed(0)}M` : '-';
                        card.querySelector('.val-mcap-mini').innerText = m.mcap ? formatUSD(m.mcap) : '-';
                        card.querySelector('.val-pot3y').innerText = m.potential3y ? '$'+(m.potential3y<1?m.potential3y.toFixed(4):m.potential3y.toLocaleString(undefined,{maximumFractionDigits:0})) : '-';

                        card.querySelector('.val-rsi').innerText = m.rsiW.toFixed(0);
                        card.querySelector('.val-rsi').className = `text-xs font-bold val-rsi ${m.rsiW < 30 ? 'text-green-400 animate-pulse' : m.rsiW > 70 ? 'text-red-400' : 'text-white'}`;

                        if(!card.querySelector('.card-details').classList.contains('hidden')) {
                            App.UI.fillDetails(card, t.s, m, p);
                        }
                    });
                },

                fillDetails: (card, s, m, p) => {
                    const formatUSD = (v) => v >= 1e9 ? `$${(v/1e9).toFixed(2)}B` : `$${(v/1e6).toFixed(2)}M`;
                    let action = m.score > 70 ? "COMPRA" : m.score < 40 ? "VENDA" : "AGUARDE";
                    card.querySelector('.analysis-text').innerText = 
                        `Score ${m.score} (${App.data.riskMode}). Tend√™ncia Macro: ${m.macroTrend}. Assimetria: ${m.asymmetry.toFixed(1)}x. Regime: ${m.volRegime}. A√ß√£o sugerida: ${action}.`;
                    card.querySelector('.val-fib-gold').innerText = `$${m.fibGold.toLocaleString(undefined, {maximumFractionDigits:2})}`;
                    card.querySelector('.val-fib-deep').innerText = `$${m.fibDeep.toLocaleString(undefined, {maximumFractionDigits:2})}`;
                    card.querySelector('.val-ath').innerText = '$'+m.ath.toLocaleString();
                    card.querySelector('.val-atl').innerText = m.atl ? '$'+m.atl.toLocaleString() : 'N/A';
                    card.querySelector('.val-vola').innerText = m.volatility.toFixed(1) + '%';
                    card.querySelector('.val-mcap-full').innerText = m.mcap ? formatUSD(m.mcap) : 'N/A';
                    card.querySelector('.val-fdv').innerText = m.fdv ? formatUSD(m.fdv) : 'N/A';
                    App.UI.renderChart(card, s);
                },

                updateMarketPulse: () => {
                    const all = App.data.tokens.map(t => ({n: t.n, P: App.data.market[t.s]?.P || 0}));
                    const gainers = [...all].sort((a,b) => b.P - a.P).slice(0, 5);
                    const losers = [...all].sort((a,b) => a.P - b.P).slice(0, 5);
                    const mkRow = (i) => `<div class="flex justify-between p-2 text-xs border-b border-gray-800/50 hover:bg-white/5"><span>${i.n}</span><span class="font-mono font-bold ${i.P>=0?'text-green-400':'text-red-400'}">${i.P>0?'+':''}${i.P.toFixed(2)}%</span></div>`;
                    document.getElementById('list-gainers').innerHTML = gainers.map(mkRow).join('');
                    document.getElementById('list-losers').innerHTML = losers.map(mkRow).join('');
                },

                renderChart: (card, symbol) => {
                    const container = card.querySelector('.chart-container');
                    if(container.querySelector('canvas')) return;
                    const chart = LightweightCharts.createChart(container, {
                        layout: { background: { color: 'transparent' }, textColor: '#6b7280' },
                        grid: { vertLines: { color: '#1f2937' }, horzLines: { color: '#1f2937' } },
                        timeScale: { visible: true }, rightPriceScale: { borderVisible: false }
                    });
                    const series = chart.addLineSeries({ color: '#3b82f6', lineWidth: 2 });
                    const wData = App.data.history[symbol]?.w1 || [];
                    series.setData(wData.map(x => ({time: x.t/1000, value: x.c})));
                    chart.timeScale().fitContent();
                },

                toggleDetails: (el) => {
                    const card = el.parentElement;
                    const details = card.querySelector('.card-details');
                    document.querySelectorAll('.card-details').forEach(d => { if(d !== details) d.classList.add('hidden'); });
                    details.classList.toggle('hidden');
                    if(!details.classList.contains('hidden')) {
                        const s = card.dataset.symbol;
                        App.UI.fillDetails(card, s, App.data.metrics[s], App.data.market[s]);
                    }
                },

                updateTables: () => {
                    const list = App.data.tokens.map(t => ({
                        ...t, 
                        m: App.data.metrics[t.s] || {score:0, discountAth:0, percentile:50, potential3y: 0, asymmetry: 0},
                        p: App.data.market[t.s]?.p || 0
                    })).sort((a,b) => b.m.score - a.m.score).slice(0, 10);

                    const tbody = document.getElementById('opportunity-list');
                    tbody.innerHTML = list.map((item, i) => `
                        <tr class="hover:bg-white/5 border-b border-gray-800/50 transition-colors cursor-pointer" onclick="document.querySelector('.card[data-symbol=${item.s}]').scrollIntoView({behavior:'smooth'}); App.UI.toggleDetails(document.querySelector('.card[data-symbol=${item.s}] > div'))">
                            <td class="p-3 text-center text-gray-500 font-mono">#${i+1}</td>
                            <td class="p-3 font-bold">
                                <span class="text-white">${item.n}</span>
                                <span class="text-[10px] text-gray-500 block">${item.s.replace('USDT','')}</span>
                            </td>
                            <td class="p-3 text-right font-mono text-gray-300">$${item.p < 1 ? item.p.toFixed(4) : item.p.toFixed(2)}</td>
                            <td class="p-3 text-center">
                                <span class="px-2 py-1 rounded text-[10px] font-bold ${item.m.score > 70 ? 'bg-green-900/40 text-green-400' : item.m.score < 40 ? 'bg-red-900/40 text-red-400' : 'bg-gray-800 text-gray-400'}">${item.m.score}</span>
                            </td>
                            <td class="p-3 text-center text-[10px] font-mono ${item.m.asymmetry > 3 ? 'text-green-400' : 'text-gray-500'}">
                                ${item.m.asymmetry.toFixed(1)}x
                            </td>
                            <td class="p-3 text-right font-mono text-xs text-blue-400">
                                $${item.m.potential3y < 1 ? item.m.potential3y.toFixed(4) : item.m.potential3y.toLocaleString(undefined, {maximumFractionDigits:0})}
                            </td>
                        </tr>
                    `).join('');
                },

                updateStats: () => {
                    let totalScore=0, counts={buy:0, hold:0, sell:0};
                    let golden=0, death=0;
                    if(!App.data.tokens.length) return;
                    App.data.tokens.forEach(t => {
                        const m = App.data.metrics[t.s];
                        if(!m) return;
                        totalScore += m.score;
                        if(m.score >= 60) counts.buy++; else if(m.score <= 30) counts.sell++; else counts.hold++;
                        if(m.macroTrend === 'GOLDEN') golden++; else death++;
                    });
                    document.getElementById('global-score').innerText = (totalScore / App.data.tokens.length).toFixed(0);
                    document.getElementById('stat-buy').innerText = counts.buy;
                    document.getElementById('stat-buy').className = counts.buy > 0 ? 'text-green-400 font-bold' : 'text-gray-500';
                    document.getElementById('stat-hold').innerText = counts.hold;
                    document.getElementById('stat-sell').innerText = counts.sell;
                    document.getElementById('macro-trend-stats').innerHTML = 
                        `<span class="text-yellow-400">GOLDEN: ${golden}</span> <span class="text-gray-500">BEAR: ${death}</span>`;
                },

                getZoneColor: (pct) => pct<20?'#22c55e':pct<40?'#84cc16':pct<60?'#facc15':pct<80?'#f97316':pct<100?'#ef4444':'#7e22ce'
            },
            
            Alerts: { /* Mantida igual */
                saveToStorage: () => localStorage.setItem("holder_alerts", JSON.stringify(App.data.alerts)),
                openModal: (btn = null) => {
                    const modal = document.getElementById('alertsModal');
                    const symbolSelect = document.getElementById('alert-symbol');
                    symbolSelect.innerHTML = '<option value="">Selecione um token</option>';
                    App.data.tokens.forEach(t => { const o = document.createElement('option'); o.value = t.s; o.textContent = t.n; symbolSelect.appendChild(o); });
                    if (btn) { const card = btn.closest('.card'); if (card) symbolSelect.value = card.dataset.symbol; }
                    document.getElementById('alert-price').value = ''; document.getElementById('alert-notes').value = '';
                    modal.classList.remove('hidden');
                },
                closeModal: () => document.getElementById('alertsModal').classList.add('hidden'),
                openForCard: (btn) => App.Alerts.openModal(btn),
                createAlert: () => {
                    const symbol = document.getElementById('alert-symbol').value;
                    const type = document.getElementById('alert-type').value;
                    const price = parseFloat(document.getElementById('alert-price').value);
                    const notes = document.getElementById('alert-notes').value;
                    if (!symbol || !price) return alert('Preencha os dados!');
                    const mkt = App.data.market[symbol];
                    App.data.alerts.push({ id: Date.now(), symbol, type, targetPrice: price, initialPrice: mkt ? mkt.p : 0, notes, triggered: false });
                    App.Alerts.saveToStorage(); App.Alerts.renderList(); App.Alerts.closeModal();
                },
                remove: (id) => { App.data.alerts = App.data.alerts.filter(a => a.id !== id); App.Alerts.saveToStorage(); App.Alerts.renderList(); },
                check: () => {
                    let changed = false;
                    App.data.alerts.forEach(a => {
                        if(a.triggered) return;
                        const mkt = App.data.market[a.symbol];
                        if(!mkt) return;
                        let hit = (a.type === 'buy' && mkt.p <= a.targetPrice) || (a.type === 'sell' && mkt.p >= a.targetPrice);
                        if(hit) { a.triggered = true; changed = true; alert(`ALERTA: ${a.symbol} atingiu $${a.targetPrice}`); }
                    });
                    if(changed) { App.Alerts.saveToStorage(); App.Alerts.renderList(); }
                },
                renderList: () => {
                    const div = document.getElementById('alertsContent');
                    if(!App.data.alerts.length) { div.innerHTML = '<div class="text-gray-500 text-xs italic p-2 text-center">Nenhum alerta configurado.</div>'; return; }
                    div.innerHTML = App.data.alerts.map(a => {
                        const mkt = App.data.market[a.symbol];
                        const curr = mkt ? mkt.p : a.initialPrice;
                        const dist = ((a.targetPrice - curr)/curr)*100;
                        return `<div class="bg-dark-800 border ${a.triggered ? 'border-green-500' : 'border-gray-700'} p-2 rounded relative group"><div class="flex justify-between items-center mb-1"><span class="font-bold text-xs ${a.type==='buy'?'text-green-400':'text-red-400'}">${a.symbol.replace('USDT','')} ${a.type==='buy'?'C':'V'}</span><button onclick="App.Alerts.remove(${a.id})" class="text-gray-600 hover:text-red-500"><i class="fa-solid fa-times"></i></button></div><div class="flex justify-between text-[10px] font-mono"><span class="text-gray-400">Alvo: $${a.targetPrice}</span><span class="${a.triggered ? 'text-green-500 font-bold' : 'text-yellow-500'}">${a.triggered ? 'ATINGIDO' : dist.toFixed(1)+'%'}</span></div></div>`;
                    }).join('');
                }
            },
            
            Token: {
                addPrompt: () => {
                    const input = prompt("Par Binance (ex: AVAX):"); if(!input) return;
                    let s = input.toUpperCase().trim(); if(!s.endsWith('USDT')) s+='USDT';
                    App.data.tokens.push({s, n: s.replace('USDT','')}); localStorage.setItem('holder_tokens', JSON.stringify(App.data.tokens)); location.reload();
                },
                remove: (btn) => {
                    if(!confirm('Remover?')) return;
                    const s = btn.closest('.card').dataset.symbol;
                    App.data.tokens = App.data.tokens.filter(t => t.s !== s); localStorage.setItem('holder_tokens', JSON.stringify(App.data.tokens)); location.reload();
                }
            }
        };

        window.onload = App.Core.init;
    </script>
</body>
</html>
