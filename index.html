<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CryptoPanel HOLDER PRO - IA & Macro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        dark: { 950: '#05070a', 900: '#0b0e14', 800: '#151a23', 700: '#232a3b', 600: '#374151' },
                        holder: { accumulation: '#22c55e', holding: '#3b82f6', profit_taking: '#ef4444', dca_zone: '#8b5cf6' },
                        zone: { agressive: '#059669', moderate: '#10b981', fair: '#3b82f6', partial: '#f59e0b', full: '#ef4444' }
                    },
                    animation: { 
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'typewriter': 'typewriter 2s steps(40) 1s 1 normal both'
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #05070a; color: #e5e7eb; overflow-x: hidden; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #0b0e14; }
        ::-webkit-scrollbar-thumb { background: #232a3b; border-radius: 3px; }
        
        .glass { background: rgba(11, 14, 20, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .table-fixed-header thead { position: sticky; top: 0; z-index: 20; background-color: #0b0e14; }
        .compact-table th, .compact-table td { padding: 0.5rem 0.75rem !important; white-space: nowrap; } 
        
        /* Tooltips */
        #metric-tooltip-overlay { 
            position: fixed; bottom: 0; left: 0; right: 0; max-height: 85vh; background-color: #05070a;
            border-top: 2px solid #3b82f6; z-index: 9999; overflow-y: auto; padding: 1.5rem;
            display: flex; flex-direction: column; gap: 1.5rem; padding-bottom: max(2rem, env(safe-area-inset-bottom));
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        @media(min-width: 1024px) { #metric-tooltip-overlay { flex-direction: row; max-height: 40vh; gap: 2rem; } }
        .tooltip-hidden { transform: translateY(110%); opacity: 0; pointer-events: none; }
        .tooltip-visible { transform: translateY(0); opacity: 1; pointer-events: auto; }

        /* Holder Elements */
        .holder-phase-accumulation { border-left: 4px solid #22c55e; background: linear-gradient(90deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%); }
        .holder-phase-holding { border-left: 4px solid #3b82f6; background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%); }
        .holder-phase-profit { border-left: 4px solid #ef4444; background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%); }
        
        .historical-band { position: absolute; width: 100%; opacity: 0.1; z-index: 1; }
        .band-0-20 { background: #059669; height: 20%; bottom: 0; }
        .band-20-40 { background: #10b981; height: 20%; bottom: 20%; }
        .band-40-60 { background: #3b82f6; height: 20%; bottom: 40%; }
        .band-60-80 { background: #f59e0b; height: 20%; bottom: 60%; }
        .band-80-100 { background: #ef4444; height: 20%; bottom: 80%; }
        
        .zone-indicator { height: 4px; border-radius: 2px; margin: 2px 0; }
        .zone-0-20 { background: #059669; } .zone-20-40 { background: #10b981; } .zone-40-60 { background: #3b82f6; }
        .zone-60-80 { background: #f59e0b; } .zone-80-100 { background: #ef4444; }
        
        .ai-typing { border-right: 2px solid #3b82f6; animation: blink 0.75s step-end infinite; }
        @keyframes blink { 0%, 100% { border-color: transparent } 50% { border-color: #3b82f6 } }

        /* Mobile Menu */
        #mobile-menu-content { transition: max-height 0.3s ease-out, opacity 0.3s ease-out; max-height: 0; opacity: 0; overflow: hidden; }
        #mobile-menu-content.open { max-height: 400px; opacity: 1; }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col font-sans selection:bg-brand-500 selection:text-white">

    <header class="glass sticky top-0 z-50 border-b border-gray-800 shadow-lg">
        <div class="max-w-[1800px] mx-auto px-4 h-16 flex items-center justify-between flex-wrap sm:flex-nowrap gap-2 py-2">
            <div class="flex items-center gap-3 w-full sm:w-auto justify-between sm:justify-start">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-holder-accumulation to-holder-holding rounded-lg flex items-center justify-center shadow-lg shadow-green-500/20 cursor-help" data-tip="sys_logo">
                        <i class="fa-solid fa-brain text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-xl text-white tracking-tight">CP<span class="text-holder-accumulation">HOLDER</span> <span class="text-[10px] text-gray-500 border border-gray-700 rounded px-1 ml-1 align-top">IA</span></h1>
                        <div class="flex items-center gap-2 text-[10px] text-gray-400 font-mono mt-1">
                            <span class="hidden sm:inline">MACRO • BACKTEST • AI</span>
                            <span id="last-update" class="text-xs text-green-500">Online</span>
                        </div>
                    </div>
                </div>
                <button id="mobile-menu-toggle" class="sm:hidden p-2 text-gray-400 hover:text-white border border-gray-800 rounded bg-dark-800">
                    <i class="fa-solid fa-bars"></i>
                </button>
            </div>

            <div id="header-controls" class="hidden sm:flex items-center gap-3 w-full sm:w-auto justify-end mt-2 sm:mt-0 flex-wrap">
                <input id="searchToken" type="text" placeholder="Buscar ativo..." class="bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:border-holder-accumulation outline-none w-full sm:w-40 uppercase">
                <div class="hidden sm:flex flex-col items-end mr-2">
                    <span class="text-[9px] text-gray-500 uppercase tracking-widest">IA Engine</span>
                    <span id="countdown" class="text-xs font-mono font-bold text-holder-accumulation">Ready</span>
                </div>
                <div class="flex gap-2 w-full sm:w-auto justify-end">
                    <button onclick="App.Export.openModal()" class="p-2 bg-dark-800 hover:text-green-400 border border-gray-700 rounded-lg"><i class="fa-solid fa-file-excel"></i></button>
                    <button id="refreshData" class="group p-2 bg-holder-accumulation hover:bg-green-500 rounded-lg text-white shadow-lg"><i class="fa-solid fa-rotate group-hover:rotate-180 transition-transform duration-500"></i></button>
                    <button onclick="App.Settings.openModal()" class="p-2 bg-dark-800 hover:text-yellow-400 border border-gray-700 rounded-lg"><i class="fa-solid fa-gear"></i></button>
                </div>
            </div>
            
            <div id="mobile-menu-content" class="w-full sm:hidden border-t border-gray-800 mt-2 pt-2 space-y-3 pb-2 bg-dark-950 px-2 rounded-b-lg">
                <input id="searchTokenMobile" type="text" placeholder="BUSCAR ATIVO..." class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-3 text-sm text-white uppercase">
                <div class="flex justify-between items-center">
                    <span class="text-xs text-gray-500">Engine: <span class="text-holder-accumulation">Active</span></span>
                    <div class="flex gap-2">
                        <button onclick="App.Core.refreshData()" class="px-3 py-2 bg-holder-accumulation rounded text-white"><i class="fa-solid fa-rotate"></i></button>
                        <button onclick="App.Settings.openModal()" class="px-3 py-2 bg-dark-800 border border-gray-700 rounded text-gray-300"><i class="fa-solid fa-gear"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="bg-dark-900 border-b border-gray-800 py-3 shadow-inner overflow-hidden">
        <div class="max-w-[1800px] mx-auto px-4">
            <div class="flex gap-4 overflow-x-auto no-scrollbar items-center pb-1" id="macro-engine-strip">
                <div class="text-xs text-gray-500 animate-pulse">Carregando Macro Engine...</div>
            </div>
        </div>
    </div>

    <main class="flex-1 max-w-[1800px] mx-auto px-4 py-6 w-full gap-6 flex flex-col">
        
        <section class="glass rounded-xl overflow-hidden border border-gray-800 flex flex-col shadow-xl">
            <div class="bg-dark-800/80 p-4 border-b border-gray-700 flex justify-between items-center shrink-0">
                <h3 class="text-white font-bold text-sm flex items-center gap-2"><i class="fa-solid fa-star text-yellow-500"></i> Top 10 Oportunidades</h3>
                <span class="text-[10px] text-gray-500 bg-dark-900 px-2 py-1 rounded">OGC Score Active</span>
            </div>
            <div class="overflow-y-auto flex-1 scrollbar-thin table-fixed-header max-h-[50vh]">
                <table class="w-full text-left text-xs min-w-[800px] compact-table">
                    <thead class="text-gray-400 uppercase font-bold tracking-wider text-[10px] bg-dark-900">
                        <tr>
                            <th class="p-2 text-center">#</th>
                            <th class="p-2">Ativo</th>
                            <th class="p-2 text-center">Score</th>
                            <th class="p-2 text-center">OGC</th>
                            <th class="p-2 text-center">Zona</th>
                            <th class="p-2 text-center">Preço</th>
                            <th class="p-2 text-center">Assimetria</th>
                            <th class="p-2 text-center">IA Insight</th>
                        </tr>
                    </thead>
                    <tbody id="opportunities-body" class="divide-y divide-gray-800 text-gray-300"></tbody>
                </table>
            </div>
        </section>

        <div id="cards-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6 pb-20"></div>
    </main>

    <div id="metric-tooltip-overlay" class="tooltip-hidden"></div>

    <template id="card-template">
        <div class="card glass rounded-xl overflow-hidden hover:border-gray-500 transition-all duration-300 flex flex-col group shadow-lg holder-phase-holding" data-symbol="">
            <div class="p-4 cursor-pointer card-header relative z-10 bg-gradient-to-b from-dark-800/40 to-transparent" onclick="App.UI.toggleCard(this)">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-3">
                        <div class="relative w-10 h-10">
                            <div class="score-badge w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold text-black border border-white shadow-sm cursor-help" data-tip="m_score">--</div>
                        </div>
                        <div>
                            <h3 class="font-bold text-white text-lg symbol-ticker leading-none">BTC</h3>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="phase-badge text-[8px] font-bold uppercase px-1.5 py-0.5 rounded bg-gray-800 text-gray-500">--</span>
                                <span class="ogc-badge text-[8px] font-bold uppercase px-1.5 py-0.5 rounded bg-purple-900/30 text-purple-400 border border-purple-900/50" data-tip="ogc_score">OGC: --</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-mono font-bold text-white price-display">$0.00</div>
                        <div class="text-[10px] text-gray-400 mt-1 zone-text">Zona: --</div>
                    </div>
                </div>
                
                <div class="relative h-1.5 w-full bg-dark-900 rounded-full overflow-hidden flex mt-3">
                    <div class="zone-indicator zone-0-20 w-full"></div>
                    <div class="zone-indicator zone-20-40 w-full"></div>
                    <div class="zone-indicator zone-40-60 w-full"></div>
                    <div class="zone-indicator zone-60-80 w-full"></div>
                    <div class="zone-indicator zone-80-100 w-full"></div>
                    <div class="absolute top-0 bottom-0 w-0.5 bg-white shadow-[0_0_8px_rgba(255,255,255,0.8)] z-10 historical-indicator transition-all duration-1000" style="left: 50%;"></div>
                </div>
            </div>

            <div class="card-body hidden border-t border-gray-800 bg-dark-900 relative z-20 p-4">
                <div class="mb-4 bg-dark-800/50 border border-gray-700/50 rounded-lg p-3">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fa-solid fa-robot text-blue-400 text-xs"></i>
                        <span class="text-[10px] font-bold text-blue-400 uppercase">IA Interpretativa</span>
                    </div>
                    <p class="ai-text text-xs text-gray-300 leading-relaxed font-mono"></p>
                </div>

                <div class="h-40 w-full bg-black rounded border border-gray-800 chart-container mb-4"></div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-dark-950 p-2 rounded border border-gray-800">
                        <h5 class="text-[9px] text-gray-500 uppercase font-bold mb-1 border-b border-gray-800 pb-1">OGC (Crescimento Orgânico)</h5>
                        <div class="space-y-1 text-[10px] font-mono">
                            <div class="flex justify-between"><span class="text-gray-600">Diluição:</span><span class="ogc-dilution text-gray-300">--</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Ativ. Dev:</span><span class="ogc-dev text-gray-300">--</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Rede:</span><span class="ogc-net text-gray-300">--</span></div>
                            <div class="mt-2 text-center font-bold text-purple-400 ogc-total">Score: --/100</div>
                        </div>
                    </div>
                    
                    <div class="bg-dark-950 p-2 rounded border border-gray-800">
                        <h5 class="text-[9px] text-gray-500 uppercase font-bold mb-1 border-b border-gray-800 pb-1">Backtest (Zona 0-20)</h5>
                        <div class="space-y-1 text-[10px] font-mono">
                            <div class="flex justify-between"><span class="text-gray-600">Entradas (2a):</span><span class="bt-entries text-white">--</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Retorno Médio:</span><span class="bt-avg text-white">--</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Win Rate:</span><span class="bt-win text-green-400">--</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        const BINANCE_REST = "https://api.binance.com/api/v3/klines";
        const COINGECKO_API = "https://api.coingecko.com/api/v3";
        
        const HOLDER_CONFIG = {
            timeframes: ["1d", "1w"],
            ohlcLimits: { "1d": 730, "1w": 208 }
        };

        const App = {
            State: {
                tokens: JSON.parse(localStorage.getItem('holder_tokens')) || [
                    {symbol: 'BTCUSDT', name: 'Bitcoin', coinId: 'bitcoin'},
                    {symbol: 'ETHUSDT', name: 'Ethereum', coinId: 'ethereum'},
                    {symbol: 'SOLUSDT', name: 'Solana', coinId: 'solana'},
                    {symbol: 'LINKUSDT', name: 'Chainlink', coinId: 'chainlink'},
                    {symbol: 'AAVEUSDT', name: 'Aave', coinId: 'aave'}
                ],
                marketData: {}, ohlcData: {}, indicatorsData: {}, fundamentalsData: {}, scoreData: {},
                globalData: {} // Para MacroCycle
            },

            Library: {
                'm_score': { title: "Score HOLDER", what: "Pontuação composta 0-100.", interp: ">70: Compra" },
                'ogc_score': { title: "OGC Score", what: "Organic Growth Score. Mede a saúde real do projeto descontando a diluição inflacionária.", interp: "Alto: Crescimento real. Baixo: Inflação alta comendo preço." }
            },

            Core: {
                init: async () => {
                    App.UI.tooltips();
                    App.UI.setupMobile();
                    
                    // Init Modules
                    await App.Macro.init();
                    await App.Core.preloadAll();
                    
                    App.UI.grid();
                    App.Opportunities.generate();
                },

                preloadAll: async () => {
                    for (let t of App.State.tokens) {
                        await App.Core.fetchOHLC(t.symbol);
                        await App.Fundamentals.fetch(t);
                    }
                    App.State.tokens.forEach(t => {
                        App.Indicators.calc(t.symbol);
                        App.Score.calc(t.symbol);
                        App.OGC.calc(t.symbol); // Modulo 2
                    });
                    App.UI.updateAll();
                },

                fetchOHLC: async (symbol) => {
                    if(!App.State.ohlcData[symbol]) App.State.ohlcData[symbol] = {};
                    for(let tf of HOLDER_CONFIG.timeframes) {
                        try {
                            let r = await fetch(`${BINANCE_REST}?symbol=${symbol}&interval=${tf}&limit=${HOLDER_CONFIG.ohlcLimits[tf]}`);
                            let d = await r.json();
                            App.State.ohlcData[symbol][tf] = d.map(k=>({time:k[0],open:+k[1],high:+k[2],low:+k[3],close:+k[4]}));
                        } catch(e) { console.log(e); }
                    }
                    // Get current price
                    try {
                        let r = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`);
                        let d = await r.json();
                        if(!App.State.marketData[symbol.toLowerCase()]) App.State.marketData[symbol.toLowerCase()] = {};
                        App.State.marketData[symbol.toLowerCase()].lastPrice = +d.price;
                    } catch(e){}
                }
            },

            // 1) MODULE: MACRO CYCLE ENGINE
            Macro: {
                init: async () => {
                    try {
                        // Fetch Global Data (Dominance)
                        const r = await fetch(`${COINGECKO_API}/global`);
                        const d = await r.json();
                        const btcDom = d.data.market_cap_percentage.btc;
                        
                        // Halving Calc
                        const nextHalving = new Date('2028-04-18'); // Estimado
                        const daysLeft = Math.ceil((nextHalving - new Date()) / (1000 * 60 * 60 * 24));
                        
                        // MVRV Light (Proxy usando preço BTC vs SMA 200 * fator)
                        // Mock pois requer on-chain. Usamos desvio da SMA200 semanal como proxy de "sobreaquecimento"
                        const mvrvProxy = "1.45"; // Simulado para demo
                        
                        App.State.globalData = { btcDom, daysLeft, mvrvProxy };
                        App.Macro.render();
                    } catch(e) {
                        console.log("Macro Error", e);
                        App.State.globalData = { btcDom: 58.2, daysLeft: 1200, mvrvProxy: 1.2 }; // Fallback
                        App.Macro.render();
                    }
                },
                render: () => {
                    const d = App.State.globalData;
                    const el = document.getElementById('macro-engine-strip');
                    el.innerHTML = `
                        <div class="flex items-center gap-2 px-3 py-1 bg-dark-800 rounded border border-gray-700 whitespace-nowrap">
                            <i class="fa-brands fa-bitcoin text-orange-500"></i>
                            <span class="text-[10px] text-gray-400 uppercase">Dominância</span>
                            <span class="text-xs font-mono font-bold text-white">${d.btcDom.toFixed(1)}%</span>
                        </div>
                        <div class="flex items-center gap-2 px-3 py-1 bg-dark-800 rounded border border-gray-700 whitespace-nowrap">
                            <i class="fa-solid fa-hourglass-half text-blue-400"></i>
                            <span class="text-[10px] text-gray-400 uppercase">Halving</span>
                            <span class="text-xs font-mono font-bold text-white">${d.daysLeft}d</span>
                        </div>
                        <div class="flex items-center gap-2 px-3 py-1 bg-dark-800 rounded border border-gray-700 whitespace-nowrap">
                            <i class="fa-solid fa-fire text-red-400"></i>
                            <span class="text-[10px] text-gray-400 uppercase">MVRV (Proxy)</span>
                            <span class="text-xs font-mono font-bold ${d.mvrvProxy>2?'text-red-400':'text-green-400'}">${d.mvrvProxy}</span>
                        </div>
                        <div class="flex items-center gap-2 px-3 py-1 bg-dark-800 rounded border border-gray-700 whitespace-nowrap">
                            <i class="fa-solid fa-globe text-purple-400"></i>
                            <span class="text-[10px] text-gray-400 uppercase">Liq. Global</span>
                            <span class="text-xs font-mono font-bold text-white">Alta</span>
                        </div>
                    `;
                }
            },

            // 2) MODULE: OGC SCORE (Organic Growth)
            OGC: {
                calc: (symbol) => {
                    const fund = App.State.fundamentalsData[symbol] || {inflation: 2};
                    const ind = App.State.indicatorsData[symbol.toLowerCase()]?.["1d"];
                    
                    let score = 50;
                    
                    // Inflação/Diluição
                    if(fund.inflation < 2) score += 30;
                    else if(fund.inflation < 5) score += 10;
                    else if(fund.inflation > 10) score -= 20;
                    
                    // Variação vs BTC (Crescimento Real)
                    // Simulação: Se RSI alto e Volatilidade baixa = Bom organic
                    if(ind && ind.rsi > 50) score += 10;
                    
                    // Atividade Dev (Mock - Normalmente viria de API Github)
                    const devActivity = Math.random() > 0.5 ? 'Alta' : 'Média';
                    if(devActivity === 'Alta') score += 10;
                    
                    App.State.scoreData[symbol].ogc = {
                        score: Math.min(100, Math.max(0, score)),
                        dev: devActivity,
                        net: score > 60 ? 'Expandindo' : 'Estável'
                    };
                }
            },

            // 3) MODULE: BACKTEST HOLDER
            Backtest: {
                run: (symbol) => {
                    // Lógica: Comprar quando preço fecha na zona 0-20% no semanal
                    const data = App.State.ohlcData[symbol]["1w"];
                    if(!data || data.length < 50) return { entries: 0, avg: 0, win: 0 };
                    
                    const closes = data.map(c => c.close);
                    const zones = App.Indicators.getZones(closes); // Usar zonas atuais como ref (simplificação)
                    const buyZone = zones.z20;
                    
                    let entries = 0;
                    let totalReturn = 0;
                    let wins = 0;
                    const current = App.State.marketData[symbol.toLowerCase()].lastPrice;
                    
                    data.forEach((c, i) => {
                        // Simula compra se estiver na zona baixa e candle fechou
                        if(c.close <= buyZone) {
                            entries++;
                            const ret = ((current - c.close) / c.close) * 100;
                            totalReturn += ret;
                            if(ret > 0) wins++;
                        }
                    });
                    
                    return {
                        entries,
                        avg: entries > 0 ? (totalReturn / entries).toFixed(1) + '%' : '0%',
                        win: entries > 0 ? ((wins/entries)*100).toFixed(0) + '%' : '0%'
                    };
                }
            },

            // 4) MODULE: IA INTERPRETATIVA
            AI: {
                analyze: (symbol) => {
                    const s = symbol.toLowerCase();
                    const score = App.State.scoreData[symbol]?.total || 50;
                    const ogc = App.State.scoreData[symbol]?.ogc?.score || 50;
                    const ind = App.State.indicatorsData[s]?.["1d"];
                    const rsi = App.State.indicatorsData[s]?.["1w"]?.rsi || 50;
                    
                    let risk = "Médio";
                    let reward = "Médio";
                    let text = "";
                    
                    if(score > 70) {
                        risk = "Baixo"; reward = "Muito Alto";
                        text = `O ativo apresenta uma **oportunidade assimétrica**. Com um OGC de ${ogc}, o crescimento é orgânico. Historicamente, esta zona de acumulação precede movimentos de expansão. O RSI semanal em ${rsi.toFixed(0)} sugere que o fundo está próximo. Recomendação: DCA Agressivo.`;
                    } else if (score < 40) {
                        risk = "Alto"; reward = "Baixo";
                        text = `Cuidado. O ativo está esticado. O ciclo indica distribuição e o OGC sugere pressão inflacionária. Embora o hype esteja alto, o risco de correção supera o potencial de alta no curto prazo. Proteja capital.`;
                    } else {
                        text = `Zona de equilíbrio. O mercado está indeciso. É um bom momento para observar a dominância do BTC antes de alocar. Mantenha posições mas evite alavancagem.`;
                    }
                    
                    return { text, risk, reward };
                }
            },

            Fundamentals: {
                fetch: async (t) => {
                    // Mock fundamentals for demo (replacing heavy API call loop for speed)
                    App.State.fundamentalsData[t.symbol] = { inflation: (Math.random()*5 + 1), marketCap: 1000000000 };
                }
            },

            Indicators: {
                calc: (symbol) => {
                    const s = symbol.toLowerCase();
                    const d = App.State.ohlcData[symbol]["1d"];
                    const w = App.State.ohlcData[symbol]["1w"];
                    
                    if(!App.State.indicatorsData[s]) App.State.indicatorsData[s] = {};
                    
                    // Daily Calc
                    if(d) {
                        const closes = d.map(c=>c.close);
                        const sorted = [...closes].sort((a,b)=>a-b);
                        const curr = App.State.marketData[s]?.lastPrice || closes[closes.length-1];
                        const rank = sorted.filter(x => x < curr).length;
                        const pct = (rank/sorted.length)*100;
                        
                        App.State.indicatorsData[s]["1d"] = { pct, zone: App.Indicators.getZoneLabel(pct), close: curr };
                    }
                    
                    // Weekly Calc
                    if(w) {
                        const closes = w.map(c=>c.close);
                        App.State.indicatorsData[s]["1w"] = { rsi: App.Indicators.rsi(closes) };
                    }
                },
                getZones: (closes) => {
                    const s = [...closes].sort((a,b)=>a-b);
                    return { z20: s[Math.floor(s.length*0.2)] };
                },
                getZoneLabel: (p) => p<20?'Agressiva':p<40?'Moderada':p<60?'Justa':p<80?'Parcial':'Total',
                rsi: (closes) => {
                    if(closes.length<15) return 50;
                    let g=0, l=0;
                    for(let i=1; i<15; i++) { let d=closes[closes.length-i]-closes[closes.length-i-1]; d>0?g+=d:l-=d; }
                    return 100-(100/(1+(g/l)));
                }
            },

            Score: {
                calc: (symbol) => {
                    const ind = App.State.indicatorsData[symbol.toLowerCase()]["1d"];
                    let score = 50;
                    if(ind.pct < 20) score += 30;
                    else if(ind.pct > 80) score -= 20;
                    if(!App.State.scoreData[symbol]) App.State.scoreData[symbol] = {};
                    App.State.scoreData[symbol].total = score;
                }
            },

            Opportunities: {
                generate: () => {
                    const list = App.State.tokens.map(t => {
                        const s = t.symbol;
                        const score = App.State.scoreData[s]?.total || 50;
                        const ogc = App.State.scoreData[s]?.ogc?.score || 50;
                        const ind = App.State.indicatorsData[s.toLowerCase()]["1d"];
                        const ai = App.AI.analyze(s);
                        return { s, name: t.name, score, ogc, zone: ind.zone, price: ind.close, asymmetry: (score/20).toFixed(1), ai };
                    }).sort((a,b)=>b.score-a.score);
                    
                    const el = document.getElementById('opportunities-body');
                    el.innerHTML = list.map((o,i) => `
                        <tr class="table-row-hover border-b border-gray-800 cursor-pointer" onclick="App.UI.toggleCard(document.querySelector('.card[data-symbol=${o.s}]'))">
                            <td class="p-2 text-center text-gray-500 font-bold">${i+1}</td>
                            <td class="p-2 font-bold text-white">${o.s.replace('USDT','')}</td>
                            <td class="p-2 text-center font-bold ${o.score>70?'text-green-400':'text-blue-400'}">${o.score}</td>
                            <td class="p-2 text-center font-bold text-purple-400">${o.ogc}</td>
                            <td class="p-2 text-center text-gray-400 text-[10px]">${o.zone}</td>
                            <td class="p-2 text-center text-white font-mono">$${o.price.toFixed(2)}</td>
                            <td class="p-2 text-center text-green-400">${o.asymmetry}x</td>
                            <td class="p-2 text-center text-[9px] text-gray-500 italic max-w-[150px] truncate">${o.ai.text}</td>
                        </tr>
                    `).join('');
                }
            },

            UI: {
                setupMobile: () => {
                    const btn = document.getElementById('mobile-menu-toggle');
                    const menu = document.getElementById('mobile-menu-content');
                    btn.onclick = () => { menu.classList.toggle('open'); btn.innerHTML = menu.classList.contains('open') ? '<i class="fa-solid fa-times"></i>' : '<i class="fa-solid fa-bars"></i>'; };
                },
                tooltips: () => {
                    const ov = document.getElementById('metric-tooltip-overlay');
                    document.body.onclick = (e) => {
                        const t = e.target.closest('[data-tip]');
                        if(t) {
                            const d = App.Library[t.dataset.tip];
                            if(d) {
                                ov.innerHTML = `<h4 class="text-blue-400 font-bold mb-1">${d.title}</h4><p class="text-sm text-gray-300">${d.what}</p><div class="mt-2 text-xs text-green-400">${d.interp}</div>`;
                                ov.classList.remove('tooltip-hidden'); ov.classList.add('tooltip-visible');
                            }
                        } else if(!e.target.closest('#metric-tooltip-overlay')) {
                            ov.classList.remove('tooltip-visible'); ov.classList.add('tooltip-hidden');
                        }
                    }
                },
                grid: () => {
                    const g = document.getElementById('cards-grid');
                    g.innerHTML = '';
                    App.State.tokens.forEach(t => {
                        const tmpl = document.getElementById('card-template').content.cloneNode(true);
                        const c = tmpl.querySelector('.card');
                        c.dataset.symbol = t.symbol;
                        c.querySelector('.symbol-ticker').innerText = t.symbol.replace('USDT','');
                        g.appendChild(c);
                        App.UI.updateCard(t.symbol);
                    });
                },
                updateCard: (s) => {
                    const c = document.querySelector(`.card[data-symbol="${s}"]`);
                    if(!c) return;
                    const sl = s.toLowerCase();
                    const ind = App.State.indicatorsData[sl]["1d"];
                    const sc = App.State.scoreData[s];
                    
                    c.querySelector('.price-display').innerText = '$' + ind.close.toFixed(2);
                    c.querySelector('.zone-text').innerText = 'Zona: ' + ind.zone;
                    c.querySelector('.score-badge').innerText = sc.total;
                    c.querySelector('.score-badge').className = `score-badge w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold text-black border border-white shadow-sm cursor-help ${sc.total>70?'bg-holder-accumulation':sc.total<40?'bg-holder-profit_taking':'bg-holder-holding'}`;
                    
                    const bar = c.querySelector('.historical-indicator');
                    if(bar) bar.style.left = ind.pct + '%';
                    
                    const ph = ind.pct<20?'accumulation':ind.pct>80?'profit_taking':'holding';
                    c.className = `card glass rounded-xl overflow-hidden hover:border-gray-500 transition-all duration-300 flex flex-col group shadow-lg holder-phase-${ph}`;
                    c.querySelector('.phase-badge').innerText = ph;
                    
                    // Update OGC Badge
                    if(sc.ogc) c.querySelector('.ogc-badge').innerText = `OGC: ${sc.ogc.score}`;
                },
                updateAll: () => App.State.tokens.forEach(t => App.UI.updateCard(t.symbol)),
                toggleCard: (el) => {
                    const c = el.closest('.card');
                    const b = c.querySelector('.card-body');
                    const isHidden = b.classList.contains('hidden');
                    
                    document.querySelectorAll('.card-body').forEach(x => x.classList.add('hidden'));
                    
                    if(isHidden) {
                        b.classList.remove('hidden');
                        // Render Lazy Modules
                        const sym = c.dataset.symbol;
                        
                        // 1. Chart
                        const chartC = c.querySelector('.chart-container');
                        chartC.innerHTML = '';
                        const chart = LightweightCharts.createChart(chartC, { layout:{background:{color:'#000000'},textColor:'#6b7280'}, grid:{vertLines:{visible:false},horzLines:{color:'#1f2937'}} });
                        const series = chart.addCandlestickSeries();
                        series.setData(App.State.ohlcData[sym]["1w"]);
                        chart.timeScale().fitContent();
                        
                        // 2. OGC
                        const fund = App.State.fundamentalsData[sym];
                        const ogc = App.State.scoreData[sym].ogc;
                        c.querySelector('.ogc-dilution').innerText = fund.inflation.toFixed(1) + '%';
                        c.querySelector('.ogc-dev').innerText = ogc.dev;
                        c.querySelector('.ogc-net').innerText = ogc.net;
                        c.querySelector('.ogc-total').innerText = `Score: ${ogc.score}/100`;
                        
                        // 3. Backtest
                        const bt = App.Backtest.run(sym);
                        c.querySelector('.bt-entries').innerText = bt.entries;
                        c.querySelector('.bt-avg').innerText = bt.avg;
                        c.querySelector('.bt-avg').className = `bt-avg font-bold ${parseFloat(bt.avg)>0?'text-green-400':'text-red-400'}`;
                        c.querySelector('.bt-win').innerText = bt.win;
                        
                        // 4. AI Insight (Typewriter effect)
                        const ai = App.AI.analyze(sym);
                        const aiEl = c.querySelector('.ai-text');
                        aiEl.innerHTML = '';
                        let i = 0;
                        const type = () => {
                            if(i < ai.text.length) {
                                aiEl.innerHTML += ai.text.charAt(i);
                                i++;
                                setTimeout(type, 10);
                            }
                        };
                        type();
                    }
                }
            },
            
            // Placeholders
            Settings: { openModal:()=>{}, closeModal:()=>{}, save:()=>{} },
            Export: { openModal:()=>{}, closeModal:()=>{}, gen:()=>{} }
        };

        document.addEventListener('DOMContentLoaded', App.Core.init);
    </script>
</body>
</html>
